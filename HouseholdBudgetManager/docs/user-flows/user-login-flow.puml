@startuml User Login Flow
title User Login Flow

actor User
participant "Login Page" as LoginUI
participant "Auth Service\n(Angular)" as AuthService
participant "API Controller\n/api/auth/login" as AuthAPI
participant "Login Command\nHandler" as Handler
participant "IHouseholdBudgetManagerContext" as DbContext
participant "JWT Token\nService" as JWTService
database "SQL Server" as DB

User -> LoginUI: Enter username & password
activate LoginUI

LoginUI -> LoginUI: Validate form inputs
LoginUI -> AuthService: login(username, password)
activate AuthService

AuthService -> AuthAPI: POST /api/auth/login\n{username, password}
activate AuthAPI

AuthAPI -> Handler: Handle(LoginCommand)
activate Handler

Handler -> DbContext: Users.FirstOrDefault(u => u.UserName == username)
activate DbContext
DbContext -> DB: SELECT * FROM Users WHERE UserName = ?
activate DB
DB --> DbContext: User record
deactivate DB
DbContext --> Handler: User entity
deactivate DbContext

Handler -> Handler: Validate password hash\nusing PBKDF2 with stored salt

alt Valid credentials
    Handler -> JWTService: GenerateToken(user)
    activate JWTService
    JWTService -> JWTService: Create JWT with claims:\n- sub (userId)\n- name (username)\n- email\n- roles
    JWTService --> Handler: JWT token
    deactivate JWTService

    Handler --> AuthAPI: LoginResponseDto\n{token, expiresAt, user}
    deactivate Handler
    AuthAPI --> AuthService: 200 OK\n{token, expiresAt, user}
    deactivate AuthAPI

    AuthService -> AuthService: Store token in localStorage
    AuthService --> LoginUI: Success
    deactivate AuthService

    LoginUI -> LoginUI: Redirect to dashboard
    LoginUI --> User: Navigate to /budget/dashboard
    deactivate LoginUI
else Invalid credentials
    Handler --> AuthAPI: Unauthorized
    AuthAPI --> AuthService: 401 Unauthorized\n{error: "Invalid username or password"}
    AuthService --> LoginUI: Error message
    LoginUI --> User: Display error message
end

@enduml
