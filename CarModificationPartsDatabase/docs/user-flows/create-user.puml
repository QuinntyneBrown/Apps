@startuml create-user
title Create User Flow

actor Admin
participant "User Management\nPage" as UI
participant "User Service\n(Angular)" as UserService
participant "Users Controller\n(/api/users)" as UsersController
participant "Create User\nCommand Handler" as CommandHandler
participant "Password Service" as PasswordService
participant "ITenantContext" as TenantContext
database "CarModificationPartsDatabase\nContext" as DB

Admin -> UI: Click "Create User" button
UI -> UI: Open create user form/modal

Admin -> UI: Enter user details\n(username, email, password)
Admin -> UI: Click Save button

UI -> UI: Validate form inputs\n(required fields, email format,\npassword strength)

alt Form invalid
    UI -> Admin: Display validation errors
else Form valid
    UI -> UserService: createUser(username, email, password)
    UserService -> UsersController: POST /api/users\n{username, email, password}

    UsersController -> CommandHandler: Handle CreateUserCommand

    CommandHandler -> DB: Check username uniqueness
    DB --> CommandHandler: Username exists result

    alt Username already exists
        CommandHandler --> UsersController: 400 Bad Request\n{"error": "Username already exists"}
        UsersController --> UserService: User creation failed
        UserService --> UI: Show error message
        UI -> Admin: Display "Username already exists"
    else Username available
        CommandHandler -> DB: Check email uniqueness
        DB --> CommandHandler: Email exists result

        alt Email already exists
            CommandHandler --> UsersController: 400 Bad Request\n{"error": "Email already exists"}
            UsersController --> UserService: User creation failed
            UserService --> UI: Show error message
            UI -> Admin: Display "Email already exists"
        else Email available
            CommandHandler -> PasswordService: Hash password with salt
            PasswordService -> PasswordService: Generate unique 32-byte salt
            PasswordService -> PasswordService: Hash with PBKDF2-SHA256\n(100,000 iterations)
            PasswordService --> CommandHandler: Return hashed password & salt

            CommandHandler -> TenantContext: Get current TenantId
            TenantContext --> CommandHandler: Return TenantId

            CommandHandler -> CommandHandler: Create User entity\n(userId=Guid, username,\nemail, hashedPassword,\nsalt, tenantId)

            CommandHandler -> DB: SaveChanges()\nInsert User entity
            DB --> CommandHandler: User created successfully

            CommandHandler -> CommandHandler: Map User to DTO
            CommandHandler --> UsersController: 201 Created\n{userId, username, email, roles}

            UsersController --> UserService: User created successfully\nwith user DTO
            UserService --> UI: User creation successful
            UI -> UI: Close form/modal
            UI -> UI: Refresh user list
            UI -> Admin: Display success message\n"User created successfully"
        end
    end
end

@enduml
