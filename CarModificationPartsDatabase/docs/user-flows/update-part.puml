@startuml update-part
title Update Part Flow

actor User
participant "Parts Dashboard/\nPart Detail Page" as UI
participant "Part Form\nComponent" as FormUI
participant "Part Service\n(Angular)" as PartService
participant "Parts Controller\n(/api/parts)" as PartsController
participant "Get Part\nQuery Handler" as GetQueryHandler
participant "Update Part\nCommand Handler" as UpdateCommandHandler
database "CarModificationPartsDatabase\nContext" as DB

User -> UI: Click Edit button on part
UI -> PartService: getPart(partId)
PartService -> PartsController: GET /api/parts/{partId}

PartsController -> GetQueryHandler: Handle GetPartQuery(partId)

GetQueryHandler -> DB: Query Part by partId\nWHERE TenantId = currentTenantId
DB --> GetQueryHandler: Return Part entity

alt Part not found
    GetQueryHandler --> PartsController: 404 Not Found
    PartsController --> PartService: Part not found
    PartService --> UI: Error response
    UI -> User: Display "Part not found" error
else Part found
    GetQueryHandler -> GetQueryHandler: Map Part to DTO
    GetQueryHandler --> PartsController: 200 OK\n{partId, name, description,\ncategory, price, imageUrls, etc.}

    PartsController --> PartService: Part data received
    PartService --> FormUI: Part data loaded
    FormUI -> FormUI: Open edit form/modal
    FormUI -> FormUI: Populate form with current values

    User -> FormUI: Update part details\n(name, description, price, etc.)

    alt Adding new files
        User -> FormUI: Select new file(s) to upload
        FormUI -> FormUI: Validate file type and size
    end

    alt Removing existing files
        User -> FormUI: Click remove on existing file
        FormUI -> FormUI: Mark file for deletion
    end

    User -> FormUI: Click Save button

    FormUI -> FormUI: Validate form inputs\n(required fields, data types,\nfield constraints)

    alt Form invalid
        FormUI -> User: Display validation errors\n(highlight invalid fields)
    else Form valid
        FormUI -> PartService: updatePart(partId, updatedData, newFiles?, filesToDelete?)

        alt Files included
            PartService -> PartService: Prepare multipart/form-data\nwith updated data and files
            PartService -> PartsController: PUT /api/parts/{partId}\nContent-Type: multipart/form-data
        else No files
            PartService -> PartsController: PUT /api/parts/{partId}\nContent-Type: application/json\n{updatedData}
        end

        PartsController -> UpdateCommandHandler: Handle UpdatePartCommand

        UpdateCommandHandler -> DB: Query Part by partId\nWHERE TenantId = currentTenantId
        DB --> UpdateCommandHandler: Return Part entity

        alt Part not found
            UpdateCommandHandler --> PartsController: 404 Not Found
            PartsController --> PartService: Part update failed
            PartService --> FormUI: Show error message
            FormUI -> User: Display "Part not found"
        else Part exists
            UpdateCommandHandler -> UpdateCommandHandler: Update Part entity properties\n(name, description, price, etc.)

            alt New files included
                UpdateCommandHandler -> UpdateCommandHandler: Process uploaded files\n(save to storage, generate URLs)
                UpdateCommandHandler -> UpdateCommandHandler: Add new file references to Part
            end

            alt Files marked for deletion
                UpdateCommandHandler -> UpdateCommandHandler: Remove file references
                UpdateCommandHandler -> UpdateCommandHandler: Delete files from storage
            end

            UpdateCommandHandler -> DB: SaveChanges()\nUpdate Part entity
            DB --> UpdateCommandHandler: Part updated successfully

            UpdateCommandHandler -> UpdateCommandHandler: Map Part to DTO
            UpdateCommandHandler --> PartsController: 200 OK\n{partId, updated data, imageUrls, etc.}

            PartsController --> PartService: Part updated successfully\nwith updated DTO
            PartService --> FormUI: Part update successful
            FormUI -> FormUI: Close form/modal
            FormUI -> UI: Notify parent component
            UI -> UI: Refresh part data/list
            UI -> User: Display success message\n"Part updated successfully"
        end
    end
end

@enduml
