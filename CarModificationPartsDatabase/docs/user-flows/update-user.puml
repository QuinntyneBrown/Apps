@startuml update-user
title Update User Flow

actor Admin
participant "User Management\nPage" as UI
participant "User Service\n(Angular)" as UserService
participant "Users Controller\n(/api/users)" as UsersController
participant "Update User\nCommand Handler" as CommandHandler
participant "Password Service" as PasswordService
database "CarModificationPartsDatabase\nContext" as DB

Admin -> UI: Click Edit button on user row
UI -> UserService: getUser(userId)
UserService -> UsersController: GET /api/users/{userId}

UsersController -> DB: Query User by userId\nwith TenantId filter
DB --> UsersController: Return User entity

alt User not found
    UsersController --> UserService: 404 Not Found
    UserService --> UI: User not found
    UI -> Admin: Display error message
else User found
    UsersController -> UsersController: Map User to DTO (exclude password)
    UsersController --> UserService: 200 OK\n{userId, username, email, roles}
    UserService --> UI: User data received
    UI -> UI: Open edit user form/modal
    UI -> UI: Populate form with current values

    Admin -> UI: Update user details\n(email, password, etc.)
    Admin -> UI: Click Save button

    UI -> UI: Validate form inputs\n(email format, password strength if changed)

    alt Form invalid
        UI -> Admin: Display validation errors
    else Form valid
        UI -> UserService: updateUser(userId, updatedData)
        UserService -> UsersController: PUT /api/users/{userId}\n{email, password?, ...}

        UsersController -> CommandHandler: Handle UpdateUserCommand

        CommandHandler -> DB: Query User by userId\nwith TenantId filter
        DB --> CommandHandler: Return User entity

        alt User not found
            CommandHandler --> UsersController: 404 Not Found
            UsersController --> UserService: User update failed
            UserService --> UI: Show error message
            UI -> Admin: Display "User not found"
        else User exists
            alt Email changed
                CommandHandler -> DB: Check email uniqueness\n(exclude current user)
                DB --> CommandHandler: Email exists result

                alt Email already in use
                    CommandHandler --> UsersController: 400 Bad Request\n{"error": "Email already exists"}
                    UsersController --> UserService: User update failed
                    UserService --> UI: Show error message
                    UI -> Admin: Display "Email already exists"
                end
            end

            alt Password changed
                CommandHandler -> PasswordService: Hash new password with salt
                PasswordService -> PasswordService: Generate new unique 32-byte salt
                PasswordService -> PasswordService: Hash with PBKDF2-SHA256\n(100,000 iterations)
                PasswordService --> CommandHandler: Return hashed password & new salt
                CommandHandler -> CommandHandler: Update password and salt
            end

            CommandHandler -> CommandHandler: Update User entity properties
            CommandHandler -> DB: SaveChanges()\nUpdate User entity
            DB --> CommandHandler: User updated successfully

            CommandHandler -> CommandHandler: Map User to DTO
            CommandHandler --> UsersController: 200 OK\n{userId, username, email, roles}

            UsersController --> UserService: User updated successfully\nwith updated DTO
            UserService --> UI: User update successful
            UI -> UI: Close form/modal
            UI -> UI: Refresh user list
            UI -> Admin: Display success message\n"User updated successfully"
        end
    end
end

@enduml
