@startuml
title Activity Confirmation Flow
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

actor User
participant "Emergency Dashboard" as UI
participant "Confirm Button" as Button
participant "Activity Service" as Service
participant "API Gateway" as API
participant "Activity Controller" as Controller
participant "Activity Repository" as Repository
participant "Notification Service" as NotifyService
database "Database" as DB

== User Visits Dashboard ==
User -> UI: Navigate to /emergency
activate UI

UI -> Service: getEmergencyStatus()
activate Service
Service -> API: GET /api/emergency/status
API -> Controller: GetStatus(userId)
activate Controller
Controller -> Repository: GetEmergencyConfig(userId)
activate Repository
Repository -> DB: SELECT * FROM EmergencyConfig\nWHERE UserId = ?
activate DB
DB --> Repository: Config with last activity
deactivate DB
Repository --> Controller: Emergency status
deactivate Repository

Controller -> Controller: Calculate days since last activity
Controller -> Controller: Calculate next check date
Controller -> Controller: Determine status:\n- Active (safe)\n- Warning (approaching threshold)\n- Critical (near trigger)

Controller --> API: Status data
deactivate Controller
API --> Service: Emergency status
Service --> UI: Status response
deactivate Service

UI -> UI: Display status card:\n- Last activity timestamp\n- Days since last activity\n- Next check countdown\n- Status indicator (color-coded)

alt Status is Warning
    UI -> UI: Show warning banner:\n"Activity confirmation needed soon"
end

alt Status is Critical
    UI -> UI: Show critical alert:\n"Confirm activity within 1 day!"
end

UI --> User: Display dashboard with\nprominent "I'm Still Here" button
deactivate UI

== User Confirms Activity ==
User -> Button: Click "I'm Still Here" button
activate Button

Button -> Button: Show loading animation
Button -> Service: confirmActivity()
activate Service

Service -> API: POST /api/emergency/confirm-activity
activate API
API -> API: Validate JWT token

API -> Controller: ConfirmActivity(userId)
activate Controller

Controller -> Repository: BeginTransaction()
activate Repository

Repository -> DB: UPDATE EmergencyConfig\nSET LastActivityDate = NOW(),\nActivityStreak = ActivityStreak + 1\nWHERE UserId = ?
activate DB
DB --> Repository: Config updated
deactivate DB

Repository -> DB: INSERT INTO ActivityLog\nVALUES (userId, 'ActivityConfirmed', timestamp)
activate DB
DB --> Repository: Activity logged
deactivate DB

Repository -> Repository: CommitTransaction()
Repository --> Controller: Updated config
deactivate Repository

Controller -> Controller: Calculate new next check date:\nLast Activity + Inactivity Threshold

Controller -> Controller: Reset warning notifications

Controller -> Controller: Update activity streak

Controller --> API: 200 OK\n{lastActivity, nextCheck, streak}
deactivate Controller

API --> Service: Confirmation success
deactivate API

Service -> Service: Update local state
Service --> Button: Activity confirmed
deactivate Service

Button -> Button: Show success animation:\n"Thank you!" with checkmark
Button -> Button: Confetti effect (gamification)
deactivate Button

Button -> UI: Refresh dashboard
activate UI

UI -> UI: Update status card:\n- Reset countdown\n- Show new next check date\n- Update streak counter

UI -> UI: Show success toast:\n"Activity confirmed! See you in {days} days"

UI -> UI: Display achievement badge\nif milestone reached:\n- 30 day streak\n- 90 day streak\n- 365 day streak

UI --> User: Display updated dashboard\nwith Active status
deactivate UI

== Optional: Email Confirmation ==
Service -> NotifyService: sendConfirmationEmail()
activate NotifyService
NotifyService -> API: POST /api/notifications/activity-confirmed
API --> NotifyService: Email queued
NotifyService -> User: Email: "Activity confirmed,\nnext check on {date}"
deactivate NotifyService

@enduml
