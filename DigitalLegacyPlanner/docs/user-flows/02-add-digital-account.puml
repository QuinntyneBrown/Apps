@startuml
title Add Digital Account Flow
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

actor User
participant "Accounts Page" as UI
participant "Add Account Modal" as Modal
participant "Service Autocomplete" as Autocomplete
participant "Account Service" as AccountService
participant "API Gateway" as API
participant "Accounts Controller" as Controller
participant "Account Repository" as Repository
database "Database" as DB

User -> UI: Navigate to /accounts
activate UI
UI --> User: Display accounts dashboard
User -> UI: Click "Add Account" button

UI -> Modal: Open AddAccountModal
activate Modal
Modal --> User: Display account form

User -> Modal: Start typing service name
Modal -> Autocomplete: Search services
activate Autocomplete
Autocomplete -> API: GET /api/services/search?q={query}
API --> Autocomplete: Service suggestions
Autocomplete --> Modal: Display autocomplete results
deactivate Autocomplete

User -> Modal: Select service from suggestions
Modal -> Modal: Populate service logo & type

User -> Modal: Fill form:\n- Account Type\n- Importance Level\n- Username/Email\n- Notes

User -> Modal: Click "Save"
Modal -> Modal: Validate form:\n- Required fields\n- Duplicate detection\n- Character limits

alt Validation Successful
    Modal -> AccountService: createAccount(accountData)
    activate AccountService

    AccountService -> API: POST /api/accounts\n{serviceData}
    activate API
    API -> API: Validate JWT token

    API -> Controller: CreateAccount(command)
    activate Controller

    Controller -> Repository: AddAsync(account)
    activate Repository
    Repository -> DB: INSERT INTO Accounts\nVALUES (...)
    activate DB
    DB --> Repository: Account created (ID)
    deactivate DB
    Repository --> Controller: Account entity
    deactivate Repository

    Controller --> API: 201 Created\n{accountId, account}
    deactivate Controller

    API --> AccountService: Account created
    deactivate API

    AccountService -> AccountService: Update local state
    AccountService --> Modal: Success
    deactivate AccountService

    Modal -> Modal: Close modal
    Modal -> UI: Refresh accounts list
    deactivate Modal

    UI -> UI: Show success toast:\n"Account added successfully"
    UI -> UI: Display new account card
    UI --> User: Show completion options:\n- Add Access Details\n- Add Categorization\n- View Account

else Validation Failed
    Modal -> Modal: Display validation errors
    Modal --> User: Show error messages
end

deactivate UI

@enduml
