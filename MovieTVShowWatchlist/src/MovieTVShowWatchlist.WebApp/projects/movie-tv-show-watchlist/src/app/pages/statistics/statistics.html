<ng-container *ngIf="viewModel$ | async as vm">
  <div class="statistics">
    <header class="statistics__header">
      <h1 class="statistics__title">Your Viewing Statistics</h1>
      <mat-form-field appearance="outline" class="statistics__period">
        <mat-select [value]="vm.period" (selectionChange)="onPeriodChange($event.value)">
          @for (option of periodOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </header>

    @if (vm.stats) {
      <div class="statistics__grid">
        <app-stat-card
          icon="ðŸŽ¬"
          [value]="vm.stats.moviesWatched"
          label="Movies Watched"
          [change]="'+' + vm.stats.moviesChange + ' vs last year'"
        ></app-stat-card>

        <app-stat-card
          icon="ðŸ“º"
          [value]="vm.stats.showsWatched"
          label="Shows Watched"
          [change]="'+' + vm.stats.showsChange + ' vs last year'"
        ></app-stat-card>

        <app-stat-card
          icon="â±ï¸"
          [value]="vm.stats.hoursWatched"
          label="Hours Watched"
          [change]="'+' + vm.stats.hoursChange + ' vs last year'"
        ></app-stat-card>

        <app-stat-card
          icon="â­"
          [value]="vm.stats.averageRating"
          label="Avg Rating"
          change="â˜…â˜…â˜…â˜…â˜†"
        ></app-stat-card>

        <app-stat-card
          icon="ðŸ”¥"
          [value]="vm.stats.currentStreak"
          label="Current Streak"
          [change]="'Longest: ' + vm.stats.longestStreak + ' days'"
        ></app-stat-card>

        <app-stat-card
          icon="ðŸ†"
          [value]="vm.stats.milestones"
          label="Milestones"
          [change]="'Next: ' + vm.stats.nextMilestone"
        ></app-stat-card>
      </div>

      <div class="statistics__charts">
        <mat-card class="statistics__chart-card statistics__chart-card--bar">
          <mat-card-header>
            <mat-card-title>Viewing Over Time</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="statistics__bar-chart">
              @for (data of vm.stats.monthlyData; track data.month) {
                <div class="statistics__bar-container">
                  <div
                    class="statistics__bar"
                    [style.height]="getBarHeight(data.count, getMaxCount(vm.stats.monthlyData))"
                  ></div>
                  <span class="statistics__bar-label">{{ data.month }}</span>
                </div>
              }
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="statistics__chart-card statistics__chart-card--genre">
          <mat-card-header>
            <mat-card-title>Genre Breakdown</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            @for (genre of vm.stats.genreBreakdown; track genre.genre) {
              <div class="statistics__genre-item">
                <div class="statistics__genre-header">
                  <span class="statistics__genre-name">{{ genre.genre }}</span>
                  <strong class="statistics__genre-percent">{{ genre.percentage }}%</strong>
                </div>
                <div class="statistics__genre-bar-container">
                  <div
                    class="statistics__genre-bar"
                    [style.width.%]="genre.percentage"
                  >
                    <span class="statistics__genre-bar-percent">{{ genre.percentage }}%</span>
                  </div>
                </div>
              </div>
            }
          </mat-card-content>
        </mat-card>
      </div>
    }
  </div>
</ng-container>
