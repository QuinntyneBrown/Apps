@startuml relocate-item
title Relocate Item Flow

actor User
participant "Item Details Page" as DetailsPage
participant "Location Selector\nModal" as Modal
participant "Item Service" as ItemService
participant "API Controller\n(/api/items)" as API
participant "RelocateItem Handler" as Handler
database "Items Table" as ItemsDB
database "Locations Table" as LocationsDB

User -> DetailsPage: View item details
DetailsPage --> User: Display item with\ncurrent location

User -> DetailsPage: Click "Change Location"\nquick action
DetailsPage -> Modal: Show location selector modal

activate Modal
Modal -> ItemService: getLocations()
ItemService -> API: GET /api/locations\nAuthorization: Bearer {token}
API -> LocationsDB: Query locations by TenantId
LocationsDB --> API: Location list
API --> ItemService: Locations
ItemService --> Modal: Available locations

Modal --> User: Display location options:\n- Organized by room/area\n- Visual icons\n- Item count per location\n- Current location highlighted

User -> Modal: Select new location
User -> Modal: Optionally enter reason\nfor move
User -> Modal: Click "Confirm"

Modal -> Modal: Validate selection\n(new location required)

alt Validation passes and location changed
    Modal -> ItemService: relocateItem(itemId, newLocationId, reason)
    ItemService -> API: POST /api/items/{itemId}/relocate\nAuthorization: Bearer {token}\n{locationId, reason}

    API -> Handler: Handle RelocateItemCommand
    Handler -> ItemsDB: Query item by ItemId and TenantId
    ItemsDB --> Handler: Current item data

    alt Item exists and user owns it
        Handler -> Handler: Store previous location:\n- PreviousLocationId\n- PreviousLocationName

        Handler -> LocationsDB: Query new location details
        LocationsDB --> Handler: New location info

        Handler -> Handler: Update item:\n- LocationId = newLocationId\n- UpdatedAt = now()

        Handler -> ItemsDB: UPDATE Item location
        ItemsDB --> Handler: Item updated

        Handler -> Handler: Raise ItemRelocated event:\n- ItemId, UserId, ItemName\n- PreviousLocationId, PreviousLocationName\n- NewLocationId, NewLocationName\n- RelocationDate, ReasonForMove

        Handler --> API: Updated ItemDto
        API --> ItemService: 200 OK\n{updatedItem}
        ItemService --> Modal: Success

        Modal -> Modal: Close modal
        Modal -> DetailsPage: Refresh item details
        DetailsPage --> User: Show success notification:\n"Item relocated to [Location]"
        DetailsPage --> User: Display updated location

    else Item not found or unauthorized
        Handler --> API: 404 Not Found\nor 403 Forbidden
        API --> ItemService: Error
        ItemService --> Modal: Relocation failed
        Modal --> User: Show error message
    end

else Validation fails or same location
    Modal --> User: Show validation error
end

deactivate Modal

@enduml
