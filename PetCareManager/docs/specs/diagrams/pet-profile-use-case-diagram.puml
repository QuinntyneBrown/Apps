@startuml Pet Profile - Use Case Diagram

!define ACTOR_COLOR #4CAF50
!define USECASE_COLOR #2196F3
!define SYSTEM_COLOR #F5F5F5

skinparam actor {
    BackgroundColor ACTOR_COLOR
    BorderColor #2E7D32
}

skinparam usecase {
    BackgroundColor USECASE_COLOR
    BorderColor #1565C0
    FontColor #FFFFFF
}

skinparam rectangle {
    BackgroundColor SYSTEM_COLOR
    BorderColor #9E9E9E
    BorderThickness 2
}

left to right direction

' Actors
actor "Pet Owner" as owner <<Primary>>
actor "Household Member" as member <<Primary>>
actor "System" as system <<System>>
actor "Notification Service" as notification <<External>>
actor "Analytics Service" as analytics <<External>>

' System Boundary
rectangle "Pet Profile Management" {

    ' Core Use Cases
    usecase "Register New Pet" as UC1
    usecase "View Pet Profile" as UC2
    usecase "Update Pet Information" as UC3
    usecase "Delete Pet" as UC4
    usecase "Upload Pet Photo" as UC5

    ' Weight Management
    usecase "Record Weight" as UC6
    usecase "View Weight History" as UC7
    usecase "View Weight Trends" as UC8

    ' Search & Filter
    usecase "Search Pets" as UC9
    usecase "Filter Pets by Species" as UC10
    usecase "Toggle Deceased Pets" as UC11

    ' Lifecycle Management
    usecase "Mark Pet as Deceased" as UC12
    usecase "View Pet Timeline" as UC13

    ' Supporting Use Cases (Internal)
    usecase "Validate Microchip" as UC14
    usecase "Calculate Pet Age" as UC15
    usecase "Detect Weight Anomalies" as UC16
    usecase "Publish Domain Event" as UC17
    usecase "Process Event Handlers" as UC18
}

' External Systems
rectangle "External Services" {
    usecase "Send Notifications" as EXT1
    usecase "Generate Analytics" as EXT2
    usecase "Store Photos" as EXT3
    usecase "Update Search Index" as EXT4
}

' Primary Actor Relationships - Pet Owner (Full Privileges)
owner --> UC1 : initiates
owner --> UC2 : views
owner --> UC3 : updates
owner --> UC4 : deletes
owner --> UC5 : uploads
owner --> UC6 : records
owner --> UC7 : views
owner --> UC8 : analyzes
owner --> UC9 : searches
owner --> UC10 : filters
owner --> UC11 : toggles
owner --> UC12 : marks
owner --> UC13 : views

' Primary Actor Relationships - Household Member (Limited Privileges)
member --> UC2 : views
member --> UC3 : updates
member --> UC5 : uploads
member --> UC6 : records
member --> UC7 : views
member --> UC8 : analyzes
member --> UC9 : searches
member --> UC10 : filters
member --> UC11 : toggles
member --> UC13 : views

' Include Relationships (Required Sub-processes)
UC1 ..> UC14 : <<include>>
UC1 ..> UC17 : <<include>>
UC2 ..> UC15 : <<include>>
UC3 ..> UC14 : <<include>>
UC3 ..> UC17 : <<include>>
UC6 ..> UC16 : <<include>>
UC6 ..> UC17 : <<include>>
UC12 ..> UC17 : <<include>>

' Extend Relationships (Optional Extensions)
UC5 ..> UC3 : <<extend>>
UC16 ..> EXT1 : <<extend>>\nif anomaly detected

' System Relationships
UC17 --> system : triggers
system --> UC18 : executes

' Event Handler to External Service Relationships
UC18 ..> EXT1 : invokes
UC18 ..> EXT2 : invokes
UC18 ..> EXT4 : invokes
UC5 ..> EXT3 : invokes

' External Service Actor Relationships
notification --> EXT1
analytics --> EXT2

' Notes for Use Cases
note right of UC1
    **Trigger:** Pet Owner clicks "Add Pet"

    **Preconditions:**
    • User belongs to a household
    • User is authenticated

    **Main Flow:**
    1. Enter pet basic information
    2. Validate microchip uniqueness
    3. Upload optional photo
    4. Submit registration
    5. Publish PetRegistered event

    **Postconditions:**
    • New pet created in database
    • Welcome notification sent
    • Pet appears in household list

    **Business Rules:**
    • Name is required (max 100 chars)
    • Microchip must be unique
    • DateOfBirth cannot be future
end note

note bottom of UC6
    **Trigger:** User clicks "Record Weight"

    **Preconditions:**
    • Pet exists and not deceased
    • User has permission

    **Main Flow:**
    1. Enter weight value (kg)
    2. Optionally add notes
    3. Validate weight > 0
    4. Calculate change from previous
    5. Check for anomalies (>20% change)
    6. Save weight record
    7. Publish PetWeightRecorded event
    8. Update pet's current weight

    **Postconditions:**
    • Weight record saved
    • Current weight updated
    • Alert sent if anomalous

    **Extensions:**
    • If change > 20%: Trigger alert
    • If no previous weight: Skip comparison
end note

note bottom of UC12
    **Trigger:** Owner clicks "Mark as Deceased"

    **Preconditions:**
    • Pet exists and not already deceased
    • User is household owner

    **Main Flow:**
    1. Confirm action with dialog
    2. Enter date of death
    3. Validate date (not before birth)
    4. Set IsDeceased = true
    5. Publish PetPassedAway event
    6. Archive active reminders
    7. Send condolence notification

    **Postconditions:**
    • Pet marked as deceased
    • Future appointments archived
    • Condolence sent to household
    • Pet removed from active list

    **Business Rules:**
    • Cannot resurrect deceased pet
    • DateOfDeath must be >= DateOfBirth
    • DateOfDeath cannot be future
end note

note top of UC17
    **Domain Events Published:**

    • PetRegistered
      ├─ Send welcome notification
      ├─ Create health record template
      ├─ Initialize vaccination schedule
      └─ Update household statistics

    • PetProfileUpdated
      ├─ Notify household members
      ├─ Log audit trail
      ├─ Update search index
      └─ Recalculate age if DOB changed

    • PetWeightRecorded
      ├─ Update current weight
      ├─ Check thresholds
      ├─ Send alerts if abnormal
      └─ Update analytics

    • PetPassedAway
      ├─ Send condolence
      ├─ Archive reminders
      ├─ Update statistics
      └─ Generate memorial
end note

note left of UC4
    **Authorization Required:**
    Only household owner can delete pets.

    **Soft Delete:**
    Pets are not physically deleted,
    only marked as inactive.

    **Restrictions:**
    Cannot delete if:
    • Has active appointments
    • Has pending tasks
end note

note right of UC14
    **Validation Rules:**

    • Format: 15 characters max
    • Must be globally unique
    • Cannot change after registration
    • Optional field

    **Database Check:**
    Query all pets to ensure
    microchip number is unique
    across entire system.
end note

note bottom of UC16
    **Anomaly Detection:**

    • Compare with previous weight
    • Calculate percentage change
    • Flag if change > 20%
    • Consider time between measurements

    **Actions on Anomaly:**
    • Display warning to user
    • Send alert notification
    • Suggest veterinary consultation
    • Log for review
end note

' Legend
legend right
    |= Symbol |= Meaning |
    | <<include>> | Required sub-process |
    | <<extend>> | Optional extension |
    | → | User initiates |
    | ⋯> | System invokes |

    |= Actor Type |
    | <<Primary>> | End user |
    | <<System>> | Internal system |
    | <<External>> | External service |
endlegend

@enduml
