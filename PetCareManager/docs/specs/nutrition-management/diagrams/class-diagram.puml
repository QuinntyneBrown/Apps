@startuml Nutrition Management - Class Diagram

!define ENTITY_COLOR #E1F5FF
!define VALUE_OBJECT_COLOR #FFF9E1
!define AGGREGATE_COLOR #E8F5E9
!define SERVICE_COLOR #F3E5F5

' Aggregates and Entities
package "Nutrition Aggregate" <<Rectangle>> AGGREGATE_COLOR {

    class NutritionPlan <<Entity>> ENTITY_COLOR {
        - Guid id
        - Guid petId
        - FeedingSchedule schedule
        - FoodBrand currentFoodBrand
        - TreatAllowance treatAllowance
        - decimal dailyCalorieTarget
        - DateTime createdAt
        - DateTime? lastModifiedAt
        - bool isActive
        --
        + SetFeedingSchedule(data) : void
        + RecordFeeding(data) : FeedingRecord
        + ChangeFoodBrand(newBrand, transitionPlan) : void
        + RecordTreat(data) : TreatRecord
        + ReportDietaryIssue(data) : DietaryIssue
        + CalculateNutritionStatistics(period) : NutritionStats
        + CheckTreatAllowance() : bool
        - ValidateFeedingSchedule() : void
        - UpdateDailyNutrition() : void
    }

    class FeedingSchedule <<Entity>> ENTITY_COLOR {
        - Guid id
        - Guid nutritionPlanId
        - List<FeedingTime> feedingTimes
        - decimal dailyTotalPortion
        - string scheduleType
        - string specialInstructions
        - bool veterinarianRecommended
        - DateTime createdAt
        --
        + AddFeedingTime(time) : void
        + RemoveFeedingTime(timeId) : void
        + GetUpcomingFeedings(count) : List<FeedingTime>
        + GetFeedingsByDate(date) : List<FeedingTime>
        + UpdatePortion(timeId, portion) : void
        + ValidateSchedule() : bool
        - CalculateTotalPortion() : decimal
    }

    class FeedingHistory <<Entity>> ENTITY_COLOR {
        - Guid id
        - Guid petId
        - List<FeedingRecord> records
        --
        + AddRecord(record) : void
        + GetRecords(startDate, endDate) : List<FeedingRecord>
        + CalculateCompliance(period) : decimal
        + GetMissedFeedings(period) : List<FeedingRecord>
        + GetLastFeeding() : FeedingRecord
    }

    class TreatHistory <<Entity>> ENTITY_COLOR {
        - Guid id
        - Guid petId
        - List<TreatRecord> treats
        --
        + AddTreat(treat) : void
        + GetTreats(date) : List<TreatRecord>
        + GetTotalCaloriesToday() : decimal
        + GetTreatCount(date) : int
        + CalculateAverageTreatsPerDay(period) : decimal
    }

    class FoodBrandHistory <<Entity>> ENTITY_COLOR {
        - Guid id
        - Guid petId
        - List<FoodBrandChange> changes
        - FoodBrand currentBrand
        --
        + AddFoodChange(change) : void
        + GetCurrentBrand() : FoodBrand
        + GetBrandHistory() : List<FoodBrandChange>
        + GetDaysOnCurrentBrand() : int
        + IsInTransition() : bool
    }

    class DietaryIssueHistory <<Entity>> ENTITY_COLOR {
        - Guid id
        - Guid petId
        - List<DietaryIssue> issues
        --
        + ReportIssue(issue) : void
        + UpdateIssue(issueId, data) : void
        + GetActiveIssues() : List<DietaryIssue>
        + GetResolvedIssues() : List<DietaryIssue>
        + AnalyzePatterns() : IssuePattern
    }

    class FeedingRecord <<Entity>> ENTITY_COLOR {
        + Guid id
        + Guid petId
        + DateTime scheduledTime
        + DateTime? actualTime
        + decimal portionGiven
        + string portionUnit
        + string fedBy
        + string notes
        + decimal? foodLeftover
        + FeedingStatus status
        + DateTime createdAt
    }

    class TreatRecord <<Entity>> ENTITY_COLOR {
        + Guid id
        + Guid petId
        + DateTime givenAt
        + string treatType
        + string treatName
        + int quantity
        + decimal estimatedCalories
        + decimal totalCalories
        + string givenBy
        + string reason
        + DateTime createdAt
    }

    class FoodBrandChange <<Entity>> ENTITY_COLOR {
        + Guid id
        + Guid petId
        + DateTime changedDate
        + string previousFoodBrand
        + string newFoodBrand
        + string previousFoodType
        + string newFoodType
        + string reasonForChange
        + string reasonCategory
        + string transitionPlan
        + int transitionDurationDays
        + bool veterinarianApproved
        + DateTime createdAt
    }

    class DietaryIssue <<Entity>> ENTITY_COLOR {
        + Guid id
        + Guid petId
        + DateTime reportedDate
        + string issueCategory
        + string severity
        + List<string> symptoms
        + string suspectedTrigger
        + DateTime onsetDate
        + string duration
        + string foodBrandAtOnset
        + bool recentFoodChange
        + bool veterinarianNotified
        + string resolutionStatus
        + DateTime createdAt
    }
}

' Value Objects
package "Value Objects" <<Rectangle>> VALUE_OBJECT_COLOR {

    class FeedingTime <<Value Object>> VALUE_OBJECT_COLOR {
        + TimeSpan time
        + decimal portionSize
        + string portionUnit
        + string foodType
        --
        + ToString() : string
        + Equals(other) : bool
        + Validate() : bool
        + CalculateCalories(caloriesPerUnit) : decimal
    }

    class Portion <<Value Object>> VALUE_OBJECT_COLOR {
        + decimal amount
        + string unit
        + decimal calories
        --
        + ConvertTo(targetUnit) : Portion
        + Add(other) : Portion
        + Validate() : bool
    }

    class FoodBrand <<Value Object>> VALUE_OBJECT_COLOR {
        + string brandName
        + string foodType
        + decimal caloriesPerCup
        + List<string> ingredients
        + List<string> allergens
        --
        + ToString() : string
        + HasAllergen(allergen) : bool
        + CalculateCalories(portion) : decimal
    }

    class TreatAllowance <<Value Object>> VALUE_OBJECT_COLOR {
        + int maxTreatsPerDay
        + decimal maxCaloriesPerDay
        + int currentCount
        + decimal currentCalories
        + DateTime lastReset
        --
        + AddTreat(calories) : void
        + IsExceeded() : bool
        + RemainingTreats() : int
        + RemainingCalories() : decimal
        + ResetDaily() : void
    }

    class DailyNutrition <<Value Object>> VALUE_OBJECT_COLOR {
        + decimal totalCalories
        + decimal proteinGrams
        + decimal fatGrams
        + decimal carbsGrams
        + decimal fiberGrams
        + DateTime date
        --
        + AddMeal(portion, foodBrand) : void
        + AddTreat(calories) : void
        + GetCalorieBreakdown() : object
        + MeetsTarget(target) : bool
    }

    class TransitionSchedule <<Value Object>> VALUE_OBJECT_COLOR {
        + DateTime startDate
        + DateTime endDate
        + int totalDays
        + List<DailyRatio> dailyRatios
        --
        + GetRatioForDay(day) : DailyRatio
        + GetProgress() : decimal
        + IsComplete() : bool
        + GenerateSchedule() : List<DailyRatio>
    }

    class DailyRatio <<Value Object>> VALUE_OBJECT_COLOR {
        + int dayNumber
        + decimal oldFoodPercentage
        + decimal newFoodPercentage
        + DateTime date
        --
        + ToString() : string
        + CalculatePortions(totalPortion) : object
    }
}

' Enums
enum FeedingStatus {
    Pending
    Fed
    Missed
    Skipped
    PartiallyFed
}

enum FoodType {
    Dry
    Wet
    Raw
    Homemade
    Mixed
}

enum ScheduleType {
    Regular
    WeightManagement
    PuppyKitten
    Senior
    Medical
}

enum IssueSeverity {
    Mild
    Moderate
    Severe
    Critical
}

enum IssueCategory {
    AllergicReaction
    Vomiting
    Diarrhea
    Constipation
    LossOfAppetite
    WeightChange
    FoodRefusal
    Other
}

enum ResolutionStatus {
    Ongoing
    Resolved
    Monitoring
    VetVisitScheduled
}

enum ReasonCategory {
    VeterinaryRecommendation
    AllergicReaction
    PreferenceChange
    Availability
    Cost
    Other
}

' Domain Events
package "Domain Events" <<Rectangle>> #FFE0E0 {

    class FoodBrandChanged <<Domain Event>> {
        + Guid foodBrandChangeId
        + Guid petId
        + DateTime changedDate
        + string previousFoodBrand
        + string newFoodBrand
        + string previousFoodType
        + string newFoodType
        + string reasonForChange
        + ReasonCategory reasonCategory
        + string transitionPlan
        + int transitionDurationDays
        + bool veterinarianApproved
        + string notes
        + DateTime occurredAt
    }

    class FeedingScheduleSet <<Domain Event>> {
        + Guid feedingScheduleId
        + Guid petId
        + DateTime scheduleDate
        + List<FeedingTime> feedingTimes
        + decimal dailyTotalPortion
        + string foodBrand
        + decimal dailyCalorieTarget
        + ScheduleType scheduleType
        + Guid setBy
        + bool veterinarianRecommended
        + string specialInstructions
        + decimal treatAllowancePerDay
        + DateTime occurredAt
    }

    class TreatGiven <<Domain Event>> {
        + Guid treatRecordId
        + Guid petId
        + DateTime givenAt
        + string treatType
        + string treatName
        + int quantity
        + decimal estimatedCalories
        + decimal totalCalories
        + string givenBy
        + string reason
        + bool withinDailyAllowance
        + int dailyTreatCount
        + decimal dailyTreatCalories
        + DateTime occurredAt
    }

    class DietaryIssueReported <<Domain Event>> {
        + Guid issueId
        + Guid petId
        + DateTime reportedDate
        + IssueCategory issueCategory
        + IssueSeverity severity
        + List<string> symptoms
        + string suspectedTrigger
        + DateTime onsetDate
        + string duration
        + string foodBrandAtOnset
        + bool recentFoodChange
        + bool veterinarianNotified
        + ResolutionStatus resolutionStatus
        + DateTime occurredAt
    }

    class FeedingRecorded <<Domain Event>> {
        + Guid feedingRecordId
        + Guid petId
        + DateTime scheduledTime
        + DateTime actualTime
        + decimal portionGiven
        + string portionUnit
        + string fedBy
        + decimal? foodLeftover
        + DateTime occurredAt
    }
}

' Services
package "Domain Services" <<Rectangle>> SERVICE_COLOR {

    class FeedingScheduleService <<Service>> SERVICE_COLOR {
        + GenerateSchedule(nutritionPlan, startDate, endDate) : List<FeedingTime>
        + CalculateOptimalPortions(pet, targetCalories) : List<Portion>
        + ValidateSchedule(schedule) : bool
        + AdjustForTimezone(schedule, timezone) : List<FeedingTime>
    }

    class NutritionCalculationService <<Service>> SERVICE_COLOR {
        + CalculateDailyCalorieTarget(pet) : decimal
        + CalculatePortionCalories(portion, foodBrand) : decimal
        + CalculateDailyNutrition(feedings, treats) : DailyNutrition
        + ValidateNutritionBalance(dailyNutrition) : bool
    }

    class TreatAllowanceService <<Service>> SERVICE_COLOR {
        + CalculateTreatAllowance(pet, dailyCalories) : TreatAllowance
        + CheckAllowanceExceeded(treatAllowance) : bool
        + GetRecommendedTreatCalories(pet) : decimal
        + ResetDailyAllowance(treatAllowance) : void
    }

    class FoodTransitionService <<Service>> SERVICE_COLOR {
        + GenerateTransitionSchedule(durationDays) : TransitionSchedule
        + CalculateDailyRatio(day, totalDays) : DailyRatio
        + TrackTransitionProgress(transition) : decimal
        + ValidateTransitionPlan(plan) : bool
    }

    class DietaryIssueAnalysisService <<Service>> SERVICE_COLOR {
        + AnalyzeIssuePatterns(issues) : IssuePattern
        + CorrelateWithFoodChanges(issues, foodHistory) : List<Correlation>
        + IdentifyAllergicTriggers(issues) : List<string>
        + GenerateHealthInsights(pet, issues) : List<Insight>
    }

    class FeedingReminderService <<Service>> SERVICE_COLOR {
        + ScheduleReminder(feedingTime) : void
        + SendReminder(feedingTime) : void
        + CancelReminder(feedingId) : void
        + GetUpcomingReminders(petId) : List<Reminder>
    }
}

' Repositories
package "Repositories" <<Rectangle>> #E0E0E0 {

    interface INutritionRepository {
        + GetById(id) : NutritionPlan
        + GetByPetId(petId) : NutritionPlan
        + Save(nutritionPlan) : void
        + Delete(id) : void
        + GetFeedingSchedule(petId, startDate, endDate) : List<FeedingTime>
    }

    interface IFeedingRepository {
        + GetById(id) : FeedingRecord
        + GetByPetId(petId, startDate, endDate) : List<FeedingRecord>
        + Save(record) : void
        + GetMissedFeedings(petId) : List<FeedingRecord>
    }

    interface ITreatRepository {
        + GetByPetId(petId, date) : List<TreatRecord>
        + Save(record) : void
        + GetTotalCalories(petId, date) : decimal
    }

    interface IFoodBrandRepository {
        + GetCurrentBrand(petId) : FoodBrand
        + GetBrandHistory(petId) : List<FoodBrandChange>
        + SaveBrandChange(change) : void
        + GetBrandByName(brandName) : FoodBrand
    }

    interface IDietaryIssueRepository {
        + GetById(id) : DietaryIssue
        + GetByPetId(petId, status) : List<DietaryIssue>
        + Save(issue) : void
        + Update(issueId, data) : void
    }
}

' Application Services
package "Application Services" <<Rectangle>> #E3F2FD {

    class NutritionCommandHandler {
        - INutritionRepository _nutritionRepo
        - IEventPublisher _eventPublisher
        --
        + HandleSetFeedingSchedule(command) : Guid
        + HandleRecordFeeding(command) : void
        + HandleChangeFoodBrand(command) : void
        + HandleRecordTreat(command) : void
        + HandleReportDietaryIssue(command) : Guid
        + HandleUpdateDietaryIssue(command) : void
    }

    class NutritionQueryHandler {
        - INutritionRepository _nutritionRepo
        - IFeedingRepository _feedingRepo
        - ITreatRepository _treatRepo
        --
        + GetNutritionPlan(petId) : NutritionPlanDTO
        + GetFeedingSchedule(petId, start, end) : ScheduleDTO
        + GetFeedingHistory(petId, period) : List<FeedingDTO>
        + GetTreatHistory(petId, period) : List<TreatDTO>
        + GetNutritionStatistics(petId, period) : NutritionStatsDTO
        + GetDietaryIssues(petId, status) : List<IssueDTO>
    }
}

' Relationships
NutritionPlan "1" *-- "1" FeedingSchedule
NutritionPlan "1" *-- "1" TreatAllowance
NutritionPlan "1" *-- "1" FoodBrand
NutritionPlan "1" o-- "1" FeedingHistory
NutritionPlan "1" o-- "1" TreatHistory
NutritionPlan "1" o-- "1" FoodBrandHistory
NutritionPlan "1" o-- "1" DietaryIssueHistory

FeedingSchedule "1" *-- "many" FeedingTime
FeedingSchedule -- ScheduleType
FeedingHistory "1" *-- "many" FeedingRecord
TreatHistory "1" *-- "many" TreatRecord
FoodBrandHistory "1" *-- "many" FoodBrandChange
FoodBrandHistory "1" *-- "1" FoodBrand
DietaryIssueHistory "1" *-- "many" DietaryIssue

FoodBrand -- FoodType
FoodBrandChange -- ReasonCategory
DietaryIssue -- IssueCategory
DietaryIssue -- IssueSeverity
DietaryIssue -- ResolutionStatus
FeedingRecord -- FeedingStatus

FoodBrandChange "1" *-- "1" TransitionSchedule
TransitionSchedule "1" *-- "many" DailyRatio

' Events triggered by NutritionPlan
NutritionPlan ..> FoodBrandChanged : raises
NutritionPlan ..> FeedingScheduleSet : raises
NutritionPlan ..> TreatGiven : raises
NutritionPlan ..> DietaryIssueReported : raises
NutritionPlan ..> FeedingRecorded : raises

' Services use entities
FeedingScheduleService ..> NutritionPlan : uses
FeedingScheduleService ..> FeedingSchedule : uses
NutritionCalculationService ..> DailyNutrition : creates
NutritionCalculationService ..> FoodBrand : uses
TreatAllowanceService ..> TreatAllowance : uses
FoodTransitionService ..> TransitionSchedule : creates
FoodTransitionService ..> FoodBrandChange : uses
DietaryIssueAnalysisService ..> DietaryIssue : analyzes
FeedingReminderService ..> FeedingTime : uses

' Repository implementations
NutritionCommandHandler ..> INutritionRepository : uses
NutritionCommandHandler ..> IFeedingRepository : uses
NutritionCommandHandler ..> ITreatRepository : uses
NutritionQueryHandler ..> INutritionRepository : uses
NutritionQueryHandler ..> IFeedingRepository : uses
NutritionQueryHandler ..> ITreatRepository : uses
NutritionQueryHandler ..> IDietaryIssueRepository : uses

' Command Handler creates events
NutritionCommandHandler ..> FoodBrandChanged : publishes
NutritionCommandHandler ..> FeedingScheduleSet : publishes
NutritionCommandHandler ..> TreatGiven : publishes
NutritionCommandHandler ..> DietaryIssueReported : publishes
NutritionCommandHandler ..> FeedingRecorded : publishes

note right of NutritionPlan
    Aggregate Root for
    Nutrition Management

    Enforces invariants:
    - Active plan has valid schedule
    - Treat allowance not exceeded without warning
    - Food transitions tracked
    - Dietary issues monitored
end note

note right of TreatAllowance
    Value Object ensures
    daily treat limits

    Automatically warns when
    allowance is approached
    or exceeded
end note

note bottom of FoodTransitionService
    Domain Service responsible for
    managing food brand transitions

    Handles:
    - Gradual transition schedules
    - Daily ratio calculations
    - Progress tracking
    - Transition validation
end note

note right of DietaryIssueAnalysisService
    Analyzes patterns in dietary issues
    to identify food allergies and
    correlations with food changes

    Provides health insights and
    recommendations
end note

@enduml
