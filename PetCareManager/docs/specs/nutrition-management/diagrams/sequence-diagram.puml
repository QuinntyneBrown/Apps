@startuml Nutrition Management - Sequence Diagrams

!define ACTOR_COLOR #4FC3F7
!define UI_COLOR #81C784
!define API_COLOR #FFB74D
!define SERVICE_COLOR #9575CD
!define REPO_COLOR #E57373
!define EVENT_COLOR #FFD54F

skinparam sequenceBoxBorderColor #888888

' ========================================
' Scenario 1: Set Feeding Schedule
' ========================================
title Scenario 1: Set Feeding Schedule for Pet

actor "Pet Owner" as Owner ACTOR_COLOR
participant "Nutrition UI" as UI UI_COLOR
participant "API Gateway" as API API_COLOR
participant "Nutrition\nCommand Handler" as Handler SERVICE_COLOR
participant "NutritionPlan\nAggregate" as NutritionPlan SERVICE_COLOR
participant "Feeding Schedule\nService" as ScheduleService SERVICE_COLOR
participant "Nutrition\nRepository" as NutritionRepo REPO_COLOR
participant "Event\nPublisher" as EventBus EVENT_COLOR

Owner -> UI : Click "Set Feeding Schedule"
activate UI

UI -> Owner : Display schedule form
Owner -> UI : Enter feeding details:\n- Times: 8:00 AM, 6:00 PM\n- Portions: 1.5 cups each\n- Food brand: "Premium Dog Food"\n- Daily calorie target: 800 cal
UI -> UI : Validate form inputs\n- Valid feeding times\n- Positive portions\n- Reasonable calories

UI -> API : POST /api/nutrition/feeding-schedule/set
activate API

API -> API : Authenticate user\nAuthorize access to pet

API -> Handler : SetFeedingScheduleCommand
activate Handler

Handler -> NutritionRepo : GetByPetId(petId)
activate NutritionRepo
NutritionRepo --> Handler : NutritionPlan
deactivate NutritionRepo

Handler -> NutritionPlan : SetFeedingSchedule(data)
activate NutritionPlan

NutritionPlan -> NutritionPlan : Validate schedule rules:\n- At least one feeding time\n- Times are unique\n- Portions are positive\n- Total matches daily amount

alt Validation Fails
    NutritionPlan --> Handler : ValidationException
    Handler --> API : 400 Bad Request
    API --> UI : Error response
    UI --> Owner : Show validation errors
else Validation Succeeds
    NutritionPlan -> ScheduleService : GenerateSchedule(feedingTimes)
    activate ScheduleService

    ScheduleService -> ScheduleService : Create FeedingTime objects\nCalculate portion calories\nValidate total portions
    ScheduleService --> NutritionPlan : FeedingSchedule
    deactivate ScheduleService

    NutritionPlan -> NutritionPlan : Create/Update FeedingSchedule\nSet treat allowance\nUpdate daily calorie target

    NutritionPlan -> EventBus : Publish FeedingScheduleSet event
    activate EventBus

    EventBus -> EventBus : Notify subscribers:\n- FeedingReminderService\n- NotificationService\n- AuditService
    deactivate EventBus

    Handler -> NutritionRepo : Save(nutritionPlan)
    activate NutritionRepo
    NutritionRepo -> NutritionRepo : Persist to database
    NutritionRepo --> Handler : Success
    deactivate NutritionRepo

    Handler --> API : 201 Created\n{feedingScheduleId}
    deactivate Handler

    API --> UI : Success response
    deactivate API

    UI -> UI : Update nutrition dashboard\nShow feeding schedule
    UI --> Owner : "Feeding schedule set!\nReminders scheduled for 7:45 AM and 5:45 PM"
    deactivate UI

    note right of EventBus
        FeedingScheduleSet event triggers:
        1. Schedule feeding reminders
        2. Send confirmation notification
        3. Create audit log entry
        4. Update nutrition statistics
    end note

    deactivate NutritionPlan
end

|||

' ========================================
' Scenario 2: Record Feeding
' ========================================
newpage Scenario 2: Record Feeding

actor "Pet Owner" as Owner2 ACTOR_COLOR
participant "Nutrition UI" as UI2 UI_COLOR
participant "API Gateway" as API2 API_COLOR
participant "Nutrition\nCommand Handler" as Handler2 SERVICE_COLOR
participant "NutritionPlan\nAggregate" as NutritionPlan2 SERVICE_COLOR
participant "Nutrition Calculation\nService" as NutritionService SERVICE_COLOR
participant "Nutrition\nRepository" as NutritionRepo2 REPO_COLOR
participant "Feeding\nRepository" as FeedingRepo REPO_COLOR
participant "Event\nPublisher" as EventBus2 EVENT_COLOR

Owner2 -> UI2 : Receive feeding reminder notification
activate UI2

UI2 -> Owner2 : Show "Feed Your Pet" prompt\n(Fluffy - 8:00 AM - 1.5 cups)

Owner2 -> UI2 : Click "Fed Now"

UI2 -> API2 : POST /api/nutrition/feeding/record
activate API2

API2 -> Handler2 : RecordFeedingCommand
activate Handler2

Handler2 -> NutritionRepo2 : GetByPetId(petId)
activate NutritionRepo2
NutritionRepo2 --> Handler2 : NutritionPlan
deactivate NutritionRepo2

Handler2 -> NutritionPlan2 : RecordFeeding(data)
activate NutritionPlan2

NutritionPlan2 -> NutritionPlan2 : Validate:\n- Feeding time exists in schedule\n- Portion is reasonable\n- Not already recorded

NutritionPlan2 -> NutritionPlan2 : Create FeedingRecord:\n- Scheduled: 8:00 AM\n- Actual: 8:05 AM\n- Portion: 1.5 cups\n- Fed by: Owner

NutritionPlan2 -> NutritionService : CalculateDailyCalories(feedings)
activate NutritionService

NutritionService -> NutritionService : Sum all feedings today\nAdd treat calories\nCompare to target
NutritionService --> NutritionPlan2 : DailyNutrition
deactivate NutritionService

NutritionPlan2 -> EventBus2 : Publish FeedingRecorded event
activate EventBus2
deactivate EventBus2

NutritionPlan2 --> Handler2 : FeedingRecord
deactivate NutritionPlan2

Handler2 -> NutritionRepo2 : Save(nutritionPlan)
activate NutritionRepo2
NutritionRepo2 --> Handler2 : Success
deactivate NutritionRepo2

Handler2 -> FeedingRepo : Save(feedingRecord)
activate FeedingRepo
FeedingRepo --> Handler2 : Success
deactivate FeedingRepo

Handler2 --> API2 : 200 OK
deactivate Handler2

API2 --> UI2 : Success response
deactivate API2

UI2 -> UI2 : Update feeding schedule:\nMark 8:00 AM as completed\nShow next feeding: 6:00 PM

UI2 --> Owner2 : "Feeding recorded!\nNext feeding: Today at 6:00 PM\nDaily calories: 400 of 800"
deactivate UI2

note right of NutritionService
    Calculates total nutrition for the day:
    - Morning feeding: 400 cal
    - Evening feeding: pending
    - Treats: 0 cal (so far)
    - Total: 400 / 800 cal (50%)
end note

|||

' ========================================
' Scenario 3: Change Food Brand with Transition
' ========================================
newpage Scenario 3: Change Food Brand with Transition Plan

actor "Pet Owner" as Owner3 ACTOR_COLOR
participant "Nutrition UI" as UI3 UI_COLOR
participant "API Gateway" as API3 API_COLOR
participant "Nutrition\nCommand Handler" as Handler3 SERVICE_COLOR
participant "NutritionPlan\nAggregate" as NutritionPlan3 SERVICE_COLOR
participant "Food Transition\nService" as TransitionService SERVICE_COLOR
participant "Nutrition\nRepository" as NutritionRepo3 REPO_COLOR
participant "Event\nPublisher" as EventBus3 EVENT_COLOR
participant "Notification\nService" as NotificationService SERVICE_COLOR

Owner3 -> UI3 : Navigate to "Change Food Brand"
activate UI3

UI3 -> Owner3 : Show current brand:\n"Premium Dog Food - Dry"

Owner3 -> UI3 : Select new brand:\n"Healthy Pet Food - Dry"\nReason: "Veterinary Recommendation"\nTransition: 10 days

UI3 -> TransitionService : PreviewTransitionSchedule(10 days)
activate TransitionService

TransitionService -> TransitionService : Generate daily ratios:\nDay 1: 90% old, 10% new\nDay 2: 80% old, 20% new\n...\nDay 10: 0% old, 100% new

TransitionService --> UI3 : TransitionSchedule preview
deactivate TransitionService

UI3 -> Owner3 : Show transition plan preview

Owner3 -> UI3 : Confirm food brand change

UI3 -> API3 : POST /api/nutrition/food-brand/change
activate API3

API3 -> Handler3 : ChangeFoodBrandCommand
activate Handler3

Handler3 -> NutritionRepo3 : GetByPetId(petId)
activate NutritionRepo3
NutritionRepo3 --> Handler3 : NutritionPlan
deactivate NutritionRepo3

Handler3 -> NutritionPlan3 : ChangeFoodBrand(newBrand, transitionPlan)
activate NutritionPlan3

NutritionPlan3 -> NutritionPlan3 : Validate:\n- New brand different from current\n- Transition duration >= 7 days\n- Brand compatible with pet type

NutritionPlan3 -> TransitionService : GenerateTransitionSchedule(10)
activate TransitionService

TransitionService -> TransitionService : Create TransitionSchedule:\n- Start date: today\n- End date: today + 10 days\n- Daily ratios calculated

TransitionService --> NutritionPlan3 : TransitionSchedule
deactivate TransitionService

NutritionPlan3 -> NutritionPlan3 : Create FoodBrandChange record:\n- Previous: Premium Dog Food\n- New: Healthy Pet Food\n- Reason: Vet recommendation\n- Transition: 10 days

NutritionPlan3 -> NutritionPlan3 : Archive current food brand\nSet new brand as "in transition"

NutritionPlan3 -> EventBus3 : Publish FoodBrandChanged event
activate EventBus3

EventBus3 -> NotificationService : Handle FoodBrandChanged event
activate NotificationService

NotificationService -> Owner3 : Send transition started notification\n"Food transition begins today!\nFollow daily mixing ratios"

NotificationService -> NotificationService : Schedule milestone reminders:\n- Day 3: Check digestive health\n- Day 7: Halfway point\n- Day 10: Transition complete

deactivate NotificationService
deactivate EventBus3

NutritionPlan3 --> Handler3 : FoodBrandChange
deactivate NutritionPlan3

Handler3 -> NutritionRepo3 : Save(nutritionPlan)
activate NutritionRepo3
NutritionRepo3 --> Handler3 : Success
deactivate NutritionRepo3

Handler3 --> API3 : 201 Created\n{foodBrandChangeId}
deactivate Handler3

API3 --> UI3 : Success response
deactivate API3

UI3 -> UI3 : Show transition tracker\nDisplay Day 1 ratios:\n90% Premium (1.35 cups)\n10% Healthy (0.15 cups)

UI3 --> Owner3 : "Food transition started!\nDay 1: Mix 90% old, 10% new\nSee daily ratios in transition tracker"
deactivate UI3

note right of TransitionService
    Transition schedule for 10 days:
    - Gradual reduction of old food
    - Gradual increase of new food
    - Daily ratio adjustments
    - Milestone reminders scheduled
    - Health monitoring enabled
end note

|||

' ========================================
' Scenario 4: Record Treat and Monitor Allowance
' ========================================
newpage Scenario 4: Record Treat and Monitor Allowance

actor "Pet Owner" as Owner4 ACTOR_COLOR
participant "Nutrition UI" as UI4 UI_COLOR
participant "API Gateway" as API4 API_COLOR
participant "Nutrition\nCommand Handler" as Handler4 SERVICE_COLOR
participant "NutritionPlan\nAggregate" as NutritionPlan4 SERVICE_COLOR
participant "Treat Allowance\nService" as TreatService SERVICE_COLOR
participant "Treat\nRepository" as TreatRepo REPO_COLOR
participant "Event\nPublisher" as EventBus4 EVENT_COLOR
participant "Notification\nService" as NotificationService2 SERVICE_COLOR

Owner4 -> UI4 : Click "Record Treat"
activate UI4

UI4 -> Owner4 : Show treat form\nCurrent allowance:\n2 of 3 treats used\n60 of 100 calories used

Owner4 -> UI4 : Enter treat:\n- Type: Training treat\n- Quantity: 2\n- Calories: 25 each\n- Reason: Training session

UI4 -> UI4 : Calculate: 2 × 25 = 50 cal\nNew total: 3 + 2 = 5 treats\nNew calories: 60 + 50 = 110 cal\n⚠ Warning: Exceeds allowance!

UI4 -> Owner4 : Show warning:\n"This will exceed daily allowance\n(5 treats, 110 cal > 100 cal limit)\nContinue?"

Owner4 -> UI4 : Confirm "Yes, record anyway"

UI4 -> API4 : POST /api/nutrition/treat/give
activate API4

API4 -> Handler4 : RecordTreatCommand
activate Handler4

Handler4 -> NutritionRepo : GetByPetId(petId)
activate NutritionRepo
NutritionRepo --> Handler4 : NutritionPlan
deactivate NutritionRepo

Handler4 -> NutritionPlan4 : RecordTreat(data)
activate NutritionPlan4

NutritionPlan4 -> TreatRepo : GetTreats(petId, today)
activate TreatRepo
TreatRepo --> NutritionPlan4 : TreatRecords (2 treats, 60 cal)
deactivate TreatRepo

NutritionPlan4 -> NutritionPlan4 : Create TreatRecord:\n- Type: Training\n- Quantity: 2\n- Total: 50 cal\n- Given by: Owner

NutritionPlan4 -> TreatService : CheckAllowanceExceeded(treatAllowance)
activate TreatService

TreatService -> TreatService : Calculate totals:\n- Treats today: 3 + 2 = 5\n- Calories today: 60 + 50 = 110\n- Max treats: 3\n- Max calories: 100\n- Exceeded: YES

TreatService --> NutritionPlan4 : AllowanceExceeded = true
deactivate TreatService

NutritionPlan4 -> NutritionPlan4 : Update TreatAllowance:\n- currentCount = 5\n- currentCalories = 110\n- exceeded = true

NutritionPlan4 -> EventBus4 : Publish TreatGiven event
activate EventBus4

EventBus4 -> NotificationService2 : Handle TreatGiven event
activate NotificationService2

NotificationService2 -> NotificationService2 : Detect allowance exceeded\nPriority: Medium\nGenerate alert message

NotificationService2 -> Owner4 : Send treat limit alert\n"Daily treat allowance exceeded!\n5 treats (110 cal) > limit of 3 treats (100 cal)\nConsider reducing treats tomorrow"

deactivate NotificationService2
deactivate EventBus4

NutritionPlan4 --> Handler4 : TreatRecord
deactivate NutritionPlan4

Handler4 -> TreatRepo : Save(treatRecord)
activate TreatRepo
TreatRepo --> Handler4 : Success
deactivate TreatRepo

Handler4 --> API4 : 200 OK
deactivate Handler4

API4 --> UI4 : Success response
deactivate API4

UI4 -> UI4 : Update treat tracker:\n⚠ 5 of 3 treats (exceeded)\n⚠ 110 of 100 cal (exceeded)\nShow warning badge

UI4 --> Owner4 : "Treats recorded!\n⚠ Daily limit exceeded\nRecommendation: No more treats today"
deactivate UI4

note right of TreatService
    Treat allowance monitoring:
    - Tracks daily treat count
    - Tracks daily calorie total
    - Warns when approaching limit
    - Alerts when exceeded
    - Resets at midnight
    - Provides recommendations
end note

|||

' ========================================
' Scenario 5: Report Dietary Issue
' ========================================
newpage Scenario 5: Report Dietary Issue

actor "Pet Owner" as Owner5 ACTOR_COLOR
participant "Nutrition UI" as UI5 UI_COLOR
participant "API Gateway" as API5 API_COLOR
participant "Nutrition\nCommand Handler" as Handler5 SERVICE_COLOR
participant "NutritionPlan\nAggregate" as NutritionPlan5 SERVICE_COLOR
participant "Dietary Issue Analysis\nService" as AnalysisService SERVICE_COLOR
participant "Dietary Issue\nRepository" as IssueRepo REPO_COLOR
participant "Event\nPublisher" as EventBus5 EVENT_COLOR
participant "Notification\nService" as NotificationService3 SERVICE_COLOR

Owner5 -> UI5 : Click "Report Dietary Issue"
activate UI5

UI5 -> Owner5 : Show issue report form

Owner5 -> UI5 : Submit issue:\n- Category: Vomiting\n- Severity: Moderate\n- Symptoms: Vomiting, lethargy\n- Onset: Yesterday (Day 3 of food transition)\n- Suspected: New food brand

UI5 -> UI5 : Detect: Issue during food transition!\nAuto-suggest: May be related to new food

UI5 -> API5 : POST /api/nutrition/issue/report
activate API5

API5 -> Handler5 : ReportDietaryIssueCommand
activate Handler5

Handler5 -> NutritionRepo : GetByPetId(petId)
activate NutritionRepo
NutritionRepo --> Handler5 : NutritionPlan (in transition)
deactivate NutritionRepo

Handler5 -> NutritionPlan5 : ReportDietaryIssue(data)
activate NutritionPlan5

NutritionPlan5 -> NutritionPlan5 : Validate:\n- Issue category required\n- Severity specified\n- Onset date <= today

NutritionPlan5 -> NutritionPlan5 : Create DietaryIssue:\n- Category: Vomiting\n- Severity: Moderate\n- Food brand: "Healthy Pet Food" (transition)\n- Recent food change: YES\n- Status: Ongoing

NutritionPlan5 -> AnalysisService : AnalyzeIssuePatterns(pet, issue)
activate AnalysisService

AnalysisService -> IssueRepo : GetIssueHistory(petId)
activate IssueRepo
IssueRepo --> AnalysisService : Previous issues
deactivate IssueRepo

AnalysisService -> AnalysisService : Analyze patterns:\n- Issue during food transition\n- Day 3 of 10-day transition\n- Similar symptoms in past?\n- Correlation with food changes?

AnalysisService -> AnalysisService : Generate insights:\n- Likely related to new food\n- Recommendation: Slow transition\n- Consider pausing transition

AnalysisService --> NutritionPlan5 : IssuePattern & Recommendations
deactivate AnalysisService

NutritionPlan5 -> EventBus5 : Publish DietaryIssueReported event
activate EventBus5

EventBus5 -> NotificationService3 : Handle DietaryIssueReported event
activate NotificationService3

NotificationService3 -> NotificationService3 : Determine severity: Moderate\nCheck if vet notification needed\nGenerate recommendations

NotificationService3 -> Owner5 : Send issue logged notification\n"Dietary issue recorded.\nRecommendations:\n1. Pause food transition\n2. Return to 100% old food\n3. Contact vet if symptoms persist"

alt Severity is Severe or Critical
    NotificationService3 -> NotificationService3 : Notify assigned veterinarian
    NotificationService3 -> NotificationService3 : Flag as urgent\nRecommend immediate vet visit
end

deactivate NotificationService3
deactivate EventBus5

NutritionPlan5 --> Handler5 : DietaryIssue
deactivate NutritionPlan5

Handler5 -> IssueRepo : Save(dietaryIssue)
activate IssueRepo
IssueRepo --> Handler5 : Success
deactivate IssueRepo

Handler5 --> API5 : 201 Created\n{issueId}
deactivate Handler5

API5 --> UI5 : Success response with recommendations
deactivate API5

UI5 -> UI5 : Show dietary issue alert banner\nDisplay recommendations\nOffer quick actions:\n- Pause transition\n- Contact vet\n- Update issue status

UI5 --> Owner5 : "Issue reported and analyzed!\n\n⚠ Recommendations:\n- Pause food transition\n- Monitor symptoms\n- Contact vet if worsens"
deactivate UI5

note right of AnalysisService
    Dietary issue analysis identifies:
    - Correlation with food changes
    - Pattern of similar issues
    - Potential food allergies
    - Timing relationships
    - Severity escalation
    - Actionable recommendations
end note

@enduml
