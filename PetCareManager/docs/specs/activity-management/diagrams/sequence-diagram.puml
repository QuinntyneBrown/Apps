@startuml Activity Management Sequence Diagram

skinparam backgroundColor white
skinparam shadowing false
skinparam sequenceArrowThickness 2
skinparam roundcorner 10

title Activity Management - Key Sequence Flows

autonumber

box "Client Layer" #LightBlue
  actor "Pet Owner" as Owner
  participant "Web/Mobile App" as UI
end box

box "API Layer" #LightGreen
  participant "API Controller" as API
  participant "Command Handler" as Handler
end box

box "Domain Layer" #LightYellow
  participant "Exercise Session\nAggregate" as SessionAggregate
  participant "Exercise Goal\nAggregate" as GoalAggregate
  participant "Activity Calculation\nService" as CalcService
  participant "Goal Progress\nService" as GoalService
end box

box "Infrastructure Layer" #LightCoral
  participant "Repository" as Repo
  participant "Event Bus" as EventBus
  participant "Database" as DB
end box

box "Event Processing" #Lavender
  participant "Event Handler" as EventHandler
  participant "Notification\nService" as NotifService
end box

== Log Exercise Session Flow ==

Owner -> UI: Log exercise session
activate UI

UI -> UI: Validate input data
UI -> API: POST /api/v1/exercise-sessions
activate API

API -> Handler: Execute LogExerciseSessionCommand
activate Handler

Handler -> SessionAggregate: Create ExerciseSession
activate SessionAggregate

SessionAggregate -> SessionAggregate: Validate business rules
note right
  - Check duration range
  - Validate time constraints
  - Verify pet ownership
end note

SessionAggregate -> CalcService: CalculateCaloriesBurned(session, petProfile)
activate CalcService
CalcService --> SessionAggregate: calories
deactivate CalcService

SessionAggregate -> SessionAggregate: Set CaloriesBurned

SessionAggregate -> EventBus: Publish ExerciseSessionLogged
activate EventBus
EventBus --> SessionAggregate: Event published
deactivate EventBus

deactivate SessionAggregate

Handler -> Repo: Save(exerciseSession)
activate Repo
Repo -> DB: INSERT exercise_sessions
activate DB
DB --> Repo: Success
deactivate DB
deactivate Repo

Handler --> API: SessionId
deactivate Handler

API --> UI: 201 Created {sessionId}
deactivate API

UI --> Owner: "Exercise session logged successfully"
deactivate UI

== Event Processing - Update Goal Progress ==

EventBus -> EventHandler: ExerciseSessionLogged event
activate EventHandler

EventHandler -> Repo: GetActiveGoals(petId)
activate Repo
Repo -> DB: SELECT FROM exercise_goals
activate DB
DB --> Repo: Active goals
deactivate DB
Repo --> EventHandler: List<ExerciseGoal>
deactivate Repo

loop For each active goal
  EventHandler -> GoalService: CalculateProgress(goal, sessions)
  activate GoalService

  GoalService -> Repo: GetSessionsForPeriod(petId, dateRange)
  activate Repo
  Repo -> DB: SELECT FROM exercise_sessions
  activate DB
  DB --> Repo: Sessions
  deactivate DB
  Repo --> GoalService: List<ExerciseSession>
  deactivate Repo

  GoalService -> GoalService: Calculate totals\nand percentage
  GoalService --> EventHandler: GoalProgress
  deactivate GoalService

  EventHandler -> GoalAggregate: UpdateProgress(progress)
  activate GoalAggregate

  alt Goal completed
    GoalAggregate -> GoalAggregate: MarkAsCompleted()
    GoalAggregate -> EventBus: Publish GoalCompletedEvent
    activate EventBus
    EventBus --> GoalAggregate: Event published
    deactivate EventBus
  end

  deactivate GoalAggregate

  EventHandler -> Repo: Update(goal)
  activate Repo
  Repo -> DB: UPDATE exercise_goals
  activate DB
  DB --> Repo: Success
  deactivate DB
  deactivate Repo
end

EventHandler -> NotifService: SendActivityNotification(petId)
activate NotifService
NotifService --> EventHandler: Notification sent
deactivate NotifService

deactivate EventHandler

== Set Exercise Goal Flow ==

Owner -> UI: Set new exercise goal
activate UI

UI -> UI: Validate goal parameters
UI -> API: POST /api/v1/exercise-goals
activate API

API -> Handler: Execute SetExerciseGoalCommand
activate Handler

Handler -> Repo: GetActiveGoals(petId, goalType)
activate Repo
Repo -> DB: SELECT FROM exercise_goals
activate DB
DB --> Repo: Existing goals
deactivate DB
Repo --> Handler: List<ExerciseGoal>
deactivate Repo

Handler -> Handler: Verify no duplicate\nactive goal for type
note right
  Business rule: Only one
  active goal per type per pet
end note

Handler -> GoalAggregate: Create ExerciseGoal
activate GoalAggregate

GoalAggregate -> GoalAggregate: Validate goal rules
note right
  - At least one target metric
  - Start date not in past
  - Recurring goals have no end date
end note

GoalAggregate -> EventBus: Publish ExerciseGoalSet
activate EventBus
EventBus --> GoalAggregate: Event published
deactivate EventBus

deactivate GoalAggregate

Handler -> Repo: Save(exerciseGoal)
activate Repo
Repo -> DB: INSERT exercise_goals
activate DB
DB --> Repo: Success
deactivate DB
deactivate Repo

Handler --> API: GoalId
deactivate Handler

API --> UI: 201 Created {goalId}
deactivate API

UI --> Owner: "Exercise goal set successfully"
deactivate UI

== Log Behavior Incident Flow ==

Owner -> UI: Log behavior incident
activate UI

UI -> UI: Validate incident data
UI -> API: POST /api/v1/behavior-incidents
activate API

API -> Handler: Execute LogBehaviorIncidentCommand
activate Handler

Handler -> SessionAggregate: Create BehaviorIncident
activate SessionAggregate

SessionAggregate -> SessionAggregate: Validate incident rules
note right
  - Description minimum length
  - Occurred time not in future
  - Severity required
end note

SessionAggregate -> EventBus: Publish BehaviorIncidentLogged
activate EventBus
EventBus --> SessionAggregate: Event published
deactivate EventBus

deactivate SessionAggregate

Handler -> Repo: Save(behaviorIncident)
activate Repo
Repo -> DB: INSERT behavior_incidents
activate DB
DB --> Repo: Success
deactivate DB
deactivate Repo

Handler --> API: IncidentId
deactivate Handler

API --> UI: 201 Created {incidentId}
deactivate API

UI --> Owner: "Behavior incident logged"
deactivate UI

== Behavior Pattern Analysis ==

EventBus -> EventHandler: BehaviorIncidentLogged event
activate EventHandler

EventHandler -> Repo: GetRecentIncidents(petId, days: 30)
activate Repo
Repo -> DB: SELECT FROM behavior_incidents
activate DB
DB --> Repo: Recent incidents
deactivate DB
Repo --> EventHandler: List<BehaviorIncident>
deactivate Repo

EventHandler -> EventHandler: Analyze patterns:\n- Frequency\n- Common triggers\n- Severity trends

alt Severe incident OR pattern detected
  EventHandler -> NotifService: SendBehaviorAlert(petId, pattern)
  activate NotifService
  NotifService --> EventHandler: Alert sent
  deactivate NotifService
end

EventHandler -> Repo: UpdateBehaviorAnalytics(petId, pattern)
activate Repo
Repo -> DB: UPDATE behavior_analytics
activate DB
DB --> Repo: Success
deactivate DB
deactivate Repo

deactivate EventHandler

== View Activity Dashboard ==

Owner -> UI: Open activity dashboard
activate UI

UI -> API: GET /api/v1/activity-analytics/{petId}/summary
activate API

API -> Repo: GetActivityStatistics(petId, period)
activate Repo
Repo -> DB: SELECT aggregated data
activate DB
DB --> Repo: Statistics
deactivate DB
Repo --> API: ActivityStatistics
deactivate Repo

API --> UI: 200 OK {summary}
deactivate API

UI -> API: GET /api/v1/exercise-goals/{petId}?status=Active
activate API

API -> Repo: GetActiveGoals(petId)
activate Repo
Repo -> DB: SELECT FROM exercise_goals
activate DB
DB --> Repo: Active goals
deactivate DB
Repo --> API: List<ExerciseGoal>
deactivate Repo

API --> UI: 200 OK {goals}
deactivate API

UI -> API: GET /api/v1/exercise-sessions/{petId}?page=1&pageSize=5
activate API

API -> Repo: GetRecentSessions(petId, page, pageSize)
activate Repo
Repo -> DB: SELECT FROM exercise_sessions
activate DB
DB --> Repo: Recent sessions
deactivate DB
Repo --> API: PagedResult<ExerciseSession>
deactivate Repo

API --> UI: 200 OK {sessions}
deactivate API

UI -> UI: Render dashboard with:\n- Activity stats\n- Goal progress\n- Recent sessions\n- Behavior alerts

UI --> Owner: Display comprehensive dashboard
deactivate UI

@enduml
