@startuml Veterinary Management - Appointment Booking Sequence Diagram

' Define styles
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true
skinparam BoxPadding 10

title Complete Appointment Booking and Completion Flow

' Actors and Participants
actor "Pet Owner" as Owner
participant "Web/Mobile UI" as UI
participant "API Gateway" as API
participant "Appointment\nService" as AppointmentSvc
participant "Veterinarian\nService" as VetSvc
participant "Pet\nService" as PetSvc
participant "Event Bus" as EventBus
participant "Notification\nService" as NotificationSvc
participant "Calendar\nService" as CalendarSvc
participant "Database" as DB
actor "Veterinarian" as Vet

' === APPOINTMENT SCHEDULING FLOW ===
group Appointment Scheduling Flow
    Owner -> UI: Navigate to\n"Schedule Appointment"
    activate UI

    UI -> API: GET /api/pets/{ownerId}
    activate API
    API -> PetSvc: GetPetsByOwner(ownerId)
    activate PetSvc
    PetSvc -> DB: SELECT pets
    activate DB
    DB --> PetSvc: Pet list
    deactivate DB
    PetSvc --> API: Pet list
    deactivate PetSvc
    API --> UI: Pet list
    deactivate API

    UI --> Owner: Display pet selector

    Owner -> UI: Select pet
    Owner -> UI: Select appointment type

    UI -> API: GET /api/veterinarians/available\n?date=2025-01-15&type=checkup
    activate API
    API -> VetSvc: GetAvailableVets(date, type)
    activate VetSvc
    VetSvc -> DB: Query available vets
    activate DB
    DB --> VetSvc: Available vets
    deactivate DB
    VetSvc --> API: Available vets with time slots
    deactivate VetSvc
    API --> UI: Available vets and slots
    deactivate API

    UI --> Owner: Display available\nvets and time slots

    Owner -> UI: Select veterinarian\nand time slot
    Owner -> UI: Enter reason for visit
    Owner -> UI: Click "Schedule Appointment"

    UI -> API: POST /api/veterinary/appointments\n{\n  petId, veterinarianId,\n  dateTime, type, reason\n}
    activate API

    API -> AppointmentSvc: ScheduleAppointment(request)
    activate AppointmentSvc

    AppointmentSvc -> VetSvc: CheckAvailability(vetId, dateTime)
    activate VetSvc
    VetSvc -> DB: Check conflicts
    activate DB
    DB --> VetSvc: Available: true
    deactivate DB
    VetSvc --> AppointmentSvc: Confirmed available
    deactivate VetSvc

    AppointmentSvc -> AppointmentSvc: Create VetAppointment\naggregate
    AppointmentSvc -> AppointmentSvc: Generate\nconfirmation number

    AppointmentSvc -> DB: INSERT appointment
    activate DB
    DB --> AppointmentSvc: Appointment saved
    deactivate DB

    AppointmentSvc -> EventBus: Publish\nVetAppointmentScheduled event
    activate EventBus

    AppointmentSvc --> API: AppointmentId,\nconfirmation number
    deactivate AppointmentSvc

    API --> UI: 201 Created\n{\n  appointmentId,\n  confirmationNumber\n}
    deactivate API

    UI --> Owner: Show success message\n"Appointment scheduled!"
    deactivate UI

    ' Event Processing
    EventBus -> NotificationSvc: VetAppointmentScheduled event
    activate NotificationSvc
    NotificationSvc -> NotificationSvc: Prepare confirmation\nemail/SMS
    NotificationSvc -> Owner: Send confirmation\nemail/SMS
    NotificationSvc -> Vet: Send notification\n"New appointment scheduled"
    deactivate NotificationSvc

    EventBus -> CalendarSvc: VetAppointmentScheduled event
    activate CalendarSvc
    CalendarSvc -> CalendarSvc: Create calendar entry
    CalendarSvc -> Owner: Send calendar invite
    deactivate CalendarSvc

    deactivate EventBus
end

|||

' === APPOINTMENT REMINDER FLOW ===
group Appointment Reminder Flow (24 hours before)
    NotificationSvc -> NotificationSvc: Scheduled job\nchecks upcoming\nappointments
    activate NotificationSvc
    NotificationSvc -> DB: Query appointments\nwithin 24 hours
    activate DB
    DB --> NotificationSvc: Appointment list
    deactivate DB

    NotificationSvc -> Owner: Send reminder\nemail/SMS with\nappointment details
    deactivate NotificationSvc
end

|||

' === APPOINTMENT COMPLETION FLOW ===
group Appointment Completion Flow
    Vet -> UI: Open appointment\nin veterinarian portal
    activate UI

    UI -> API: GET /api/veterinary/appointments/{id}
    activate API
    API -> AppointmentSvc: GetAppointment(id)
    activate AppointmentSvc
    AppointmentSvc -> DB: SELECT appointment
    activate DB
    DB --> AppointmentSvc: Appointment details
    deactivate DB
    AppointmentSvc --> API: Appointment
    deactivate AppointmentSvc
    API --> UI: Appointment details
    deactivate API

    UI --> Vet: Display appointment\nworkspace

    Vet -> UI: Start appointment
    UI -> API: PUT /api/veterinary/appointments/{id}/start
    activate API
    API -> AppointmentSvc: StartAppointment(id)
    activate AppointmentSvc
    AppointmentSvc -> DB: UPDATE status='InProgress',\nactualStartTime
    activate DB
    DB --> AppointmentSvc: Updated
    deactivate DB
    AppointmentSvc --> API: Success
    deactivate AppointmentSvc
    API --> UI: 200 OK
    deactivate API

    Vet -> UI: Examine pet,\nadd visit notes
    Vet -> UI: Select services provided
    Vet -> UI: Create diagnosis\n(if needed)
    Vet -> UI: Prescribe medications
    Vet -> UI: Click "Complete Appointment"

    UI -> API: PUT /api/veterinary/appointments/{id}/complete\n{\n  duration, services, notes,\n  followUpRequired, prescriptions\n}
    activate API

    API -> AppointmentSvc: CompleteAppointment(id, details)
    activate AppointmentSvc

    AppointmentSvc -> AppointmentSvc: Update appointment\nstatus to Completed
    AppointmentSvc -> AppointmentSvc: Calculate total cost

    AppointmentSvc -> DB: UPDATE appointment\nSET status='Completed',\nactualEndTime, notes
    activate DB
    DB --> AppointmentSvc: Updated
    deactivate DB

    AppointmentSvc -> DB: INSERT services
    activate DB
    DB --> AppointmentSvc: Services saved
    deactivate DB

    AppointmentSvc -> EventBus: Publish\nVetAppointmentCompleted event
    activate EventBus

    AppointmentSvc --> API: Success
    deactivate AppointmentSvc
    API --> UI: 200 OK
    deactivate API

    UI --> Vet: Show success\n"Appointment completed"
    deactivate UI

    ' Event Processing for Completion
    EventBus -> NotificationSvc: VetAppointmentCompleted event
    activate NotificationSvc
    NotificationSvc -> Owner: Send visit summary\nand follow-up info
    deactivate NotificationSvc

    EventBus -> AppointmentSvc: VetAppointmentCompleted event
    activate AppointmentSvc
    AppointmentSvc -> AppointmentSvc: Generate invoice
    AppointmentSvc -> DB: INSERT invoice
    activate DB
    DB --> AppointmentSvc: Invoice saved
    deactivate DB
    deactivate AppointmentSvc

    deactivate EventBus
end

|||

' === DIAGNOSIS CREATION FLOW ===
group Diagnosis Creation Flow (During Appointment)
    Vet -> UI: Click "Create Diagnosis"
    activate UI

    UI --> Vet: Show diagnosis form

    Vet -> UI: Enter condition,\nseverity, symptoms
    Vet -> UI: Add treatment plan
    Vet -> UI: Prescribe medications
    Vet -> UI: Click "Save Diagnosis"

    UI -> API: POST /api/veterinary/diagnoses\n{\n  petId, appointmentId,\n  condition, severity,\n  symptoms, treatmentPlan,\n  medications\n}
    activate API

    API -> AppointmentSvc: CreateDiagnosis(request)
    activate AppointmentSvc

    AppointmentSvc -> AppointmentSvc: Create Diagnosis\naggregate

    AppointmentSvc -> DB: INSERT diagnosis
    activate DB
    DB --> AppointmentSvc: Diagnosis saved
    deactivate DB

    AppointmentSvc -> DB: INSERT medications
    activate DB
    DB --> AppointmentSvc: Medications saved
    deactivate DB

    AppointmentSvc -> EventBus: Publish\nDiagnosisReceived event
    activate EventBus

    AppointmentSvc --> API: DiagnosisId
    deactivate AppointmentSvc

    API --> UI: 201 Created
    deactivate API

    UI --> Vet: "Diagnosis saved successfully"
    deactivate UI

    ' Event Processing for Diagnosis
    EventBus -> NotificationSvc: DiagnosisReceived event
    activate NotificationSvc
    NotificationSvc -> Owner: Send diagnosis report\nand treatment plan
    deactivate NotificationSvc

    EventBus -> AppointmentSvc: DiagnosisReceived event
    activate AppointmentSvc
    alt Follow-up Required
        AppointmentSvc -> AppointmentSvc: Create follow-up\nappointment suggestion
        AppointmentSvc -> Owner: Suggest follow-up\nappointment date
    end
    deactivate AppointmentSvc

    deactivate EventBus
end

|||

' === EMERGENCY REPORTING FLOW ===
group Emergency Reporting Flow
    Owner -> UI: Click "Report Emergency"
    activate UI

    UI --> Owner: Show emergency form

    Owner -> UI: Select pet
    Owner -> UI: Select emergency type
    Owner -> UI: Describe symptoms
    Owner -> UI: Set urgency level\n(Critical)
    Owner -> UI: Click "Submit Emergency"

    UI -> API: POST /api/veterinary/emergencies\n{\n  petId, emergencyType,\n  symptoms, urgencyLevel,\n  description, location\n}
    activate API

    API -> AppointmentSvc: ReportEmergency(request)
    activate AppointmentSvc

    AppointmentSvc -> AppointmentSvc: Create Emergency\naggregate

    AppointmentSvc -> DB: INSERT emergency
    activate DB
    DB --> AppointmentSvc: Emergency saved
    deactivate DB

    AppointmentSvc -> EventBus: Publish\nVeterinaryEmergency event
    activate EventBus

    AppointmentSvc -> VetSvc: FindNearestEmergencyClinic(location)
    activate VetSvc
    VetSvc --> AppointmentSvc: Nearest clinic details
    deactivate VetSvc

    AppointmentSvc --> API: EmergencyId,\nnearest clinic info
    deactivate AppointmentSvc

    API --> UI: 201 Created\n{\n  emergencyId,\n  nearestClinic,\n  triageInstructions\n}
    deactivate API

    UI --> Owner: Show emergency\nconfirmation and\nnearest clinic info
    deactivate UI

    ' Event Processing for Emergency
    EventBus -> NotificationSvc: VeterinaryEmergency event
    activate NotificationSvc
    NotificationSvc -> NotificationSvc: Priority: CRITICAL
    NotificationSvc -> Vet: Send URGENT alert\nto on-call vet\n(SMS + Email + Push)
    NotificationSvc -> Owner: Send emergency\nfirst-aid instructions
    deactivate NotificationSvc

    EventBus -> AppointmentSvc: VeterinaryEmergency event
    activate AppointmentSvc
    AppointmentSvc -> VetSvc: GetOnCallVeterinarian()
    activate VetSvc
    VetSvc --> AppointmentSvc: On-call vet details
    deactivate VetSvc
    AppointmentSvc -> AppointmentSvc: Auto-assign\nemergency to\non-call vet
    AppointmentSvc -> DB: UPDATE emergency\nSET assignedVetId
    activate DB
    DB --> AppointmentSvc: Updated
    deactivate DB
    deactivate AppointmentSvc

    deactivate EventBus

    Vet -> Vet: Receives emergency alert
    note right: Within 2 minutes\nof emergency report
end

@enduml
