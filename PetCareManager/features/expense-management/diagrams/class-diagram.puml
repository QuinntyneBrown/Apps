@startuml Expense Management Class Diagram

!define ENTITY_COLOR #E8F5E9
!define VALUE_COLOR #FFF3E0
!define ENUM_COLOR #E3F2FD
!define SERVICE_COLOR #F3E5F5

skinparam class {
    BackgroundColor<<Entity>> ENTITY_COLOR
    BackgroundColor<<ValueObject>> VALUE_COLOR
    BackgroundColor<<Enum>> ENUM_COLOR
    BackgroundColor<<Service>> SERVICE_COLOR
    BorderColor #424242
    ArrowColor #424242
}

skinparam classFontSize 11
skinparam classAttributeFontSize 10

package "Aggregates" {
    class PetExpense <<Entity>> {
        - expenseId: Guid
        - petId: Guid
        - amount: Money
        - category: ExpenseCategory
        - description: string
        - expenseDate: DateTime
        - vendor: string
        - paymentMethod: PaymentMethod
        - receiptUrl: string?
        - isInsurable: bool
        - claimStatus: ClaimStatus
        - reimbursementAmount: Money?
        - tags: List<string>
        - createdBy: Guid
        - createdAt: DateTime
        - updatedAt: DateTime
        --
        + RecordExpense(data: ExpenseData): PetExpense
        + UpdateDetails(data: ExpenseData): void
        + AttachReceipt(url: string): void
        + MarkAsInsurable(): void
        + UpdateClaimStatus(status: ClaimStatus): void
        + SetReimbursement(amount: Money): void
        + Delete(): void
        --
        - ValidateAmount(amount: Money): void
        - ValidateDate(date: DateTime): void
        - ValidateInsurability(): void
    }

    class InsuranceClaim <<Entity>> {
        - claimId: Guid
        - petId: Guid
        - policyNumber: string
        - expenses: List<ClaimExpense>
        - totalClaimAmount: Money
        - approvedAmount: Money?
        - deniedAmount: Money?
        - claimType: ClaimType
        - status: ClaimStatus
        - submissionDate: DateTime?
        - settlementDate: DateTime?
        - supportingDocuments: List<Document>
        - insuranceProvider: string
        - contactEmail: string
        - denialReason: string?
        - notes: string?
        - createdBy: Guid
        - createdAt: DateTime
        - updatedAt: DateTime
        --
        + CreateClaim(data: ClaimData): InsuranceClaim
        + AddExpense(expense: PetExpense): void
        + RemoveExpense(expenseId: Guid): void
        + SubmitClaim(): void
        + SettleClaim(settlement: SettlementData): void
        + AddDocument(document: Document): void
        + UpdateStatus(status: ClaimStatus): void
        --
        - ValidateExpenses(): void
        - CalculateTotalAmount(): Money
        - ValidateSubmission(): void
        - ValidateSettlement(settlement: SettlementData): void
        - CanBeEdited(): bool
    }
}

package "Value Objects" {
    class Money <<ValueObject>> {
        - amount: decimal
        - currency: string
        --
        + Money(amount: decimal, currency: string)
        + Add(other: Money): Money
        + Subtract(other: Money): Money
        + Multiply(factor: decimal): Money
        + IsPositive(): bool
        + ToString(): string
        --
        - ValidateCurrency(currency: string): void
    }

    class ClaimExpense <<ValueObject>> {
        - expenseId: Guid
        - requestedAmount: Money
        - approvedAmount: Money?
        - reason: string?
        --
        + ClaimExpense(expenseId: Guid, amount: Money)
        + Approve(amount: Money): void
        + Deny(reason: string): void
        + PartiallyApprove(amount: Money, reason: string): void
    }

    class Document <<ValueObject>> {
        - documentId: Guid
        - documentUrl: string
        - documentType: DocumentType
        - uploadedAt: DateTime
        --
        + Document(url: string, type: DocumentType)
        + IsValid(): bool
    }

    class ExpenseData <<ValueObject>> {
        + petId: Guid
        + amount: decimal
        + currency: string
        + category: ExpenseCategory
        + description: string
        + expenseDate: DateTime
        + vendor: string
        + paymentMethod: PaymentMethod
        + receiptUrl: string?
        + isInsurable: bool
        + tags: List<string>
    }

    class SettlementData <<ValueObject>> {
        + settlementStatus: SettlementStatus
        + approvedAmount: Money
        + deniedAmount: Money
        + settlementDate: DateTime
        + reimbursementMethod: string
        + estimatedPaymentDate: DateTime
        + denialReason: string?
        + adjustments: List<ExpenseAdjustment>
    }

    class ExpenseAdjustment <<ValueObject>> {
        + expenseId: Guid
        + requestedAmount: Money
        + approvedAmount: Money
        + reason: string
    }
}

package "Enums" {
    enum ExpenseCategory <<Enum>> {
        VeterinaryCare
        Food
        Grooming
        Boarding
        Training
        Supplies
        Insurance
        Other
    }

    enum PaymentMethod <<Enum>> {
        Cash
        CreditCard
        DebitCard
        Check
        Other
    }

    enum ClaimStatus <<Enum>> {
        None
        Pending
        Approved
        Denied
        Partial
    }

    enum ClaimType <<Enum>> {
        Illness
        Injury
        WellnessCheckup
        Surgery
        Emergency
        Other
    }

    enum ClaimWorkflowStatus <<Enum>> {
        Draft
        Submitted
        UnderReview
        Approved
        Denied
        PartiallyApproved
        Paid
    }

    enum SettlementStatus <<Enum>> {
        Approved
        Denied
        Partial
    }

    enum DocumentType <<Enum>> {
        Receipt
        Invoice
        MedicalReport
        PolicyDocument
        Other
    }
}

package "Domain Events" {
    abstract class DomainEvent {
        + eventId: Guid
        + eventType: string
        + timestamp: DateTime
        + aggregateId: Guid
        + aggregateType: string
        + version: int
    }

    class PetExpenseRecorded {
        + expenseId: Guid
        + petId: Guid
        + amount: Money
        + category: ExpenseCategory
        + description: string
        + expenseDate: DateTime
        + vendor: string
        + paymentMethod: PaymentMethod
        + receiptUrl: string?
        + isInsurable: bool
        + recordedBy: Guid
        + recordedAt: DateTime
    }

    class InsuranceClaimFiled {
        + claimId: Guid
        + petId: Guid
        + policyNumber: string
        + expenseIds: List<Guid>
        + totalClaimAmount: Money
        + claimType: ClaimType
        + submissionDate: DateTime
        + supportingDocuments: List<string>
        + insuranceProvider: string
        + contactEmail: string
        + filedBy: Guid
        + filedAt: DateTime
    }

    class InsuranceClaimSettled {
        + claimId: Guid
        + settlementStatus: SettlementStatus
        + approvedAmount: Money
        + deniedAmount: Money
        + settlementDate: DateTime
        + reimbursementMethod: string
        + estimatedPaymentDate: DateTime
        + denialReason: string?
        + adjustments: List<ExpenseAdjustment>
        + settledBy: string
        + settledAt: DateTime
    }
}

package "Repositories" {
    interface IExpenseRepository <<Service>> {
        + GetByIdAsync(expenseId: Guid): Task<PetExpense>
        + GetByPetIdAsync(petId: Guid, filters: ExpenseFilters): Task<List<PetExpense>>
        + SaveAsync(expense: PetExpense): Task
        + DeleteAsync(expenseId: Guid): Task
        + GetSummaryAsync(petId: Guid, year: int): Task<ExpenseSummary>
        + GetInsurableExpensesAsync(petId: Guid): Task<List<PetExpense>>
    }

    interface IInsuranceClaimRepository <<Service>> {
        + GetByIdAsync(claimId: Guid): Task<InsuranceClaim>
        + GetByPetIdAsync(petId: Guid, filters: ClaimFilters): Task<List<InsuranceClaim>>
        + SaveAsync(claim: InsuranceClaim): Task
        + GetByStatusAsync(status: ClaimWorkflowStatus): Task<List<InsuranceClaim>>
    }
}

package "Services" {
    class ExpenseService <<Service>> {
        - expenseRepository: IExpenseRepository
        - eventBus: IEventBus
        --
        + RecordExpenseAsync(data: ExpenseData): Task<PetExpense>
        + UpdateExpenseAsync(expenseId: Guid, data: ExpenseData): Task<PetExpense>
        + DeleteExpenseAsync(expenseId: Guid): Task
        + AttachReceiptAsync(expenseId: Guid, file: File): Task<string>
        + GetExpenseSummaryAsync(petId: Guid, year: int): Task<ExpenseSummary>
    }

    class InsuranceClaimService <<Service>> {
        - claimRepository: IInsuranceClaimRepository
        - expenseRepository: IExpenseRepository
        - eventBus: IEventBus
        --
        + CreateClaimAsync(data: ClaimData): Task<InsuranceClaim>
        + AddExpenseToClaimAsync(claimId: Guid, expenseId: Guid): Task
        + SubmitClaimAsync(claimId: Guid): Task<InsuranceClaim>
        + SettleClaimAsync(claimId: Guid, settlement: SettlementData): Task<InsuranceClaim>
        + UploadDocumentAsync(claimId: Guid, file: File): Task<string>
    }

    interface IEventBus <<Service>> {
        + PublishAsync<T>(event: T): Task
        + SubscribeAsync<T>(handler: Func<T, Task>): Task
    }

    class ReceiptStorageService <<Service>> {
        + UploadReceiptAsync(file: File): Task<string>
        + GetReceiptUrlAsync(receiptId: string): Task<string>
        + DeleteReceiptAsync(receiptId: string): Task
    }
}

' Relationships
PetExpense "1" *-- "1" Money : amount
PetExpense "1" o-- "0..1" Money : reimbursementAmount
PetExpense "1" -- "1" ExpenseCategory
PetExpense "1" -- "1" PaymentMethod
PetExpense "1" -- "1" ClaimStatus

InsuranceClaim "1" *-- "many" ClaimExpense : expenses
InsuranceClaim "1" *-- "many" Document : supportingDocuments
InsuranceClaim "1" o-- "0..1" Money : approvedAmount
InsuranceClaim "1" o-- "0..1" Money : deniedAmount
InsuranceClaim "1" -- "1" ClaimType
InsuranceClaim "1" -- "1" ClaimWorkflowStatus : status

ClaimExpense "1" *-- "1" Money : requestedAmount
ClaimExpense "1" o-- "0..1" Money : approvedAmount

Document "1" -- "1" DocumentType

SettlementData "1" *-- "1" Money : approvedAmount
SettlementData "1" *-- "1" Money : deniedAmount
SettlementData "1" *-- "many" ExpenseAdjustment
SettlementData "1" -- "1" SettlementStatus

ExpenseAdjustment "1" *-- "2" Money

DomainEvent <|-- PetExpenseRecorded
DomainEvent <|-- InsuranceClaimFiled
DomainEvent <|-- InsuranceClaimSettled

ExpenseService --> IExpenseRepository : uses
ExpenseService --> IEventBus : publishes events
ExpenseService --> ReceiptStorageService : uses

InsuranceClaimService --> IInsuranceClaimRepository : uses
InsuranceClaimService --> IExpenseRepository : uses
InsuranceClaimService --> IEventBus : publishes events

IExpenseRepository --> PetExpense : manages
IInsuranceClaimRepository --> InsuranceClaim : manages

PetExpense ..> PetExpenseRecorded : raises
InsuranceClaim ..> InsuranceClaimFiled : raises
InsuranceClaim ..> InsuranceClaimSettled : raises

note right of PetExpense
  Aggregate root for expense tracking.
  Enforces business rules:
  - Amount must be positive
  - Date cannot be future
  - Insurable only for certain categories
end note

note right of InsuranceClaim
  Aggregate root for insurance claims.
  Enforces business rules:
  - Must have at least 1 expense
  - All expenses belong to same pet
  - Cannot settle without submission
  - Settlement amount <= claim amount
end note

note bottom of IEventBus
  Event bus for publishing domain events
  to external systems and subscribers
end note

@enduml
