@startuml Expense Management Sequence Diagrams

!define ACTOR_COLOR #4CAF50
!define BOUNDARY_COLOR #2196F3
!define CONTROL_COLOR #FF9800
!define ENTITY_COLOR #9C27B0
!define DATABASE_COLOR #F44336

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

skinparam participant {
    BackgroundColor<<Actor>> ACTOR_COLOR
    BackgroundColor<<Boundary>> BOUNDARY_COLOR
    BackgroundColor<<Control>> CONTROL_COLOR
    BackgroundColor<<Entity>> ENTITY_COLOR
    BackgroundColor<<Database>> DATABASE_COLOR
    BorderColor #000000
}

title Expense Management - Key Interaction Flows

== Flow 1: Record Pet Expense ==

actor "Pet Owner" as owner <<Actor>>
participant "Expense API" as api <<Boundary>>
participant "ExpenseService" as service <<Control>>
participant "PetExpense" as expense <<Entity>>
participant "ExpenseRepository" as repo <<Database>>
participant "ReceiptStorage" as storage <<Control>>
participant "EventBus" as eventbus <<Control>>
database "SQL Database" as db <<Database>>
queue "Message Queue" as queue <<Database>>

owner -> api: POST /api/expenses\n{petId, amount, category, ...}
activate api

api -> api: Validate JWT token
api -> api: Validate request payload

api -> service: RecordExpenseAsync(expenseData)
activate service

service -> expense: RecordExpense(expenseData)
activate expense

expense -> expense: Validate amount > 0
expense -> expense: Validate date not future
expense -> expense: Validate category
expense -> expense: Generate expenseId

expense --> service: PetExpense created
deactivate expense

alt Receipt file provided
    service -> storage: UploadReceiptAsync(file)
    activate storage

    storage -> storage: Validate file type & size
    storage -> storage: Generate unique filename
    storage -> storage: Upload to cloud storage

    storage --> service: receiptUrl
    deactivate storage

    service -> expense: AttachReceipt(receiptUrl)
end

service -> repo: SaveAsync(expense)
activate repo

repo -> db: INSERT INTO Expenses
activate db
db --> repo: Success
deactivate db

repo --> service: Saved
deactivate repo

service -> expense: GetDomainEvents()
activate expense
expense --> service: [PetExpenseRecorded event]
deactivate expense

service -> eventbus: PublishAsync(PetExpenseRecorded)
activate eventbus

eventbus -> queue: Publish event
activate queue
queue --> eventbus: Acknowledged
deactivate queue

eventbus --> service: Published
deactivate eventbus

service --> api: PetExpense
deactivate service

api --> owner: 201 Created\n{expenseId, message}
deactivate api

note right of queue
  PetExpenseRecorded event consumed by:
  - BudgetingService (update budget)
  - AnalyticsService (update statistics)
  - NotificationService (send confirmation)
  - InsuranceService (check eligibility)
end note

|||

== Flow 2: Create and Submit Insurance Claim ==

owner -> api: POST /api/insurance-claims\n{petId, expenseIds[], policyNumber, ...}
activate api

api -> api: Validate JWT token
api -> api: Validate request payload

api -> service: CreateClaimAsync(claimData)
activate service

service -> repo: GetByPetIdAsync(petId)
activate repo
repo -> db: SELECT * FROM Expenses\nWHERE PetId = @petId\nAND ExpenseId IN (@expenseIds)
activate db
db --> repo: Expense rows
deactivate db
repo --> service: List<PetExpense>
deactivate repo

service -> service: Validate all expenses belong to pet
service -> service: Validate expenses are insurable
service -> service: Validate expenses not already claimed

participant "InsuranceClaim" as claim <<Entity>>
participant "ClaimRepository" as claimRepo <<Database>>

service -> claim: CreateClaim(claimData)
activate claim

claim -> claim: Validate policy number
claim -> claim: Add expenses
claim -> claim: Calculate total claim amount
claim -> claim: Set status = Draft
claim -> claim: Generate claimId

claim --> service: InsuranceClaim created
deactivate claim

service -> claimRepo: SaveAsync(claim)
activate claimRepo

claimRepo -> db: INSERT INTO InsuranceClaims
activate db
claimRepo -> db: INSERT INTO ClaimExpenses (junction table)
db --> claimRepo: Success
deactivate db

claimRepo --> service: Saved
deactivate claimRepo

service --> api: InsuranceClaim
deactivate service

api --> owner: 201 Created\n{claimId, status: "Draft"}
deactivate api

|||
|||

owner -> api: POST /api/insurance-claims/{claimId}/documents
activate api
note right: Upload supporting documents

api -> service: UploadDocumentAsync(claimId, file)
activate service

service -> storage: UploadDocumentAsync(file)
activate storage
storage --> service: documentUrl
deactivate storage

service -> claimRepo: GetByIdAsync(claimId)
activate claimRepo
claimRepo --> service: InsuranceClaim
deactivate claimRepo

service -> claim: AddDocument(document)
activate claim
claim --> service: Document added
deactivate claim

service -> claimRepo: SaveAsync(claim)
activate claimRepo
claimRepo -> db: INSERT INTO ClaimDocuments
activate db
db --> claimRepo: Success
deactivate db
claimRepo --> service: Saved
deactivate claimRepo

service --> api: documentUrl
deactivate service

api --> owner: 200 OK\n{documentId, documentUrl}
deactivate api

|||
|||

owner -> api: POST /api/insurance-claims/{claimId}/submit
activate api

api -> service: SubmitClaimAsync(claimId)
activate service

service -> claimRepo: GetByIdAsync(claimId)
activate claimRepo
claimRepo --> service: InsuranceClaim
deactivate claimRepo

service -> claim: SubmitClaim()
activate claim

claim -> claim: Validate has supporting documents
claim -> claim: Validate status = Draft
claim -> claim: Set status = Submitted
claim -> claim: Set submissionDate = now

claim --> service: Claim submitted
deactivate claim

service -> claimRepo: SaveAsync(claim)
activate claimRepo
claimRepo -> db: UPDATE InsuranceClaims\nSET Status = 'Submitted'
activate db
db --> claimRepo: Success
deactivate db
claimRepo --> service: Saved
deactivate claimRepo

service -> claim: GetDomainEvents()
activate claim
claim --> service: [InsuranceClaimFiled event]
deactivate claim

service -> eventbus: PublishAsync(InsuranceClaimFiled)
activate eventbus
eventbus -> queue: Publish event
activate queue
queue --> eventbus: Acknowledged
deactivate queue
eventbus --> service: Published
deactivate eventbus

service --> api: InsuranceClaim
deactivate service

api --> owner: 200 OK\n{claimId, status: "Submitted"}
deactivate api

note right of queue
  InsuranceClaimFiled event consumed by:
  - InsuranceProviderIntegration (submit to provider)
  - NotificationService (send confirmation email)
  - ExpenseService (update expense claim status)
end note

|||

== Flow 3: Settle Insurance Claim (Admin) ==

actor "Admin" as admin <<Actor>>

admin -> api: PUT /api/insurance-claims/{claimId}/settle\n{settlementStatus, approvedAmount, ...}
activate api

api -> api: Validate JWT token
api -> api: Validate admin role

api -> service: SettleClaimAsync(claimId, settlementData)
activate service

service -> claimRepo: GetByIdAsync(claimId)
activate claimRepo
claimRepo --> service: InsuranceClaim
deactivate claimRepo

service -> claim: SettleClaim(settlementData)
activate claim

claim -> claim: Validate status = Submitted
claim -> claim: Validate settlement amount <= total
claim -> claim: Set approvedAmount
claim -> claim: Set deniedAmount
claim -> claim: Set settlementDate
claim -> claim: Set status based on settlement
claim -> claim: Apply adjustments to expenses

claim --> service: Claim settled
deactivate claim

service -> claimRepo: SaveAsync(claim)
activate claimRepo
claimRepo -> db: UPDATE InsuranceClaims
activate db
claimRepo -> db: UPDATE Expenses (set reimbursement)
db --> claimRepo: Success
deactivate db
claimRepo --> service: Saved
deactivate claimRepo

service -> claim: GetDomainEvents()
activate claim
claim --> service: [InsuranceClaimSettled event]
deactivate claim

service -> eventbus: PublishAsync(InsuranceClaimSettled)
activate eventbus
eventbus -> queue: Publish event
activate queue
queue --> eventbus: Acknowledged
deactivate queue
eventbus --> service: Published
deactivate eventbus

service --> api: InsuranceClaim
deactivate service

api --> admin: 200 OK\n{claimId, status, approvedAmount}
deactivate api

note right of queue
  InsuranceClaimSettled event consumed by:
  - ExpenseService (update expense reimbursement)
  - NotificationService (notify pet owner)
  - AnalyticsService (update statistics)
  - PaymentService (trigger reimbursement)
end note

|||

== Flow 4: Event Processing - Update Expense After Claim Settlement ==

participant "ClaimSettledHandler" as handler <<Control>>
participant "ExpenseService2" as expService <<Control>>

queue -> handler: InsuranceClaimSettled event
activate handler

handler -> handler: Extract expense adjustments

loop For each expense in claim
    handler -> expService: UpdateExpenseAsync(expenseId, adjustment)
    activate expService

    expService -> repo: GetByIdAsync(expenseId)
    activate repo
    repo --> expService: PetExpense
    deactivate repo

    expService -> expense: SetReimbursement(approvedAmount)
    activate expense
    expense -> expense: Set reimbursementAmount
    expense -> expense: Update claimStatus
    expense --> expService: Updated
    deactivate expense

    expService -> repo: SaveAsync(expense)
    activate repo
    repo -> db: UPDATE Expenses\nSET ReimbursementAmount = @amount
    activate db
    db --> repo: Success
    deactivate db
    repo --> expService: Saved
    deactivate repo

    expService --> handler: Success
    deactivate expService
end

handler --> queue: Acknowledged
deactivate handler

@enduml
