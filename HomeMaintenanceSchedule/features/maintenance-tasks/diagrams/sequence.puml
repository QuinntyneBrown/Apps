@startuml Maintenance Tasks - Complete Task Sequence Diagram

title Complete Recurring Task Workflow

actor "Homeowner" as user
participant "Task UI" as ui
participant "API Controller" as api
participant "CompleteTaskHandler" as handler
participant "Task Repository" as repo
participant "Task Entity" as task
participant "Event Publisher" as events
participant "Recurrence Service" as recurrence
participant "Notification Service" as notif

autonumber

== Task Completion ==

user -> ui: Click "Complete Task"
activate ui

ui -> ui: Show completion modal
user -> ui: Enter completion data\n(cost, notes, photos)
user -> ui: Click "Complete"

ui -> ui: Validate form data
ui -> api: POST /api/tasks/{id}/complete\n{completionData}
activate api

api -> api: Validate request
api -> handler: Handle(CompleteTaskCommand)
activate handler

handler -> repo: GetByIdAsync(taskId)
activate repo
repo --> handler: Task entity
deactivate repo

handler -> task: Validate task state
activate task
alt Task already completed
    task --> handler: ValidationException
    handler --> api: Error: Task already completed
    api --> ui: 409 Conflict
    ui --> user: Show error message
else Task can be completed
    task -> task: Complete(completionData)
    task -> task: Set CompletedDate
    task -> task: Set ActualCost
    task -> task: Set Status = Completed
    task -> task: Add completion notes
    task -> task: Add photo URLs
    task --> handler: Task updated
    deactivate task

    handler -> repo: UpdateAsync(task)
    activate repo
    repo -> repo: Save to database
    repo --> handler: Success
    deactivate repo

    == Publish Domain Event ==

    handler -> events: Publish(TaskCompletedEvent)
    activate events
    events -> events: Create event\n{taskId, completionDate, cost, notes}
    events --> handler: Event published
    deactivate events

    == Check for Recurrence ==

    alt Task has recurrence pattern
        handler -> task: IsRecurring()?
        activate task
        task --> handler: true
        deactivate task

        handler -> recurrence: CreateNextInstance(task)
        activate recurrence

        recurrence -> recurrence: Calculate next due date
        recurrence -> recurrence: Create new task\n(copy properties, new dates)

        recurrence -> repo: CreateAsync(newTask)
        activate repo
        repo -> repo: Save new task
        repo --> recurrence: New task created
        deactivate repo

        recurrence -> events: Publish(TaskScheduledEvent)
        activate events
        events --> recurrence: Event published
        deactivate events

        recurrence --> handler: Next task instance created
        deactivate recurrence
    end

    == Send Notifications ==

    handler -> notif: SendTaskCompletedNotification(task)
    activate notif
    notif -> notif: Build notification message
    notif -> notif: Send email/push notification
    notif --> handler: Notification sent
    deactivate notif

    alt Service provider was assigned
        handler -> notif: SendProviderRatingRequest(provider, task)
        activate notif
        notif -> notif: Send rating request to homeowner
        notif --> handler: Request sent
        deactivate notif
    end

    handler --> api: Success
    deactivate handler

    api --> ui: 200 OK {updatedTask, nextTask?}
    deactivate api

    ui -> ui: Update task status
    ui -> ui: Show success message
    alt Recurring task
        ui -> ui: Show "Next task scheduled" notification
    end
    ui --> user: Task completed successfully
    deactivate ui
end

== Background Event Handlers ==

group TaskCompletedEvent Handlers [Async]
    events -> events: Update task statistics
    events -> events: Update property maintenance history
    events -> events: Check if seasonal checklist item
    alt Part of seasonal checklist
        events -> events: Mark checklist item complete
        events -> events: Check if all seasonal tasks done
        alt All seasonal tasks completed
            events -> events: Publish(SeasonalPreparationCompletedEvent)
        end
    end
end

group TaskScheduledEvent Handlers [Async]
    events -> notif: Schedule reminders for new task
    activate notif
    notif -> notif: Create reminder jobs\n(7 days, 3 days, 1 day before)
    notif --> events: Reminders scheduled
    deactivate notif

    events -> events: Update dashboard
    events -> events: Sync with external calendar
end

@enduml
