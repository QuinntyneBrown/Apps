@startuml Task Management Class Diagram

!define ENTITY_COLOR #E3F2FD
!define VALUE_OBJECT_COLOR #FFF9C4
!define SERVICE_COLOR #F3E5F5
!define EVENT_COLOR #E8F5E9

' Aggregate Root
class Task <<AggregateRoot>> ENTITY_COLOR {
  - Id: Guid
  - Title: string
  - Description: string
  - ScheduledDate: DateTime
  - DueDate: DateTime
  - CompletedDate: DateTime?
  - Status: TaskStatus
  - Priority: TaskPriority
  - Category: TaskCategory
  - RecurrencePattern: RecurrencePattern
  - RecurrenceInterval: int?
  - EstimatedCost: decimal?
  - ActualCost: decimal?
  - Notes: string
  - PhotoUrls: List<string>
  - PropertyId: Guid
  - AssignedProviderId: Guid?
  - ParentTaskId: Guid?
  --
  + Schedule(title, scheduledDate, dueDate, ...): void
  + Complete(completionDate, notes, actualCost): void
  + Postpone(newDueDate, reason): void
  + MarkAsOverdue(): void
  + Cancel(reason, cancelFutureRecurrences): void
  + UpdateDetails(title, description, ...): void
  + AssignProvider(providerId): void
  + AddPhoto(photoUrl): void
  - RaiseTaskScheduledEvent(): void
  - RaiseTaskCompletedEvent(): void
  - RaiseTaskPostponedEvent(): void
  - RaiseTaskOverdueEvent(): void
  - RaiseTaskCancelledEvent(): void
}

' Value Objects
class TaskStatus <<ValueObject>> VALUE_OBJECT_COLOR {
  {static} + Scheduled: TaskStatus
  {static} + InProgress: TaskStatus
  {static} + Completed: TaskStatus
  {static} + Overdue: TaskStatus
  {static} + Cancelled: TaskStatus
  --
  - value: string
  --
  + ToString(): string
  + Equals(other): bool
}

class TaskPriority <<ValueObject>> VALUE_OBJECT_COLOR {
  {static} + Low: TaskPriority
  {static} + Medium: TaskPriority
  {static} + High: TaskPriority
  {static} + Critical: TaskPriority
  --
  - value: string
  - level: int
  --
  + CompareTo(other): int
  + ToString(): string
}

class TaskCategory <<ValueObject>> VALUE_OBJECT_COLOR {
  {static} + HVAC: TaskCategory
  {static} + Plumbing: TaskCategory
  {static} + Electrical: TaskCategory
  {static} + Landscaping: TaskCategory
  {static} + Appliances: TaskCategory
  {static} + Structural: TaskCategory
  {static} + Cleaning: TaskCategory
  {static} + Safety: TaskCategory
  {static} + Other: TaskCategory
  --
  - value: string
  --
  + ToString(): string
}

class RecurrencePattern <<ValueObject>> VALUE_OBJECT_COLOR {
  {static} + None: RecurrencePattern
  {static} + Daily: RecurrencePattern
  {static} + Weekly: RecurrencePattern
  {static} + Monthly: RecurrencePattern
  {static} + Quarterly: RecurrencePattern
  {static} + Annually: RecurrencePattern
  --
  - value: string
  --
  + CalculateNextOccurrence(currentDate, interval): DateTime
  + ToString(): string
}

' Domain Events
abstract class DomainEvent EVENT_COLOR {
  + EventId: Guid
  + AggregateId: Guid
  + OccurredAt: DateTime
  + UserId: Guid?
}

class TaskScheduledEvent EVENT_COLOR {
  + TaskId: Guid
  + Title: string
  + Description: string
  + ScheduledDate: DateTime
  + DueDate: DateTime
  + Priority: TaskPriority
  + Category: TaskCategory
  + RecurrencePattern: RecurrencePattern
  + RecurrenceInterval: int?
  + PropertyId: Guid
  + AssignedProviderId: Guid?
  + EstimatedCost: decimal?
}

class TaskCompletedEvent EVENT_COLOR {
  + TaskId: Guid
  + CompletionDate: DateTime
  + Notes: string
  + PhotoUrls: List<string>
  + ActualCost: decimal?
  + CompletedByProviderId: Guid?
  + Duration: TimeSpan?
}

class TaskPostponedEvent EVENT_COLOR {
  + TaskId: Guid
  + OriginalDueDate: DateTime
  + NewDueDate: DateTime
  + Reason: string
  + PostponedAt: DateTime
}

class TaskOverdueEvent EVENT_COLOR {
  + TaskId: Guid
  + DueDate: DateTime
  + DaysOverdue: int
  + Priority: TaskPriority
  + PropertyId: Guid
}

class TaskCancelledEvent EVENT_COLOR {
  + TaskId: Guid
  + CancellationDate: DateTime
  + Reason: string
  + CancelFutureRecurrences: bool
}

' Command Handlers
class ScheduleTaskCommandHandler SERVICE_COLOR {
  - taskRepository: ITaskRepository
  - eventPublisher: IEventPublisher
  --
  + Handle(command): Task<Result>
}

class CompleteTaskCommandHandler SERVICE_COLOR {
  - taskRepository: ITaskRepository
  - eventPublisher: IEventPublisher
  --
  + Handle(command): Task<Result>
}

class PostponeTaskCommandHandler SERVICE_COLOR {
  - taskRepository: ITaskRepository
  - eventPublisher: IEventPublisher
  --
  + Handle(command): Task<Result>
}

class CancelTaskCommandHandler SERVICE_COLOR {
  - taskRepository: ITaskRepository
  - eventPublisher: IEventPublisher
  --
  + Handle(command): Task<Result>
}

' Event Handlers
class TaskScheduledEventHandler SERVICE_COLOR {
  - notificationService: INotificationService
  - calendarService: ICalendarService
  --
  + Handle(event): Task
}

class TaskCompletedEventHandler SERVICE_COLOR {
  - notificationService: INotificationService
  - recurringTaskService: IRecurringTaskService
  - analyticsService: IAnalyticsService
  --
  + Handle(event): Task
}

class TaskOverdueEventHandler SERVICE_COLOR {
  - notificationService: INotificationService
  - escalationService: IEscalationService
  --
  + Handle(event): Task
}

' Repositories
interface ITaskRepository SERVICE_COLOR {
  + GetByIdAsync(id): Task<Task>
  + GetAllAsync(filters): Task<List<Task>>
  + GetOverdueTasksAsync(): Task<List<Task>>
  + GetUpcomingTasksAsync(days): Task<List<Task>>
  + AddAsync(task): Task
  + UpdateAsync(task): Task
  + DeleteAsync(id): Task
  + SaveChangesAsync(): Task
}

class TaskRepository SERVICE_COLOR {
  - dbContext: ApplicationDbContext
  --
  + GetByIdAsync(id): Task<Task>
  + GetAllAsync(filters): Task<List<Task>>
  + GetOverdueTasksAsync(): Task<List<Task>>
  + GetUpcomingTasksAsync(days): Task<List<Task>>
  + AddAsync(task): Task
  + UpdateAsync(task): Task
  + DeleteAsync(id): Task
  + SaveChangesAsync(): Task
}

' Services
interface INotificationService SERVICE_COLOR {
  + SendTaskReminderAsync(task): Task
  + SendTaskOverdueAlertAsync(task): Task
  + SendTaskCompletedNotificationAsync(task): Task
}

interface IRecurringTaskService SERVICE_COLOR {
  + GenerateNextInstanceAsync(parentTask): Task<Task>
  + CancelFutureInstancesAsync(parentTaskId): Task
}

' Background Jobs
class OverdueTaskCheckerJob SERVICE_COLOR {
  - taskRepository: ITaskRepository
  - eventPublisher: IEventPublisher
  --
  + ExecuteAsync(): Task
}

class RecurringTaskGeneratorJob SERVICE_COLOR {
  - taskRepository: ITaskRepository
  - recurringTaskService: IRecurringTaskService
  --
  + ExecuteAsync(): Task
}

' Relationships
Task *-- TaskStatus
Task *-- TaskPriority
Task *-- TaskCategory
Task *-- RecurrencePattern
Task ..> DomainEvent : raises

DomainEvent <|-- TaskScheduledEvent
DomainEvent <|-- TaskCompletedEvent
DomainEvent <|-- TaskPostponedEvent
DomainEvent <|-- TaskOverdueEvent
DomainEvent <|-- TaskCancelledEvent

ScheduleTaskCommandHandler --> ITaskRepository : uses
CompleteTaskCommandHandler --> ITaskRepository : uses
PostponeTaskCommandHandler --> ITaskRepository : uses
CancelTaskCommandHandler --> ITaskRepository : uses

ScheduleTaskCommandHandler ..> Task : creates
CompleteTaskCommandHandler ..> Task : modifies
PostponeTaskCommandHandler ..> Task : modifies
CancelTaskCommandHandler ..> Task : modifies

TaskScheduledEventHandler ..> TaskScheduledEvent : handles
TaskCompletedEventHandler ..> TaskCompletedEvent : handles
TaskOverdueEventHandler ..> TaskOverdueEvent : handles

TaskScheduledEventHandler --> INotificationService : uses
TaskCompletedEventHandler --> INotificationService : uses
TaskCompletedEventHandler --> IRecurringTaskService : uses
TaskOverdueEventHandler --> INotificationService : uses

ITaskRepository <|.. TaskRepository : implements

OverdueTaskCheckerJob --> ITaskRepository : uses
RecurringTaskGeneratorJob --> ITaskRepository : uses
RecurringTaskGeneratorJob --> IRecurringTaskService : uses

note right of Task
  Aggregate Root for Task Management
  Encapsulates all business logic
  Raises domain events on state changes
end note

note right of DomainEvent
  All domain events inherit from
  base DomainEvent class
  Contains common event metadata
end note

note bottom of OverdueTaskCheckerJob
  Scheduled Job: Daily at 12:00 AM
  Checks for overdue tasks and
  raises TaskOverdueEvent
end note

@enduml
