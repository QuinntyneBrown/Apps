@startuml Task Management Sequence Diagram - Complete Task Flow

!define ACTOR_COLOR #E3F2FD
!define BOUNDARY_COLOR #FFF9C4
!define CONTROL_COLOR #F3E5F5
!define ENTITY_COLOR #FFE0B2
!define EVENT_COLOR #E8F5E9

title Task Management - Complete Task Workflow

actor "Homeowner" as user ACTOR_COLOR
participant "Task UI" as ui BOUNDARY_COLOR
participant "API Controller" as controller BOUNDARY_COLOR
participant "CompleteTaskHandler" as handler CONTROL_COLOR
participant "Task Repository" as repo ENTITY_COLOR
participant "Task Aggregate" as task ENTITY_COLOR
participant "Event Publisher" as publisher EVENT_COLOR
participant "TaskCompletedHandler" as eventHandler CONTROL_COLOR
participant "Notification Service" as notification CONTROL_COLOR
participant "RecurringTaskService" as recurring CONTROL_COLOR
participant "Analytics Service" as analytics CONTROL_COLOR
database "SQL Server" as db ENTITY_COLOR

autonumber

' User initiates task completion
user -> ui : Click "Complete Task"
activate ui

ui -> ui : Show completion modal
ui -> user : Display form\n(completion date, cost, notes, photos)

user -> ui : Fill completion details\n(actual cost: $22.50, notes, photos)
ui -> ui : Validate form data

ui -> controller : POST /api/tasks/{id}/complete\n{completionData}
activate controller

controller -> controller : Validate JWT token
controller -> controller : Validate request

controller -> handler : Handle(CompleteTaskCommand)
activate handler

' Retrieve task from repository
handler -> repo : GetByIdAsync(taskId)
activate repo

repo -> db : SELECT * FROM Tasks\nWHERE Id = @taskId
activate db
db --> repo : Task data
deactivate db

repo --> handler : Task entity
deactivate repo

' Business logic validation
handler -> handler : Verify task exists
handler -> handler : Verify user authorization

' Complete the task
handler -> task : Complete(completionDate,\nnotes, actualCost, photos)
activate task

task -> task : Validate business rules:\n- Status must be Scheduled/InProgress/Overdue\n- CompletionDate cannot be in future\n- ActualCost must be >= 0

task -> task : Update properties:\n- CompletedDate\n- ActualCost\n- Notes\n- PhotoUrls\n- Status = Completed

task -> task : RaiseTaskCompletedEvent()
task --> task : Create TaskCompletedEvent

deactivate task

' Save changes
handler -> repo : UpdateAsync(task)
activate repo
repo -> db : BEGIN TRANSACTION
activate db

repo -> db : UPDATE Tasks SET\nStatus = 'Completed',\nCompletedDate = @date,\nActualCost = @cost,\nNotes = @notes...

repo -> db : INSERT INTO DomainEvents\n(TaskCompletedEvent)

db --> repo : Success
repo -> db : COMMIT TRANSACTION
deactivate db
deactivate repo

' Publish domain event
handler -> publisher : PublishAsync(TaskCompletedEvent)
activate publisher

publisher -> eventHandler : Handle(TaskCompletedEvent)
activate eventHandler

par Parallel Event Processing

  ' Send notification
  eventHandler -> notification : SendTaskCompletedNotificationAsync(task)
  activate notification
  notification -> notification : Generate notification message
  notification -> user : Email/SMS: "Task completed!"
  deactivate notification

  ' Generate next recurring task if applicable
  eventHandler -> task : Check if recurring task

  alt Is Recurring Task
    eventHandler -> recurring : GenerateNextInstanceAsync(parentTask)
    activate recurring
    recurring -> recurring : Calculate next occurrence date
    recurring -> recurring : Create new Task instance
    recurring -> repo : AddAsync(newTask)
    activate repo
    repo -> db : INSERT INTO Tasks\n(new instance)
    activate db
    db --> repo : Success
    deactivate db
    deactivate repo
    recurring -> publisher : Publish(TaskScheduledEvent)
    recurring --> eventHandler : Next task created
    deactivate recurring
  end

  ' Update analytics
  eventHandler -> analytics : RecordTaskCompletionAsync(event)
  activate analytics
  analytics -> analytics : Calculate metrics:\n- Completion time\n- Cost variance\n- On-time completion
  analytics -> db : UPDATE TaskMetrics
  activate db
  db --> analytics : Success
  deactivate db
  deactivate analytics

  ' If provider was involved, rate provider
  alt Provider Assigned
    eventHandler -> eventHandler : Check if provider assigned
    eventHandler -> publisher : Publish(ProviderServiceCompletedEvent)
  end

end

deactivate eventHandler
deactivate publisher

' Return success response
handler --> controller : Result.Success
deactivate handler

controller --> ui : 200 OK\n{taskId, completedDate}
deactivate controller

' Update UI
ui -> ui : Update task status in state
ui -> ui : Show success notification\n"Task completed successfully!"
ui -> ui : Close completion modal
ui -> ui : Refresh task list

ui --> user : Display success message
deactivate ui

' Real-time update to other clients
publisher -> ui : SignalR: TaskCompleted\n{taskId, completionDate}
ui -> ui : Update UI in real-time

note right of task
  **Domain Events Raised:**
  1. TaskCompletedEvent

  **Business Rules Validated:**
  - Task must be in valid state
  - Completion date <= current date
  - Actual cost >= 0
end note

note right of eventHandler
  **Event Handler Actions:**
  1. Send completion notification
  2. Generate next recurring task
  3. Update analytics/metrics
  4. Trigger provider rating
  5. Update calendar
end note

note right of publisher
  **Event Publication:**
  Events are published to message bus
  Multiple handlers can subscribe
  Ensures loose coupling
end note

@enduml
