@startuml Service Providers - Record Service and Rate Provider Sequence

title Record Service and Rate Provider Workflow

actor "Homeowner" as user
participant "Provider UI" as ui
participant "API Controller" as api
participant "RecordServiceHandler" as handler
participant "Service Repository" as serviceRepo
participant "Provider Repository" as providerRepo
participant "ServiceProvider Entity" as provider
participant "Event Publisher" as events
participant "Rating Service" as ratingService
participant "Notification Service" as notif

autonumber

== Record Service ==

user -> ui: Navigate to provider profile
activate ui
ui -> ui: Display provider details
user -> ui: Click "Record Service"
ui -> ui: Show record service modal

user -> ui: Fill service details\n(date, description, cost)
user -> ui: Upload invoice (optional)
user -> ui: Add photos (optional)
user -> ui: Select rating (1-5 stars)
user -> ui: Write review text
user -> ui: Click "Save Service"

ui -> ui: Validate form data
ui -> api: POST /api/service-providers/{id}/services\n{serviceData}
activate api

api -> api: Validate request
api -> handler: Handle(RecordServiceCommand)
activate handler

handler -> providerRepo: GetByIdAsync(providerId)
activate providerRepo
providerRepo --> handler: ServiceProvider entity
deactivate providerRepo

alt Provider not found
    handler --> api: NotFoundEx ception
    api --> ui: 404 Not Found
    ui --> user: Show error: Provider not found
else Provider exists
    handler -> handler: Create Service entity
    handler -> handler: Set ServiceProviderId
    handler -> handler: Set TaskId (if provided)
    handler -> handler: Set service details

    handler -> serviceRepo: CreateAsync(service)
    activate serviceRepo
    serviceRepo -> serviceRepo: Save to database
    serviceRepo --> handler: Service created
    deactivate serviceRepo

    == Publish Domain Event ==

    handler -> events: Publish(ProviderServiceCompletedEvent)
    activate events
    events -> events: Create event\n{providerId, serviceId, cost, date}
    events --> handler: Event published
    deactivate events

    == Update Rating ==

    alt Rating provided
        handler -> provider: AddService(service)
        activate provider

        provider -> provider: Add to services collection
        provider -> provider: Increment service count

        handler -> ratingService: UpdateProviderRating(provider, newRating)
        activate ratingService

        ratingService -> serviceRepo: GetAllByProvider(providerId)
        activate serviceRepo
        serviceRepo --> ratingService: List of services with ratings
        deactivate serviceRepo

        ratingService -> ratingService: Filter services with ratings
        ratingService -> ratingService: Calculate: SUM(ratings) / COUNT(ratings)
        ratingService -> ratingService: Round to 1 decimal place

        ratingService -> provider: Update AverageRating
        ratingService -> provider: Update ReviewCount

        ratingService --> handler: Rating updated
        deactivate ratingService

        == Publish Rating Event ==

        handler -> events: Publish(ProviderRatedEvent)
        activate events
        events -> events: Create event\n{providerId, serviceId, rating, review}
        events --> handler: Event published
        deactivate events

        provider --> handler: Provider updated
        deactivate provider
    end

    handler -> providerRepo: UpdateAsync(provider)
    activate providerRepo
    providerRepo -> providerRepo: Save changes
    providerRepo --> handler: Success
    deactivate providerRepo

    == Update Task (if applicable) ==

    alt Service linked to task
        handler -> handler: Update task with service info
        handler -> handler: Mark task as completed (optional)
    end

    handler --> api: Success
    deactivate handler

    api --> ui: 200 OK {service, updatedProvider}
    deactivate api

    ui -> ui: Update provider profile
    ui -> ui: Update average rating display
    ui -> ui: Refresh service history
    ui -> ui: Show success message
    ui --> user: Service recorded successfully
    deactivate ui
end

== Background Event Handlers ==

group ProviderServiceCompletedEvent Handlers [Async]
    events -> events: Update provider statistics
    events -> events: Calculate cost trends
    events -> events: Update service frequency metrics

    alt Task was linked
        events -> events: Update task completion status
        events -> events: Link invoice to task
    end
end

group ProviderRatedEvent Handlers [Async]
    events -> notif: Send thank you notification
    activate notif
    notif -> notif: Build notification message
    notif -> notif: Send to user (email/push)
    notif --> events: Notification sent
    deactivate notif

    events -> events: Update provider ranking
    events -> events: Check if rating < 3 stars
    alt Low rating alert
        events -> events: Flag for review
        events -> events: Send alert to property owner
    end

    events -> events: Update preferred provider suggestions
end

@enduml
