@startuml View Economy Dashboard Flow

title View Economy Dashboard Flow

actor User
participant "Economy Dashboard" as Dashboard
participant "Economy Controller" as EconAPI
participant "Economy Service" as EconService
participant "Chart Component" as ChartUI
database "Database" as DB

== Load Economy Dashboard ==
User -> Dashboard: Navigate to /vehicles/{vehicleId}/economy
activate Dashboard

Dashboard -> EconAPI: GET /api/vehicles/{vehicleId}/economy-stats
activate EconAPI
EconAPI -> EconService: GetEconomyStats(vehicleId)
activate EconService
EconService -> DB: Query current average MPG
activate DB
EconService -> DB: Query 7-day average MPG
EconService -> DB: Query 30-day average MPG
EconService -> DB: Query lifetime average MPG
EconService -> DB: Query personal best MPG with date
EconService -> DB: Query EPA rating for vehicle
DB --> EconService: All statistics data
deactivate DB

EconService -> EconService: Calculate trend based on recent data
EconService -> EconService: Compare current average to personal best
EconService -> EconService: Compare current average to EPA rating

EconService --> EconAPI: Economy statistics with comparisons
deactivate EconService
EconAPI --> Dashboard: Statistics data
deactivate EconAPI

Dashboard -> EconAPI: GET /api/vehicles/{vehicleId}/economy-history?period=30days&granularity=daily
activate EconAPI
EconAPI -> EconService: GetEconomyHistory(vehicleId, period, granularity)
activate EconService
EconService -> DB: Query fuel purchases for period
activate DB
DB --> EconService: Purchase history
deactivate DB
EconService -> EconService: Calculate MPG for each data point
EconService -> EconService: Calculate running average
EconService --> EconAPI: Time series data for chart
deactivate EconService
EconAPI --> Dashboard: Chart data points
deactivate EconAPI

Dashboard -> EconAPI: GET /api/vehicles/{vehicleId}/economy-calculations/recent?limit=10
activate EconAPI
EconAPI -> DB: Query recent MPG calculations
activate DB
DB --> EconAPI: Recent calculations
deactivate DB
EconAPI --> Dashboard: Recent MPG list
deactivate EconAPI

Dashboard --> User: Display hero MPG, statistics cards, trend chart, and recent calculations
deactivate Dashboard

== Interact with Chart ==
User -> Dashboard: Select different timeframe
activate Dashboard
Dashboard -> ChartUI: Update timeframe to "3 Months"
activate ChartUI

ChartUI -> EconAPI: GET /api/vehicles/{vehicleId}/economy-history?period=90days&granularity=weekly
activate EconAPI
EconAPI -> EconService: GetEconomyHistory with new parameters
activate EconService
EconService -> DB: Query data for 90 days
activate DB
DB --> EconService: Extended history
deactivate DB
EconService -> EconService: Group by week and calculate averages
EconService --> EconAPI: Weekly data points
deactivate EconService
EconAPI --> ChartUI: Updated chart data
deactivate EconAPI

ChartUI --> User: Smooth transition to new timeframe view
deactivate ChartUI

User -> ChartUI: Tap on data point
activate ChartUI
ChartUI --> User: Show tooltip with detailed information for that date
deactivate ChartUI
deactivate Dashboard

== View MPG History ==
User -> Dashboard: Click "View All History" link
activate Dashboard
Dashboard -> "History Page": Navigate to /vehicles/{vehicleId}/economy/history
activate "History Page"

"History Page" -> EconAPI: GET /api/vehicles/{vehicleId}/economy-history?period=all
activate EconAPI
EconAPI -> EconService: GetEconomyHistory for all time
activate EconService
EconService -> DB: Query all fuel purchases
activate DB
DB --> EconService: Complete purchase history
deactivate DB
EconService -> EconService: Calculate comprehensive statistics
EconService --> EconAPI: Complete history data
deactivate EconService
EconAPI --> "History Page": Full history with insights
deactivate EconAPI

"History Page" --> User: Display detailed chart and statistics table
deactivate "History Page"

User -> "History Page": Apply filters by trip type or date
activate "History Page"
"History Page" -> EconAPI: GET /api/economy-history?tripType={type}&startDate={date}
activate EconAPI
EconAPI -> DB: Query with filters
activate DB
DB --> EconAPI: Filtered data
deactivate DB
EconAPI --> "History Page": Filtered results
deactivate EconAPI
"History Page" --> User: Update chart and table with filtered data
deactivate "History Page"
deactivate Dashboard

== View Insights ==
User -> Dashboard: Scroll to Insights Panel
activate Dashboard
Dashboard -> EconAPI: GET /api/vehicles/{vehicleId}/economy-insights
activate EconAPI
EconAPI -> EconService: GenerateInsights(vehicleId)
activate EconService

EconService -> DB: Query seasonal performance data
activate DB
EconService -> DB: Query trip type performance data
EconService -> DB: Query driving conditions impact
DB --> EconService: Analysis data
deactivate DB

EconService -> EconService: Identify best performing month
EconService -> EconService: Identify worst performing conditions
EconService -> EconService: Calculate improvement trends
EconService -> EconService: Generate recommendations

EconService --> EconAPI: Insights with recommendations
deactivate EconService
EconAPI --> Dashboard: Generated insights
deactivate EconAPI

Dashboard --> User: Display insights panel with actionable recommendations
deactivate Dashboard

== Check Goal Progress ==
User -> Dashboard: View goal progress section
activate Dashboard

alt Goal Exists
    Dashboard -> EconAPI: GET /api/economy-goals/active?vehicleId={id}
    activate EconAPI
    EconAPI -> DB: Query active goal
    activate DB
    DB --> EconAPI: Goal with target and timeframe
    deactivate DB
    EconAPI --> Dashboard: Active goal data
    deactivate EconAPI

    Dashboard -> Dashboard: Calculate progress percentage
    Dashboard -> Dashboard: Calculate days remaining
    Dashboard --> User: Show goal progress bar and status
else No Goal Set
    Dashboard --> User: Show "Set MPG Goal" button
end
deactivate Dashboard

@enduml
