@startuml Configure Alerts and Notifications Flow

title Configure Alerts and Notifications Flow

actor User
participant "Notifications Center" as NotifCenter
participant "Alert Preferences" as Preferences
participant "Notification Controller" as NotifAPI
participant "Notification Service" as NotifService
participant "Alert Service" as AlertService
database "Database" as DB

== View Notifications Center ==
User -> NotifCenter: Navigate to /notifications
activate NotifCenter

NotifCenter -> NotifAPI: GET /api/notifications/unread
activate NotifAPI
NotifAPI -> DB: Query unread notifications
activate DB
DB --> NotifAPI: Unread notifications list
deactivate DB
NotifAPI --> NotifCenter: Unread notifications
deactivate NotifAPI

NotifCenter -> NotifAPI: GET /api/notifications/recent?days=30
activate NotifAPI
NotifAPI -> DB: Query notifications from last 30 days
activate DB
DB --> NotifAPI: Recent notifications
deactivate DB
NotifAPI --> NotifCenter: Notification history
deactivate NotifAPI

NotifCenter --> User: Display active alerts and history

== Filter Notifications by Type ==
User -> NotifCenter: Select category filter
NotifCenter -> NotifCenter: Filter notifications by type
NotifCenter --> User: Display filtered notifications

alt Budget Alerts
    NotifCenter --> User: Show budget threshold notifications
else MPG Alerts
    NotifCenter --> User: Show MPG decline notifications
else Milestone Alerts
    NotifCenter --> User: Show achievement notifications
else Price Alerts
    NotifCenter --> User: Show fuel price spike notifications
end

== Mark Notifications as Read ==
User -> NotifCenter: Click on notification
NotifCenter -> NotifAPI: PUT /api/notifications/{notificationId}/read
activate NotifAPI
NotifAPI -> DB: UPDATE notification set read=true
activate DB
DB --> NotifAPI: Update successful
deactivate DB
NotifAPI --> NotifCenter: Notification marked read
deactivate NotifAPI
NotifCenter --> User: Navigate to related content
deactivate NotifCenter

alt Bulk Mark as Read
    User -> NotifCenter: Click "Mark All as Read"
    activate NotifCenter
    NotifCenter -> NotifAPI: PUT /api/notifications/mark-all-read
    activate NotifAPI
    NotifAPI -> DB: UPDATE all unread notifications
    activate DB
    DB --> NotifAPI: All marked read
    deactivate DB
    NotifAPI --> NotifCenter: Success
    deactivate NotifAPI
    NotifCenter --> User: Clear unread indicators
    deactivate NotifCenter
end

== Configure Alert Preferences ==
User -> NotifCenter: Click "Alert Preferences"
activate NotifCenter
NotifCenter -> Preferences: Navigate to /settings/alerts
deactivate NotifCenter

activate Preferences
Preferences -> NotifAPI: GET /api/alert-preferences
activate NotifAPI
NotifAPI -> DB: Query user alert preferences
activate DB
DB --> NotifAPI: Current preferences
deactivate DB
NotifAPI --> Preferences: Alert configuration
deactivate NotifAPI

Preferences --> User: Display alert settings form

== Toggle Alert Types ==
User -> Preferences: Toggle "Budget Threshold Alerts"
Preferences -> Preferences: Update local state

User -> Preferences: Toggle "MPG Decline Alerts"
Preferences -> Preferences: Update local state

User -> Preferences: Toggle "Fuel Price Spike Alerts"
Preferences -> Preferences: Update local state

User -> Preferences: Toggle "Milestone Achievements"
Preferences -> Preferences: Update local state

User -> Preferences: Toggle "Maintenance Reminders"
Preferences -> Preferences: Update local state

== Configure Delivery Methods ==
User -> Preferences: Select delivery methods
Preferences --> User: Show checkboxes for Push, Email, SMS

User -> Preferences: Enable Push notifications
User -> Preferences: Enable Email notifications
User -> Preferences: Disable SMS notifications

== Customize Thresholds ==
User -> Preferences: Expand "Budget Alert Threshold"
Preferences --> User: Show slider for percentage

User -> Preferences: Adjust to 80 percent
Preferences -> Preferences: Update threshold value

User -> Preferences: Expand "MPG Decline Threshold"
Preferences --> User: Show slider for percentage

User -> Preferences: Adjust to 15 percent decline
Preferences -> Preferences: Update threshold value

User -> Preferences: Expand "Fuel Price Spike Threshold"
Preferences --> User: Show input for dollar amount

User -> Preferences: Enter 0.25 dollars
Preferences -> Preferences: Update price threshold

== Set Quiet Hours ==
User -> Preferences: Enable "Quiet Hours"
Preferences --> User: Show time range selectors

User -> Preferences: Set start time to 10:00 PM
User -> Preferences: Set end time to 7:00 AM
Preferences -> Preferences: Store quiet hours

== Save Preferences ==
User -> Preferences: Click "Save Preferences"

Preferences -> Preferences: Validate all settings

alt Validation Fails
    Preferences --> User: Show validation errors
else Validation Passes
    Preferences -> NotifAPI: PUT /api/alert-preferences
    activate NotifAPI
    NotifAPI -> NotifService: UpdateAlertPreferences(userId, preferences)
    activate NotifService

    NotifService -> DB: BEGIN TRANSACTION
    activate DB

    NotifService -> DB: UPDATE alert_preferences table
    NotifService -> DB: UPDATE delivery_method_preferences
    NotifService -> DB: UPDATE threshold_settings
    NotifService -> DB: UPDATE quiet_hours

    alt Push Notifications Enabled
        NotifService -> NotifService: Register device for push notifications
        NotifService -> DB: UPSERT push_notification_token
    end

    NotifService -> DB: COMMIT TRANSACTION
    DB --> NotifService: Transaction successful
    deactivate DB

    NotifService --> NotifAPI: Preferences updated
    deactivate NotifService
    NotifAPI --> Preferences: 200 OK
    deactivate NotifAPI

    Preferences --> User: Show success message
    deactivate Preferences
end

== Trigger and Deliver Alert ==
note over AlertService
  Background process detects alert condition
end note

activate AlertService
AlertService -> DB: Detect budget threshold exceeded
activate DB
DB --> AlertService: Budget and spending data
deactivate DB

AlertService -> NotifAPI: CreateAlert(alertData)
activate NotifAPI
NotifAPI -> NotifService: CreateAndDeliverAlert(userId, alertType, data)
activate NotifService

NotifService -> DB: Query user alert preferences
activate DB
DB --> NotifService: User preferences
deactivate DB

alt Alert Type is Disabled
    NotifService --> NotifAPI: Alert suppressed
else Alert Type is Enabled
    alt Within Quiet Hours
        NotifService -> DB: Store alert for later delivery
        activate DB
        deactivate DB
        NotifService --> NotifAPI: Alert queued
    else Outside Quiet Hours
        NotifService -> DB: INSERT notification record
        activate DB
        DB --> NotifService: Notification created
        deactivate DB

        alt Push Enabled
            NotifService -> "Push Service": Send push notification
            activate "Push Service"
            "Push Service" --> NotifService: Push sent
            deactivate "Push Service"
        end

        alt Email Enabled
            NotifService -> "Email Service": Send email notification
            activate "Email Service"
            "Email Service" --> NotifService: Email sent
            deactivate "Email Service"
        end

        alt SMS Enabled
            NotifService -> "SMS Service": Send SMS notification
            activate "SMS Service"
            "SMS Service" --> NotifService: SMS sent
            deactivate "SMS Service"
        end

        NotifService --> NotifAPI: Alert delivered
    end
end
deactivate NotifService
NotifAPI --> AlertService: Alert processed
deactivate NotifAPI
deactivate AlertService

== Receive and View Alert ==
User -> "Mobile Device": Receive push notification
activate "Mobile Device"
"Mobile Device" --> User: Display notification banner

User -> "Mobile Device": Tap notification
"Mobile Device" -> NotifCenter: Deep link to notification details
deactivate "Mobile Device"

activate NotifCenter
NotifCenter -> NotifAPI: GET /api/notifications/{notificationId}
activate NotifAPI
NotifAPI -> DB: Query notification details
activate DB
DB --> NotifAPI: Notification data
deactivate DB
NotifAPI --> NotifCenter: Full notification details
deactivate NotifAPI

NotifCenter -> NotifAPI: PUT /api/notifications/{notificationId}/read
activate NotifAPI
NotifAPI -> DB: Mark as read
activate DB
deactivate DB
deactivate NotifAPI

NotifCenter --> User: Display notification with action buttons

alt Dismissable Notification
    User -> NotifCenter: Click "Dismiss"
    NotifCenter -> NotifAPI: PUT /api/notifications/{notificationId}/dismiss
    activate NotifAPI
    NotifAPI -> DB: UPDATE notification dismissed=true
    activate DB
    deactivate DB
    NotifAPI --> NotifCenter: Dismissed
    deactivate NotifAPI
else Actionable Notification
    User -> NotifCenter: Click "View Details"
    NotifCenter -> "Related Page": Navigate to relevant page
end
deactivate NotifCenter

== Test Notifications ==
User -> Preferences: Click "Test Notifications"
activate Preferences
Preferences -> NotifAPI: POST /api/notifications/test
activate NotifAPI
NotifAPI -> NotifService: SendTestNotification(userId)
activate NotifService

NotifService -> DB: Query alert preferences
activate DB
DB --> NotifService: Preferences
deactivate DB

NotifService -> "Push Service": Send test push
activate "Push Service"
"Push Service" --> NotifService: Sent
deactivate "Push Service"

NotifService --> NotifAPI: Test notification sent
deactivate NotifService
NotifAPI --> Preferences: Success
deactivate NotifAPI
Preferences --> User: Show confirmation message
deactivate Preferences

User -> "Mobile Device": Receive test notification
activate "Mobile Device"
"Mobile Device" --> User: Display test notification
deactivate "Mobile Device"

@enduml
