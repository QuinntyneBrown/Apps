@startuml Manage Fuel Budget Flow

title Manage Fuel Budget Flow

actor User
participant "Cost Dashboard" as Dashboard
participant "Budget Modal" as BudgetModal
participant "Budget Controller" as BudgetAPI
participant "Budget Service" as BudgetService
participant "Cost Service" as CostService
database "Database" as DB

== Load Cost Dashboard ==
User -> Dashboard: Navigate to /vehicles/{vehicleId}/costs
activate Dashboard

Dashboard -> BudgetAPI: GET /api/budgets/active?vehicleId={id}
activate BudgetAPI
BudgetAPI -> DB: Query active budget
activate DB
DB --> BudgetAPI: Active budget or null
deactivate DB
BudgetAPI --> Dashboard: Budget data or null
deactivate BudgetAPI

alt Budget Exists
    Dashboard -> CostService: CalculateBudgetStatus(budget)
    activate CostService
    CostService -> DB: Query current period spending
    activate DB
    DB --> CostService: Total spent in period
    deactivate DB

    CostService -> CostService: Calculate percentage used
    CostService -> CostService: Calculate remaining amount
    CostService -> CostService: Calculate days left in period
    CostService -> CostService: Determine budget status color

    CostService --> Dashboard: Budget status with calculations
    deactivate CostService
    Dashboard --> User: Display budget card with progress bar
else No Budget
    Dashboard --> User: Show "Set Budget" button
end

Dashboard -> CostService: GetMonthlySummary(vehicleId)
activate CostService
CostService -> DB: Query current month spending
activate DB
CostService -> DB: Query average cost per gallon
CostService -> DB: Query number of fillups
DB --> CostService: Summary data
deactivate DB
CostService --> Dashboard: Monthly summary
deactivate CostService

Dashboard -> CostService: GetAnnualProjection(vehicleId)
activate CostService
CostService -> DB: Query year-to-date spending
activate DB
CostService -> DB: Query months elapsed
DB --> CostService: YTD data
deactivate DB
CostService -> CostService: Project annual cost
CostService --> Dashboard: Projected annual cost
deactivate CostService

Dashboard -> CostService: CalculateCostPerMile(vehicleId)
activate CostService
CostService -> DB: Query total fuel cost
activate DB
CostService -> DB: Query total miles driven
DB --> CostService: Cost and mileage data
deactivate DB
CostService -> CostService: Divide cost by miles
CostService --> Dashboard: Cost per mile
deactivate CostService

Dashboard --> User: Display all cost statistics and trends
deactivate Dashboard

== Set New Budget ==
User -> Dashboard: Click "Set Budget" button
activate Dashboard
Dashboard --> User: Open Budget Configuration Modal

activate BudgetModal
BudgetModal -> BudgetAPI: GET /api/budgets/suggested?vehicleId={id}
activate BudgetAPI
BudgetAPI -> CostService: CalculateSuggestedBudget(vehicleId)
activate CostService
CostService -> DB: Query last 3 months spending
activate DB
DB --> CostService: Historical spending data
deactivate DB
CostService -> CostService: Calculate average monthly spend
CostService -> CostService: Add 10 percent buffer
CostService --> BudgetAPI: Suggested budget amount
deactivate CostService
BudgetAPI --> BudgetModal: Suggested amount
deactivate BudgetAPI

BudgetModal --> User: Show form with suggested budget
deactivate Dashboard

User -> BudgetModal: Enter budget amount
User -> BudgetModal: Select period type
User -> BudgetModal: Adjust alert threshold slider
User -> BudgetModal: Select start date

BudgetModal -> BudgetModal: Calculate daily spending limit
BudgetModal -> BudgetModal: Generate visual preview
BudgetModal --> User: Display preview of budget constraints

User -> BudgetModal: Click "Set Budget"

BudgetModal -> BudgetModal: Validate amount > 0
BudgetModal -> BudgetModal: Validate period selected

alt Validation Fails
    BudgetModal --> User: Show validation errors
else Validation Passes
    BudgetModal -> BudgetAPI: POST /api/budgets
    activate BudgetAPI
    BudgetAPI -> BudgetService: CreateBudget(budgetData)
    activate BudgetService

    BudgetService -> DB: BEGIN TRANSACTION
    activate DB

    BudgetService -> DB: Deactivate any existing active budgets
    BudgetService -> DB: INSERT new fuel_budget record
    BudgetService -> DB: Calculate period end date
    BudgetService -> DB: Set budget status to active

    BudgetService -> DB: COMMIT TRANSACTION
    DB --> BudgetService: Transaction successful
    deactivate DB

    BudgetService --> BudgetAPI: Created budget
    deactivate BudgetService
    BudgetAPI --> BudgetModal: 201 Created + budget details
    deactivate BudgetAPI

    BudgetModal --> User: Show success message
    deactivate BudgetModal

    BudgetModal -> Dashboard: Close modal and refresh dashboard
    activate Dashboard
    Dashboard -> BudgetAPI: GET /api/budgets/active?vehicleId={id}
    activate BudgetAPI
    BudgetAPI -> DB: Query new active budget
    activate DB
    DB --> BudgetAPI: Budget data
    deactivate DB
    BudgetAPI --> Dashboard: Budget details
    deactivate BudgetAPI
    Dashboard --> User: Display budget card with new budget
    deactivate Dashboard
end

== Monitor Budget Status ==
User -> Dashboard: Add new fuel purchase
activate Dashboard

note right of Dashboard
  This happens after fuel purchase is saved
end note

Dashboard -> BudgetService: CheckBudgetThresholds(vehicleId)
activate BudgetService
BudgetService -> DB: Query active budget
activate DB
BudgetService -> DB: Query current period spending
DB --> BudgetService: Budget and spending data
deactivate DB

BudgetService -> BudgetService: Calculate percentage used

alt 75 Percent Threshold Reached
    BudgetService -> DB: Create budget alert notification
    activate DB
    DB --> BudgetService: Alert created
    deactivate DB
    BudgetService --> Dashboard: Alert triggered
else 90 Percent Threshold Reached
    BudgetService -> DB: Create high priority alert
    activate DB
    DB --> BudgetService: Alert created
    deactivate DB
    BudgetService --> Dashboard: High priority alert
else Budget Exceeded
    BudgetService -> DB: Create critical alert
    activate DB
    DB --> BudgetService: Alert created
    deactivate DB
    BudgetService --> Dashboard: Critical budget exceeded alert
else Under Threshold
    BudgetService --> Dashboard: No alert
end
deactivate BudgetService

Dashboard --> User: Display budget status with any alerts
deactivate Dashboard

== View Budget History ==
User -> Dashboard: Click "View Budget Reports"
activate Dashboard
Dashboard -> "Reports Page": Navigate to /costs/reports
activate "Reports Page"

"Reports Page" -> BudgetAPI: GET /api/budgets/history?vehicleId={id}
activate BudgetAPI
BudgetAPI -> DB: Query all budget periods
activate DB
DB --> BudgetAPI: Historical budgets
deactivate DB
BudgetAPI --> "Reports Page": Budget history
deactivate BudgetAPI

"Reports Page" -> CostService: GetSpendingBreakdown(vehicleId, period)
activate CostService
CostService -> DB: Query spending by fuel grade
activate DB
CostService -> DB: Query spending by station
CostService -> DB: Query spending by trip purpose
DB --> CostService: Breakdown data
deactivate DB
CostService --> "Reports Page": Expense breakdown
deactivate CostService

"Reports Page" --> User: Display spending reports with charts
deactivate "Reports Page"

User -> "Reports Page": Select time period for comparison
activate "Reports Page"
"Reports Page" -> CostService: ComparePeriods(startPeriod, endPeriod)
activate CostService
CostService -> DB: Query spending for both periods
activate DB
DB --> CostService: Comparison data
deactivate DB
CostService -> CostService: Calculate differences and trends
CostService --> "Reports Page": Comparison analysis
deactivate CostService
"Reports Page" --> User: Display period comparison
deactivate "Reports Page"
deactivate Dashboard

== Update Budget ==
User -> Dashboard: Click "Edit Budget"
activate Dashboard
Dashboard --> User: Open edit modal

activate BudgetModal
BudgetModal -> BudgetAPI: GET /api/budgets/active?vehicleId={id}
activate BudgetAPI
BudgetAPI -> DB: Query current budget
activate DB
DB --> BudgetAPI: Budget data
deactivate DB
BudgetAPI --> BudgetModal: Current budget
deactivate BudgetAPI
BudgetModal --> User: Pre-fill form with current values

User -> BudgetModal: Modify budget parameters
User -> BudgetModal: Click "Update Budget"

BudgetModal -> BudgetAPI: PUT /api/budgets/{budgetId}
activate BudgetAPI
BudgetAPI -> BudgetService: UpdateBudget(budgetId, updatedData)
activate BudgetService
BudgetService -> DB: UPDATE fuel_budget record
activate DB
DB --> BudgetService: Update successful
deactivate DB
BudgetService --> BudgetAPI: Updated budget
deactivate BudgetService
BudgetAPI --> BudgetModal: 200 OK
deactivate BudgetAPI
BudgetModal --> User: Show success message
deactivate BudgetModal
Dashboard --> User: Refresh budget display
deactivate Dashboard

@enduml
