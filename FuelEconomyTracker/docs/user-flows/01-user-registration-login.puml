@startuml User Registration and Login Flow
!theme plain
skinparam sequenceMessageAlign center
skinparam BoxPadding 10

title User Registration and Login Flow

actor User
participant "Registration Page" as RegUI
participant "Login Page" as LoginUI
participant "Auth Controller" as AuthAPI
participant "User Service" as UserService
database "Database" as DB

== User Registration ==
User -> RegUI: Navigate to /register
activate RegUI
RegUI --> User: Display registration form

User -> RegUI: Enter username, email, password
RegUI -> RegUI: Validate form inputs

alt Validation Fails
    RegUI --> User: Show validation errors
else Validation Passes
    RegUI -> AuthAPI: POST /api/users
    activate AuthAPI

    AuthAPI -> UserService: CreateUser(userData)
    activate UserService

    UserService -> UserService: Hash password with salt
    UserService -> DB: INSERT user record
    activate DB

    alt Email/Username Already Exists
        DB --> UserService: Constraint violation
        deactivate DB
        UserService --> AuthAPI: Error: User exists
        deactivate UserService
        AuthAPI --> RegUI: 409 Conflict
        deactivate AuthAPI
        RegUI --> User: Display error message
    else Success
        DB --> UserService: User created
        deactivate DB
        UserService --> AuthAPI: User created successfully
        deactivate UserService
        AuthAPI --> RegUI: 201 Created + JWT token
        deactivate AuthAPI
        RegUI -> RegUI: Store JWT token
        RegUI --> User: Show success message and redirect to dashboard
    end
end
deactivate RegUI

== User Login ==
User -> LoginUI: Navigate to /login
activate LoginUI
LoginUI --> User: Display login form

User -> LoginUI: Enter email/username and password
LoginUI -> AuthAPI: POST /api/auth/login
activate AuthAPI

AuthAPI -> UserService: AuthenticateUser(credentials)
activate UserService

UserService -> DB: SELECT user by email
activate DB
DB --> UserService: User record
deactivate DB

UserService -> UserService: Hash provided password with stored salt
UserService -> UserService: Compare password hashes

alt Invalid Credentials
    UserService --> AuthAPI: Authentication failed
    deactivate UserService
    AuthAPI --> LoginUI: 401 Unauthorized
    deactivate AuthAPI
    LoginUI --> User: Display error message
else Valid Credentials
    UserService -> UserService: Generate JWT token with user roles
    UserService --> AuthAPI: JWT token + user data
    deactivate UserService
    AuthAPI --> LoginUI: 200 OK + token + user info
    deactivate AuthAPI
    LoginUI -> LoginUI: Store JWT token in localStorage
    LoginUI --> User: Show welcome message and redirect to dashboard
end
deactivate LoginUI

@enduml
