@startuml Manage User Roles Flow
title Manage User Roles Flow (Add and Remove)

actor "Administrator" as Admin
participant "User Management\nPage (Angular)" as UI
participant "User Service\n(Angular)" as UserService
participant "HTTP Interceptor" as Interceptor
participant "Users Controller\n(/api/users)" as UsersAPI
participant "AddRoleToUserCommand" as AddCmd
participant "RemoveRoleFromUserCommand" as RemoveCmd
database "SQL Database" as DB

== Add Role to User Flow ==

Admin -> UI: Click "Manage Roles" on user row
activate UI

UI -> UserService: getUserById(userId)
activate UserService
UserService -> UsersAPI: GET /api/users/{userId}
activate UsersAPI
UsersAPI -> DB: Query user with roles
activate DB
DB --> UsersAPI: Return user data
deactivate DB
UsersAPI --> UserService: UserDto with current roles
deactivate UsersAPI
UserService --> UI: User data
deactivate UserService

UI -> UserService: getRoles()
activate UserService
UserService -> UsersAPI: GET /api/roles
activate UsersAPI
UsersAPI -> DB: Query all roles
activate DB
DB --> UsersAPI: Return all roles
deactivate DB
UsersAPI --> UserService: List of roles
deactivate UsersAPI
UserService --> UI: Available roles
deactivate UserService

UI -> UI: Show role management dialog\nwith current roles and available roles

Admin -> UI: Select role to add from dropdown
Admin -> UI: Click "Add Role"

UI -> UserService: addRoleToUser(userId, roleId)
activate UserService

UserService -> Interceptor: POST /api/users/{userId}/roles\n{roleId}
activate Interceptor
Interceptor -> Interceptor: Inject JWT token
Interceptor -> UsersAPI: Forward with Authorization header
deactivate Interceptor
activate UsersAPI

UsersAPI -> UsersAPI: Verify Admin role

alt Not Admin
    UsersAPI --> UserService: 403 Forbidden
    deactivate UsersAPI
    UserService --> UI: Failed
    deactivate UserService
    UI --> Admin: Display error
    deactivate UI
else Admin Verified
    UsersAPI -> AddCmd: Execute AddRoleToUserCommand
    activate AddCmd

    AddCmd -> DB: SELECT user by ID
    activate DB
    DB --> AddCmd: Return user or null
    deactivate DB

    alt User Not Found
        AddCmd --> UsersAPI: User not found
        deactivate AddCmd
        UsersAPI --> UserService: 404 Not Found
        deactivate UsersAPI
        UserService --> UI: Failed
        deactivate UserService
        UI --> Admin: Display error
        deactivate UI
    else User Found
        AddCmd -> DB: SELECT role by ID
        activate DB
        DB --> AddCmd: Return role or null
        deactivate DB

        alt Role Not Found
            AddCmd --> UsersAPI: Role not found
            deactivate AddCmd
            UsersAPI --> UserService: 404 Not Found
            deactivate UsersAPI
            UserService --> UI: Failed
            deactivate UserService
            UI --> Admin: Display error
            deactivate UI
        else Role Found
            AddCmd -> DB: Check if user already has role
            activate DB
            DB --> AddCmd: Return existing UserRole or null
            deactivate DB

            alt User Already Has Role
                AddCmd --> UsersAPI: Idempotent success
                note right
                  Adding duplicate role
                  is idempotent - no error
                end note
            else Role Not Assigned
                AddCmd -> DB: INSERT INTO UserRoles\n(userId, roleId)
                activate DB
                DB --> AddCmd: Role added
                deactivate DB
            end

            AddCmd --> UsersAPI: Success
            deactivate AddCmd

            UsersAPI --> UserService: 200 OK
            deactivate UsersAPI

            UserService --> UI: Role added successfully
            deactivate UserService

            UI -> UI: Refresh user roles display
            UI --> Admin: Show success notification
            deactivate UI
        end
    end
end

== Remove Role from User Flow ==

Admin -> UI: Click "Remove" on role badge
activate UI

UI -> UI: Show confirmation dialog

Admin -> UI: Confirm removal

UI -> UserService: removeRoleFromUser(userId, roleId)
activate UserService

UserService -> Interceptor: DELETE /api/users/{userId}/roles/{roleId}
activate Interceptor
Interceptor -> Interceptor: Inject JWT token
Interceptor -> UsersAPI: Forward with Authorization header
deactivate Interceptor
activate UsersAPI

UsersAPI -> UsersAPI: Verify Admin role

alt Not Admin
    UsersAPI --> UserService: 403 Forbidden
    deactivate UsersAPI
    UserService --> UI: Failed
    deactivate UserService
    UI --> Admin: Display error
    deactivate UI
else Admin Verified
    UsersAPI -> RemoveCmd: Execute RemoveRoleFromUserCommand
    activate RemoveCmd

    RemoveCmd -> DB: SELECT user by ID
    activate DB
    DB --> RemoveCmd: Return user or null
    deactivate DB

    alt User Not Found
        RemoveCmd --> UsersAPI: User not found
        deactivate RemoveCmd
        UsersAPI --> UserService: 404 Not Found
        deactivate UsersAPI
        UserService --> UI: Failed
        deactivate UserService
        UI --> Admin: Display error
        deactivate UI
    else User Found
        RemoveCmd -> DB: DELETE FROM UserRoles\nWHERE userId = {userId}\nAND roleId = {roleId}
        activate DB
        DB --> RemoveCmd: Role removed (or no-op if not assigned)
        deactivate DB

        note right
          Removing non-existent role
          is idempotent - no error
        end note

        RemoveCmd --> UsersAPI: Success
        deactivate RemoveCmd

        UsersAPI --> UserService: 204 No Content
        deactivate UsersAPI

        UserService --> UI: Role removed successfully
        deactivate UserService

        UI -> UI: Refresh user roles display
        UI --> Admin: Show success notification
        deactivate UI
    end
end

@enduml
