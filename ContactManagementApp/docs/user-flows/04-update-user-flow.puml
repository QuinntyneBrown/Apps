@startuml Update User Flow
title Update User Flow

actor "Administrator" as Admin
participant "User Management\nPage (Angular)" as UI
participant "User Service\n(Angular)" as UserService
participant "HTTP Interceptor" as Interceptor
participant "Users Controller\n(/api/users)" as UsersAPI
participant "UpdateUserCommand" as Command
participant "Password Hasher" as PasswordHasher
database "SQL Database" as DB

Admin -> UI: Click "Edit" on user row
activate UI

UI -> UserService: getUserById(userId)
activate UserService
UserService -> Interceptor: GET /api/users/{userId}
activate Interceptor
Interceptor -> UsersAPI: Forward request with JWT token
deactivate Interceptor
activate UsersAPI

UsersAPI -> DB: SELECT user by ID
activate DB
DB --> UsersAPI: Return user data
deactivate DB

UsersAPI --> UserService: 200 OK - UserDto
deactivate UsersAPI
UserService --> UI: Return user data
deactivate UserService

UI -> UI: Show edit form pre-filled with user data
Admin -> UI: Modify user details\n(email, username, password)

Admin -> UI: Click "Save" button
UI -> UI: Validate form inputs

alt Validation Failed
    UI --> Admin: Display validation errors
    deactivate UI
else Validation Passed
    UI -> UserService: updateUser(userId, userData)
    activate UserService

    UserService -> Interceptor: PUT /api/users/{userId}\n{email, username, password}
    activate Interceptor

    Interceptor -> Interceptor: Inject JWT token
    Interceptor -> UsersAPI: Forward request with Authorization header
    deactivate Interceptor
    activate UsersAPI

    UsersAPI -> UsersAPI: Verify Admin role

    alt Not Admin Role
        UsersAPI --> UserService: 403 Forbidden
        deactivate UsersAPI
        UserService --> UI: Update failed
        deactivate UserService
        UI --> Admin: Display error: "Admin access required"
        deactivate UI
    else Admin Role Verified
        UsersAPI -> Command: Execute UpdateUserCommand
        activate Command

        Command -> DB: SELECT user by ID
        activate DB
        DB --> Command: Return existing user
        deactivate DB

        alt User Not Found
            Command --> UsersAPI: User not found error
            deactivate Command
            UsersAPI --> UserService: 404 Not Found
            deactivate UsersAPI
            UserService --> UI: Update failed
            deactivate UserService
            UI --> Admin: Display error: "User not found"
            deactivate UI
        else User Found
            alt Email Changed
                Command -> DB: Check email uniqueness
                activate DB
                DB --> Command: Return existing user or null
                deactivate DB

                alt Email Already Used by Another User
                    Command --> UsersAPI: Validation error
                    deactivate Command
                    UsersAPI --> UserService: 400 Bad Request\n{error: "Email already exists"}
                    deactivate UsersAPI
                    UserService --> UI: Update failed
                    deactivate UserService
                    UI --> Admin: Display error message
                    deactivate UI
                end
            end

            alt Password Changed
                Command -> PasswordHasher: HashPassword(newPassword)
                activate PasswordHasher
                PasswordHasher -> PasswordHasher: Generate new 32-byte salt
                PasswordHasher -> PasswordHasher: Hash with PBKDF2-SHA256
                PasswordHasher --> Command: Return (newHash, newSalt)
                deactivate PasswordHasher
            end

            Command -> DB: UPDATE user SET\nemail, username, password_hash, salt\nWHERE userId
            activate DB
            DB --> Command: Update successful
            deactivate DB

            Command --> UsersAPI: Return updated UserDto
            deactivate Command

            UsersAPI --> UserService: 200 OK\n{userId, username, email, roles}
            deactivate UsersAPI

            UserService --> UI: User updated successfully
            deactivate UserService

            UI -> UI: Close form and refresh user list
            UI --> Admin: Show success notification
            deactivate UI
        end
    end
end

@enduml
