@startuml User Login Flow
title User Login Flow

actor "User" as User
participant "Login Page\n(Angular)" as UI
participant "Auth Service\n(Angular)" as AuthService
participant "HTTP Interceptor" as Interceptor
participant "Auth Controller\n(/api/auth)" as AuthAPI
participant "JWT Service" as JWTService
participant "Password Service" as PasswordService
database "SQL Database" as DB

User -> UI: Enter username and password
activate UI

UI -> UI: Validate form inputs
UI -> AuthService: login(username, password)
activate AuthService

AuthService -> Interceptor: POST /api/auth/login
activate Interceptor
Interceptor -> AuthAPI: Forward request
deactivate Interceptor
activate AuthAPI

AuthAPI -> DB: Query user by username
activate DB
DB --> AuthAPI: Return user entity (with salt and hash)
deactivate DB

AuthAPI -> PasswordService: VerifyPassword(password, hash, salt)
activate PasswordService
PasswordService -> PasswordService: Hash password with salt
PasswordService --> AuthAPI: Return validation result
deactivate PasswordService

alt Valid Credentials
    AuthAPI -> JWTService: GenerateToken(user)
    activate JWTService
    JWTService -> JWTService: Create claims (sub, name, email, roles)
    JWTService -> JWTService: Sign with HS256
    JWTService --> AuthAPI: Return JWT token
    deactivate JWTService

    AuthAPI --> AuthService: 200 OK\n{token, expiresAt, user}
    deactivate AuthAPI

    AuthService -> AuthService: Store token in localStorage
    AuthService --> UI: Login success
    deactivate AuthService

    UI -> UI: Redirect to dashboard
    UI --> User: Show dashboard
    deactivate UI

else Invalid Credentials
    AuthAPI --> AuthService: 401 Unauthorized\n{error: "Invalid username or password"}
    deactivate AuthAPI

    AuthService --> UI: Login failed
    deactivate AuthService

    UI --> User: Display error message
    deactivate UI
end

@enduml
