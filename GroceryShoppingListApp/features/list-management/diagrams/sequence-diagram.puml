@startuml List Management - Sequence Diagram

title Create and Share Shopping List Flow

actor "User" as user
participant "Frontend\nApp" as frontend
participant "API\nGateway" as api
participant "List\nManagement\nService" as service
participant "List\nRepository" as repo
participant "Event\nPublisher" as events
participant "User\nService" as userService
participant "Notification\nService" as notifications
database "Database" as db

== Create Shopping List ==

user -> frontend : Click "New List"
activate frontend

frontend -> frontend : Show Create List Modal
user -> frontend : Enter list details\n(name, tags, recurring)
user -> frontend : Click "Create"

frontend -> api : POST /api/shopping-lists\n{name, tags, isRecurring, recurringPattern}
activate api

api -> api : Validate JWT token
api -> api : Extract userId

api -> service : createList(request, userId)
activate service

service -> service : Validate request
service -> service : Create ShoppingList entity

service -> repo : save(shoppingList)
activate repo

repo -> db : INSERT INTO shopping_lists
activate db
db --> repo : Success
deactivate db

repo --> service : ShoppingList saved
deactivate repo

service -> events : publish(ShoppingListCreated)
activate events

events -> events : Queue event for processing
events --> service : Event published
deactivate events

service --> api : ListResponse
deactivate service

api --> frontend : 201 Created\n{listId, name, ownerId, createdAt}
deactivate api

frontend -> frontend : Update UI with new list
frontend -> user : Show success message
deactivate frontend

== Share Shopping List ==

user -> frontend : Click "Share" on list
activate frontend

frontend -> frontend : Show Share Modal
user -> frontend : Enter user emails\nSelect permission level
user -> frontend : Click "Share"

frontend -> api : POST /api/shopping-lists/{listId}/share\n{userIds, permissionLevel}
activate api

api -> api : Validate JWT token
api -> api : Verify user is list owner

api -> service : shareList(listId, shareRequest, userId)
activate service

service -> repo : findById(listId)
activate repo
repo -> db : SELECT * FROM shopping_lists
activate db
db --> repo : ShoppingList data
deactivate db
repo --> service : ShoppingList
deactivate repo

service -> service : Verify user is owner

loop For each userId to share with
    service -> userService : validateUser(userId)
    activate userService
    userService -> userService : Check user exists
    userService --> service : User valid
    deactivate userService

    service -> service : Create ListShare entity

    service -> repo : saveShare(listShare)
    activate repo
    repo -> db : INSERT INTO list_shares
    activate db
    db --> repo : Success
    deactivate db
    repo --> service : Share saved
    deactivate repo
end

service -> events : publish(ListShared)
activate events

events -> notifications : Send share notifications
activate notifications
notifications -> notifications : Queue notification\nfor each shared user
notifications --> events : Notifications queued
deactivate notifications

events --> service : Event published
deactivate events

service --> api : Success
deactivate service

api --> frontend : 200 OK
deactivate api

frontend -> frontend : Update shared users list
frontend -> user : Show "List shared successfully"
deactivate frontend

== Complete Shopping List ==

user -> frontend : Mark all items purchased
activate frontend

frontend -> frontend : Detect all items complete
frontend -> api : POST /api/shopping-lists/{listId}/complete
activate api

api -> service : completeList(listId, userId)
activate service

service -> repo : findById(listId)
activate repo
repo -> db : SELECT * FROM shopping_lists
activate db
db --> repo : ShoppingList data
deactivate db
repo --> service : ShoppingList
deactivate repo

service -> service : Calculate total spent
service -> service : Mark as completed

service -> repo : update(shoppingList)
activate repo
repo -> db : UPDATE shopping_lists\nSET status='completed',\ncompleted_at=NOW(),\ntotal_spent=?
activate db
db --> repo : Success
deactivate db
repo --> service : Updated
deactivate repo

service -> events : publish(ListCompleted)
activate events

events -> notifications : Send completion notification
activate notifications
notifications --> events : Notification sent
deactivate notifications

events --> service : Event published
deactivate events

service --> api : Success
deactivate service

api --> frontend : 200 OK\n{totalItems, totalSpent, completedAt}
deactivate api

frontend -> frontend : Show completion summary
frontend -> user : Display "Shopping complete!"
deactivate frontend

@enduml
