@startuml Item Management - Class Diagram

!define ENTITY_COLOR #E1F5FE
!define VALUE_OBJECT_COLOR #FFF9C4
!define SERVICE_COLOR #C8E6C9
!define EVENT_COLOR #FFCCBC

package "Item Management Domain" {

    class ShoppingListItem <<Entity>> ENTITY_COLOR {
        - itemId: UUID
        - listId: UUID
        - name: String
        - quantity: Integer
        - unit: String
        - category: Category
        - status: ItemStatus
        - estimatedPrice: Money
        - actualPrice: Money
        - notes: String
        - addedBy: UUID
        - addedAt: DateTime
        - updatedAt: DateTime
        - purchasedAt: DateTime
        - purchasedBy: UUID
        - purchasedQuantity: Integer
        - sortOrder: Integer
        - isUnavailable: Boolean
        - unavailableReason: String
        + create(name, listId, quantity): ShoppingListItem
        + updateQuantity(newQuantity): void
        + markPurchased(actualPrice, purchasedBy): void
        + undoPurchase(): void
        + markUnavailable(reason): void
        + remove(): void
        + updateDetails(name, quantity, unit, category): void
    }

    enum ItemStatus ENTITY_COLOR {
        PENDING
        PURCHASED
        UNAVAILABLE
        REMOVED
    }

    class Money <<Value Object>> VALUE_OBJECT_COLOR {
        - amount: Decimal
        - currency: String
        + add(other): Money
        + subtract(other): Money
        + multiply(factor): Money
        + isGreaterThan(other): Boolean
        + toString(): String
    }

    class ItemCategory <<Entity>> ENTITY_COLOR {
        - categoryId: UUID
        - name: String
        - icon: String
        - color: String
        - sortOrder: Integer
        + create(name, icon): ItemCategory
        + updateSortOrder(order): void
    }

    class ItemQuantity <<Value Object>> VALUE_OBJECT_COLOR {
        - amount: Integer
        - unit: String
        + increase(amount): ItemQuantity
        + decrease(amount): ItemQuantity
        + isValid(): Boolean
        + toString(): String
    }

    class ItemHistory <<Entity>> ENTITY_COLOR {
        - historyId: UUID
        - userId: UUID
        - itemName: String
        - category: String
        - unit: String
        - pricePaid: Money
        - storeName: String
        - purchasedAt: DateTime
        + record(item, price, store): ItemHistory
    }

    class ItemSuggestion <<Value Object>> VALUE_OBJECT_COLOR {
        - name: String
        - category: String
        - averagePrice: Money
        - commonUnit: String
        - frequency: Integer
        + getConfidence(): Float
    }
}

package "Services" {

    class ItemManagementService <<Service>> SERVICE_COLOR {
        - itemRepository: IItemRepository
        - categoryRepository: ICategoryRepository
        - historyRepository: IHistoryRepository
        - eventPublisher: IEventPublisher
        - suggestionEngine: ISuggestionEngine
        + addItem(listId, itemData): ShoppingListItem
        + addMultipleItems(listId, items): List<ShoppingListItem>
        + updateItem(itemId, updates): ShoppingListItem
        + updateQuantity(itemId, quantity): void
        + markPurchased(itemId, purchaseData): void
        + markUnavailable(itemId, reason): void
        + undoPurchase(itemId): void
        + removeItem(itemId, reason): void
        + getItemsByList(listId, filters): List<ShoppingListItem>
        + getSuggestions(query, userId): List<ItemSuggestion>
        + reorderItems(listId, itemOrder): void
    }

    interface IItemRepository {
        + save(item): void
        + findById(itemId): ShoppingListItem
        + findByListId(listId): List<ShoppingListItem>
        + delete(itemId): void
        + bulkSave(items): void
    }

    interface ICategoryRepository {
        + findAll(): List<ItemCategory>
        + findByName(name): ItemCategory
        + save(category): void
    }

    interface IHistoryRepository {
        + save(history): void
        + findByUserId(userId): List<ItemHistory>
        + findByItemName(userId, itemName): List<ItemHistory>
    }

    interface ISuggestionEngine {
        + generateSuggestions(query, userId): List<ItemSuggestion>
        + recordPurchase(itemHistory): void
    }

    interface IEventPublisher {
        + publish(event): void
    }

    class DuplicateItemHandler <<Service>> SERVICE_COLOR {
        + checkForDuplicate(listId, itemName): ShoppingListItem
        + mergeItems(existingItem, newQuantity): void
    }
}

package "Domain Events" {

    abstract class DomainEvent EVENT_COLOR {
        - eventId: UUID
        - occurredAt: DateTime
        - aggregateId: UUID
    }

    class ItemAddedToList EVENT_COLOR {
        - itemId: UUID
        - listId: UUID
        - userId: UUID
        - itemName: String
        - quantity: Integer
        - unit: String
        - category: String
        - estimatedPrice: Decimal
        - addedAt: DateTime
    }

    class ItemQuantityUpdated EVENT_COLOR {
        - itemId: UUID
        - listId: UUID
        - userId: UUID
        - oldQuantity: Integer
        - newQuantity: Integer
        - updatedAt: DateTime
    }

    class ItemMarkedPurchased EVENT_COLOR {
        - itemId: UUID
        - listId: UUID
        - userId: UUID
        - purchasedAt: DateTime
        - actualPrice: Decimal
        - storeName: String
        - purchasedQuantity: Integer
    }

    class ItemMarkedUnavailable EVENT_COLOR {
        - itemId: UUID
        - listId: UUID
        - userId: UUID
        - storeName: String
        - markedAt: DateTime
        - reason: String
    }

    class ItemRemoved EVENT_COLOR {
        - itemId: UUID
        - listId: UUID
        - userId: UUID
        - removedAt: DateTime
        - reason: String
    }
}

package "DTOs" {

    class AddItemRequest {
        + name: String
        + quantity: Integer
        + unit: String
        + category: String
        + estimatedPrice: Decimal
        + notes: String
    }

    class UpdateItemRequest {
        + name: String
        + quantity: Integer
        + unit: String
        + category: String
        + estimatedPrice: Decimal
        + notes: String
    }

    class MarkPurchasedRequest {
        + actualPrice: Decimal
        + purchasedQuantity: Integer
        + storeName: String
    }

    class ItemResponse {
        + itemId: UUID
        + name: String
        + quantity: Integer
        + unit: String
        + category: String
        + status: String
        + estimatedPrice: Decimal
        + actualPrice: Decimal
        + addedAt: DateTime
    }
}

' Relationships
ShoppingListItem -- ItemStatus
ShoppingListItem "1" -- "1" Money : estimatedPrice
ShoppingListItem "1" -- "1" Money : actualPrice
ShoppingListItem "1" -- "1" ItemQuantity
ShoppingListItem "*" -- "1" ItemCategory

ItemManagementService --> IItemRepository : uses
ItemManagementService --> ICategoryRepository : uses
ItemManagementService --> IHistoryRepository : uses
ItemManagementService --> ISuggestionEngine : uses
ItemManagementService --> IEventPublisher : uses
ItemManagementService --> DuplicateItemHandler : uses
ItemManagementService --> ShoppingListItem : manages

ISuggestionEngine --> ItemSuggestion : generates
IHistoryRepository --> ItemHistory : manages

DomainEvent <|-- ItemAddedToList
DomainEvent <|-- ItemQuantityUpdated
DomainEvent <|-- ItemMarkedPurchased
DomainEvent <|-- ItemMarkedUnavailable
DomainEvent <|-- ItemRemoved

ItemManagementService ..> AddItemRequest : receives
ItemManagementService ..> UpdateItemRequest : receives
ItemManagementService ..> MarkPurchasedRequest : receives
ItemManagementService ..> ItemResponse : returns

@enduml
