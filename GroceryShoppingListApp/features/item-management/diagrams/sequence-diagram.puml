@startuml Item Management - Sequence Diagram

title Add Item and Mark as Purchased Flow

actor "User" as user
participant "Frontend\nApp" as frontend
participant "API\nGateway" as api
participant "Item\nManagement\nService" as service
participant "Suggestion\nEngine" as suggestions
participant "Duplicate\nHandler" as duplicate
participant "Item\nRepository" as repo
participant "Event\nPublisher" as events
participant "History\nRepository" as history
database "Database" as db

== Get Item Suggestions (As User Types) ==

user -> frontend : Type "app" in item input
activate frontend

frontend -> api : GET /api/items/suggestions?query=app
activate api

api -> suggestions : generateSuggestions("app", userId)
activate suggestions

suggestions -> history : findByItemName(userId, "app")
activate history
history -> db : SELECT * FROM item_history\nWHERE item_name LIKE '%app%'
activate db
db --> history : Historical data
deactivate db
history --> suggestions : Purchase history
deactivate history

suggestions -> suggestions : Calculate suggestions\n(apples, apple juice, etc.)
suggestions --> api : List<ItemSuggestion>
deactivate suggestions

api --> frontend : 200 OK\n{suggestions: [...]}
deactivate api

frontend -> frontend : Show autocomplete dropdown
frontend -> user : Display suggestions
deactivate frontend

== Add Item to List ==

user -> frontend : Select "Apples" suggestion\nor enter manually
activate frontend

frontend -> frontend : Fill form with suggestion data\n(name, category, avg price)

user -> frontend : Set quantity to 2 lbs\nClick "Add"

frontend -> frontend : Optimistic UI update\n(add item to local state)

frontend -> api : POST /api/shopping-lists/{listId}/items\n{name:"Apples", quantity:2, unit:"lbs"}
activate api

api -> api : Validate JWT token
api -> api : Check user permissions

api -> service : addItem(listId, itemData, userId)
activate service

service -> duplicate : checkForDuplicate(listId, "Apples")
activate duplicate

duplicate -> repo : findByListIdAndName(listId, "Apples")
activate repo
repo -> db : SELECT * FROM shopping_list_items\nWHERE list_id=? AND name=?
activate db
db --> repo : No existing item
deactivate db
repo --> duplicate : null
deactivate repo

duplicate --> service : No duplicate found
deactivate duplicate

service -> service : Create ShoppingListItem entity

service -> repo : save(item)
activate repo
repo -> db : INSERT INTO shopping_list_items
activate db
db --> repo : Item inserted
deactivate db
repo --> service : ShoppingListItem saved
deactivate repo

service -> events : publish(ItemAddedToList)
activate events
events -> events : Queue event
events --> service : Event published
deactivate events

service --> api : ItemResponse
deactivate service

api --> frontend : 201 Created\n{itemId, name, quantity, ...}
deactivate api

frontend -> frontend : Update UI with server response\n(replace optimistic item)
frontend -> user : Show "Item added" notification
deactivate frontend

== Mark Item as Purchased (During Shopping) ==

user -> frontend : Tap checkbox next to "Apples"
activate frontend

frontend -> frontend : Show purchase dialog
user -> frontend : Enter actual price $4.25\nEnter store "Walmart"\nClick "Mark Purchased"

frontend -> frontend : Optimistic UI update\n(strikethrough, dimmed)

frontend -> api : POST /api/shopping-lists/{listId}/items/{itemId}/purchase\n{actualPrice: 4.25, storeName: "Walmart"}
activate api

api -> service : markPurchased(itemId, purchaseData, userId)
activate service

service -> repo : findById(itemId)
activate repo
repo -> db : SELECT * FROM shopping_list_items
activate db
db --> repo : Item data
deactivate db
repo --> service : ShoppingListItem
deactivate repo

service -> service : Validate item is in pending status
service -> service : Update item status to PURCHASED\nSet actualPrice, purchasedAt

service -> repo : update(item)
activate repo
repo -> db : UPDATE shopping_list_items\nSET status='purchased',\nactual_price=4.25,\npurchased_at=NOW()
activate db
db --> repo : Updated
deactivate db
repo --> service : Success
deactivate repo

service -> history : save(ItemHistory)
activate history
history -> db : INSERT INTO item_history\n(user_id, item_name, price_paid, store_name)
activate db
db --> history : History recorded
deactivate db
history --> service : Success
deactivate history

service -> events : publish(ItemMarkedPurchased)
activate events

events -> events : Queue event
events --> service : Event published
deactivate events

service -> service : Check if all items purchased
service -> service : Calculate list progress

alt All items purchased
    service -> events : publish(ListCompleted)
    activate events
    events --> service : Event published
    deactivate events
end

service --> api : Success
deactivate service

api --> frontend : 200 OK\n{item, listProgress: 75%}
deactivate api

frontend -> frontend : Update progress bar\nUpdate item styling
frontend -> user : Show "Item purchased" feedback\nUpdate list progress to 75%
deactivate frontend

== Real-time Sync (Collaborative Shopping) ==

note over events
  ItemMarkedPurchased event
  triggers real-time sync
end note

events -> frontend : WebSocket push\n(other users on same list)
activate frontend

frontend -> frontend : Update item status\nShow "[User] purchased Apples"
frontend -> user : Real-time notification
deactivate frontend

@enduml
