@startuml
title Real-time Updates - Collaboration User Flow

actor "User A\n(Alice)" as Alice
participant "Alice's Browser\nListDetail Component" as AliceUI
participant "Alice's\nWebSocket Client" as AliceWS
participant "WebSocket Server\n/ws/lists/{listId}" as WSServer
participant "Redis\nPub/Sub" as Redis
participant "Alice's\nRedux Store" as AliceRedux
participant "API Server" as API
database "Database" as DB
participant "Bob's\nRedux Store" as BobRedux
participant "Bob's\nWebSocket Client" as BobWS
participant "Bob's Browser\nListDetail Component" as BobUI
actor "User B\n(Bob)" as Bob

== Establish WebSocket Connections ==

Alice -> AliceUI: Open shared list page
activate AliceUI

AliceUI -> AliceWS: Connect to WebSocket
activate AliceWS

AliceWS -> WSServer: WS Connect\n/ws/lists/{listId}?userId={aliceId}
activate WSServer

WSServer -> WSServer: Authenticate user\n& verify list access

WSServer -> Redis: PUBLISH list:{listId}\n{\n  type: 'user.joined',\n  userId: aliceId,\n  userName: 'Alice'\n}
activate Redis

WSServer --> AliceWS: Connection established

AliceWS --> AliceUI: Connected
deactivate AliceWS

AliceUI -> AliceRedux: Set connection status:\nconnected = true
activate AliceRedux
deactivate AliceRedux

AliceUI --> Alice: Show online indicator

note over Bob, BobUI
  Bob is already viewing
  the same list
end note

activate BobUI
activate BobWS

Redis -> BobWS: Receive message:\n'Alice joined'
deactivate Redis

BobWS -> BobRedux: Update presence:\nAdd Alice to activeUsers
activate BobRedux
deactivate BobRedux

BobWS -> BobUI: User joined event
BobUI --> Bob: Show presence:\nðŸ‘¤ Alice is viewing (online)

deactivate AliceUI

== Alice Adds Item (Real-time Sync) ==

Alice -> AliceUI: Add item: "Bread"
activate AliceUI

AliceUI -> AliceRedux: Dispatch addItem(listId, {\n  name: "Bread",\n  quantity: 1\n})
activate AliceRedux

AliceRedux --> AliceUI: Optimistic update:\nShow "Bread" immediately

AliceUI --> Alice: Item appears in list\n(with sync indicator)

AliceRedux -> API: POST /api/lists/{listId}/items
activate API

API -> DB: INSERT INTO list_items
activate DB
DB --> API: Item created (itemId)
deactivate DB

API -> Redis: PUBLISH list:{listId}\n{\n  type: 'item.added',\n  item: {\n    itemId, name: "Bread",\n    quantity: 1, addedBy: "Alice"\n  }\n}
activate Redis

API --> AliceRedux: 201 Created\n{ itemId, ... }
deactivate API

AliceRedux -> AliceRedux: Confirm optimistic update\n(add server itemId)

AliceRedux --> AliceUI: Success
deactivate AliceRedux

AliceUI --> Alice: Remove sync indicator\n(item confirmed)

deactivate AliceUI

== Bob Receives Real-time Update ==

Redis --> BobWS: Broadcast message:\n{\n  type: 'item.added',\n  item: {...},\n  user: 'Alice'\n}
deactivate Redis

activate BobWS

BobWS -> BobRedux: Dispatch remoteItemAdded(item)
activate BobRedux

BobRedux -> BobRedux: Add "Bread" to items

BobRedux --> BobUI: Update item list
deactivate BobRedux

deactivate BobWS

activate BobUI

BobUI -> BobUI: Animate new item:\n- Highlight with color\n- Slide in animation\n- Show "Alice added" label

BobUI --> Bob: Show notification toast:\n"Alice added Bread to the list"

BobUI -> BobUI: Clear highlight after 3s

deactivate BobUI

== Bob Purchases Item (Real-time Sync) ==

Bob -> BobUI: Check off "Bread"
activate BobUI

BobUI -> BobRedux: Dispatch markPurchased(itemId)
activate BobRedux

BobRedux --> BobUI: Optimistic update:\nâœ“ Check & strikethrough

BobUI --> Bob: Visual feedback

BobRedux -> API: PUT /api/items/{itemId}/purchase
activate API

API -> DB: UPDATE list_items\nSET status = 'purchased'
activate DB
DB --> API: Updated
deactivate DB

API -> Redis: PUBLISH list:{listId}\n{\n  type: 'item.purchased',\n  itemId,\n  purchasedBy: "Bob"\n}
activate Redis

API --> BobRedux: 200 OK
deactivate API

BobRedux --> BobUI: Confirmed
deactivate BobRedux

deactivate BobUI

== Alice Sees Bob's Purchase ==

Redis --> AliceWS: Broadcast message:\n{\n  type: 'item.purchased',\n  itemId,\n  user: 'Bob'\n}
deactivate Redis

activate AliceWS

AliceWS -> AliceRedux: Dispatch remoteItemPurchased(itemId)
activate AliceRedux

AliceRedux -> AliceRedux: Update item status:\nstatus = 'purchased'

AliceRedux --> AliceUI: Update item
deactivate AliceRedux

deactivate AliceWS

activate AliceUI

AliceUI -> AliceUI: Animate purchase:\n- Checkbox animation\n- Strikethrough effect\n- Brief highlight

AliceUI --> Alice: Show notification:\n"Bob purchased Bread"

AliceUI -> AliceUI: Update progress bar:\nâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 8/10 (80%)

deactivate AliceUI

== Typing Indicator ==

Alice -> AliceUI: Start typing in\nQuickAdd input
activate AliceUI

AliceUI -> AliceWS: Send typing indicator
activate AliceWS

AliceWS -> WSServer: WS message:\n{\n  type: 'user.typing',\n  userId: aliceId\n}
activate WSServer

WSServer -> Redis: PUBLISH list:{listId}\n{ type: 'user.typing', user: 'Alice' }
activate Redis

Redis --> BobWS: Broadcast typing event
deactivate Redis

deactivate WSServer
deactivate AliceWS

activate BobWS

BobWS -> BobRedux: Update presence:\ntypingUsers.add('Alice')
activate BobRedux
deactivate BobRedux

BobWS -> BobUI: Typing event
deactivate BobWS

activate BobUI

BobUI --> Bob: Show typing indicator:\n"âœ Alice is typing..."

deactivate BobUI

note over Alice, AliceUI
  After 2 seconds of no typing,
  stop typing indicator
end note

AliceUI -> AliceWS: Send stop typing
activate AliceWS

AliceWS -> WSServer: WS message:\n{ type: 'user.stopped_typing' }
activate WSServer

WSServer -> Redis: Broadcast stop typing
activate Redis

Redis --> BobWS: Stop typing event
deactivate Redis

deactivate WSServer
deactivate AliceWS

activate BobWS

BobWS -> BobRedux: Update:\ntypingUsers.remove('Alice')
activate BobRedux
deactivate BobRedux

BobWS -> BobUI: Clear typing indicator
deactivate BobWS

activate BobUI

BobUI --> Bob: Remove "Alice is typing..."

deactivate BobUI
deactivate AliceUI

== Presence: User Leaves ==

Bob -> BobUI: Close list page\nor navigate away
activate BobUI

BobUI -> BobWS: Disconnect WebSocket
activate BobWS

BobWS -> WSServer: WS Close
activate WSServer

WSServer -> Redis: PUBLISH list:{listId}\n{\n  type: 'user.left',\n  userId: bobId,\n  userName: 'Bob',\n  lastSeen: NOW()\n}
activate Redis

WSServer --> BobWS: Disconnected
deactivate WSServer
deactivate BobWS

deactivate BobUI

Redis --> AliceWS: Broadcast user left
deactivate Redis

activate AliceWS

AliceWS -> AliceRedux: Update presence:\nRemove Bob from activeUsers
activate AliceRedux
deactivate AliceRedux

AliceWS -> AliceUI: User left event
deactivate AliceWS

activate AliceUI

AliceUI --> Alice: Update presence:\nðŸ‘¤ Bob (offline - last seen 2m ago)

deactivate AliceUI

== Offline Handling ==

note over Alice, AliceUI
  Alice loses internet connection
end note

Alice -> AliceUI: Perform action while offline
activate AliceUI

AliceUI -> AliceRedux: Dispatch action
activate AliceRedux

AliceRedux -> API: Try API call
activate API

API --x AliceRedux: Network error
deactivate API

AliceRedux -> AliceRedux: Queue action in\noffline queue

AliceRedux --> AliceUI: Queued (pending sync)

AliceUI --> Alice: Show offline banner:\n"âš  Offline - Changes will sync\nwhen reconnected"

deactivate AliceRedux
deactivate AliceUI

note over Alice, WSServer
  When connection restored
end note

AliceWS -> WSServer: Reconnect WebSocket
activate AliceWS
activate WSServer

WSServer --> AliceWS: Reconnected
deactivate WSServer

AliceWS -> AliceRedux: Connection restored
activate AliceRedux

AliceRedux -> AliceRedux: Process offline queue

AliceRedux -> API: Sync queued changes
activate API
API -> DB: Apply changes
activate DB
DB --> API: Success
deactivate DB
API --> AliceRedux: Synced
deactivate API

AliceRedux --> AliceUI: All changes synced
deactivate AliceRedux

deactivate AliceWS

activate AliceUI
AliceUI --> Alice: Remove offline banner\nShow "âœ“ Synced"
deactivate AliceUI

== Conflict Resolution ==

note over Alice, Bob
  Both users modify same item
  while one is offline
end note

Alice -> AliceUI: (Offline) Change\nBread quantity to 2
activate AliceUI
AliceUI -> AliceRedux: Queue change
activate AliceRedux
deactivate AliceRedux
deactivate AliceUI

Bob -> BobUI: (Online) Change\nBread quantity to 3
activate BobUI
BobUI -> BobRedux: Update immediately
activate BobRedux
BobRedux -> API: PUT /api/items/{itemId}\n{ quantity: 3 }
activate API
API -> DB: UPDATE (success)
activate DB
DB --> API: Updated to 3
deactivate DB
API --> BobRedux: Success
deactivate API
deactivate BobRedux
deactivate BobUI

note over Alice, AliceUI
  Alice comes back online
end note

AliceUI -> AliceRedux: Sync offline queue
activate AliceUI
activate AliceRedux

AliceRedux -> API: PUT /api/items/{itemId}\n{ quantity: 2, version: 1 }
activate API

API -> DB: Check current version
activate DB
DB --> API: Current quantity: 3,\nversion: 2 (conflict!)
deactivate DB

API --> AliceRedux: 409 Conflict\n{\n  message: "Item was modified",\n  currentValue: 3,\n  yourValue: 2\n}
deactivate API

AliceRedux --> AliceUI: Conflict detected
deactivate AliceRedux

AliceUI --> Alice: Show conflict dialog:\n"Bread quantity conflict:\nYour change: 2 loaves\nCurrent value: 3 loaves (Bob)\n\n[Keep Mine] [Keep Current] [Manual]"

Alice -> AliceUI: Select resolution

deactivate AliceUI

@enduml
