@startuml
title Complete Shopping List User Flow

actor User
participant "ListCard\nComponent" as ListCard
participant "ListCompletionSummary\nComponent" as Summary
participant "Redux Store" as Redux
participant "API\n/api/lists/{id}/complete" as API
database "Database" as DB

== Manual Completion ==

User -> ListCard: Click "Complete" button
activate ListCard

ListCard -> Redux: Dispatch completeList(listId)
activate Redux

Redux --> ListCard: Show loading state

Redux -> API: POST /api/lists/{listId}/complete
activate API

API -> DB: SELECT * FROM list_items\nWHERE list_id = {listId}
activate DB
DB --> API: All items data
deactivate DB

API -> DB: Calculate totals:\n- Total items\n- Items purchased\n- Total amount spent
activate DB

API -> DB: UPDATE shopping_lists\nSET status = 'completed',\n    completed_at = NOW(),\n    total_items = {count},\n    total_spent = {amount}\nWHERE list_id = {listId}
DB --> API: List updated
deactivate DB

API --> Redux: 200 OK\n{\n  listId, status: 'completed',\n  totalItems, totalSpent,\n  completedAt\n}
deactivate API

Redux -> Redux: Update store:\n- Set list.status = 'completed'\n- Set list.completedAt\n- Set list.totalSpent\n- Move to completed tab

Redux --> ListCard: Success
deactivate Redux

ListCard -> Summary: Show completion summary
activate Summary

Summary --> User: Display:\nâœ“ Completion checkmark\nðŸ“Š Total items purchased\nðŸ’° Total amount spent\nðŸ“… Completion date/time\n[Archive] [Reopen] buttons

deactivate Summary
deactivate ListCard

== Auto-Completion ==

note over ListCard, DB
  Triggered when user marks
  the last item as purchased
end note

User -> ListCard: Mark last item\nas purchased
activate ListCard

ListCard -> Redux: Dispatch markPurchased(itemId)
activate Redux

Redux -> API: PUT /api/items/{itemId}/purchase
activate API
API -> DB: UPDATE list_items\nSET status = 'purchased'
activate DB
DB --> API: Updated
deactivate DB
API --> Redux: Success
deactivate API

Redux -> Redux: Check if all items purchased

alt All items purchased
    Redux -> API: POST /api/lists/{listId}/complete
    activate API

    API -> DB: Auto-complete list
    activate DB
    DB --> API: List completed
    deactivate DB

    API --> Redux: 200 OK (completion data)
    deactivate API

    Redux -> Redux: Update list status
    Redux --> ListCard: Auto-complete trigger
    deactivate Redux

    ListCard -> Summary: Show completion summary
    activate Summary
    Summary --> User: Display completion summary\nwith auto-complete message
    deactivate Summary
end

deactivate ListCard

== Reopen List ==

User -> Summary: Click "Reopen" button
activate Summary

Summary -> Redux: Dispatch reopenList(listId)
activate Redux

Redux -> API: POST /api/lists/{listId}/reopen
activate API

API -> DB: UPDATE shopping_lists\nSET status = 'active',\n    completed_at = NULL\nWHERE list_id = {listId}
activate DB
DB --> API: List reopened
deactivate DB

API --> Redux: 200 OK\n{ listId, status: 'active' }
deactivate API

Redux -> Redux: Update store:\n- Set list.status = 'active'\n- Clear completedAt\n- Move to active tab

Redux --> Summary: Success
deactivate Redux

Summary -> Summary: Close summary
deactivate Summary

ListCard -> ListCard: Update display
ListCard --> User: Show success notification:\n"List reopened"

@enduml
