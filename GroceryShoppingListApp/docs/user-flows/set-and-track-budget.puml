@startuml
title Set and Track Budget User Flow

actor User
participant "ListCard/Detail\nComponent" as ListUI
participant "BudgetSetDialog\nComponent" as Dialog
participant "BudgetProgressBar\nComponent" as ProgressBar
participant "Redux Store" as Redux
participant "API\n/api/budgets" as API
database "Database" as DB
participant "Budget Alert\nService" as AlertService

== Set Budget ==

User -> ListUI: Click "Set Budget" button\nor edit existing budget
activate ListUI

ListUI -> API: GET /api/budgets/suggestions?listId={id}
activate API

API -> DB: SELECT AVG(total_spent)\nFROM shopping_lists\nWHERE owner_id = {userId}\nAND created_at > NOW() - INTERVAL '3 months'
activate DB
DB --> API: Average: $127.50
deactivate DB

API --> ListUI: 200 OK\n{\n  suggested: 127.50,\n  lastTrips: [135, 142, 105]\n}
deactivate API

ListUI -> Dialog: Open budget dialog with\nsuggested amount
activate Dialog

Dialog --> User: Display form:\n- Budget input: $127.50\n- "Based on your last 3 trips"\n- Alert threshold (default 80%)

User -> Dialog: Adjust budget to $150.00
User -> Dialog: Set alert at 80%
User -> Dialog: Click "Set Budget"

Dialog -> Redux: Dispatch setBudget(listId, {\n  amount: 150.00,\n  alertThreshold: 0.80\n})
activate Redux

Redux --> Dialog: Processing...

Redux -> API: POST /api/budgets\n{\n  listId,\n  budgetAmount: 150.00,\n  alertThreshold: 0.80\n}
activate API

API -> DB: Check if budget exists
activate DB
DB --> API: No existing budget
deactivate DB

API -> DB: INSERT INTO budgets\n(budget_id, list_id, budget_amount,\nalert_threshold, current_spending,\nstatus, created_at)\nVALUES ({id}, {listId}, 150.00,\n0.80, 0.00, 'active', NOW())
activate DB
DB --> API: Budget created
deactivate DB

API --> Redux: 201 Created\n{\n  budgetId, budgetAmount: 150.00,\n  currentSpending: 0.00,\n  remaining: 150.00,\n  percentageUsed: 0\n}
deactivate API

Redux -> Redux: Update store:\n- Add budget to budgets.byListId\n- Set budget status

Redux --> Dialog: Success
deactivate Redux

Dialog -> Dialog: Close dialog
deactivate Dialog

ListUI -> ProgressBar: Initialize progress bar
activate ProgressBar
ProgressBar --> User: Display budget progress:\n$0.00 / $150.00 (0%)\n[â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]
deactivate ProgressBar

ListUI --> User: Show success notification:\n"Budget set to $150.00"

deactivate ListUI

== Track Budget Progress (Real-time) ==

note over User, DB
  As user adds/purchases items,
  budget is tracked in real-time
end note

User -> ListUI: Add item with\nestimated price $12.50
activate ListUI

ListUI -> Redux: Dispatch addItem(...)
activate Redux

Redux -> API: POST /api/lists/{id}/items
activate API
API -> DB: Insert item
activate DB
DB --> API: Success
deactivate DB
API --> Redux: Item created
deactivate API

Redux -> Redux: Calculate estimated total:\nSum all item.estimatedPrice

Redux -> ProgressBar: Update estimated spending
deactivate Redux

activate ProgressBar
ProgressBar -> ProgressBar: Recalculate:\n- Estimated: $12.50\n- Budget: $150.00\n- Used: 8.3%

ProgressBar --> User: Update display:\n$12.50 (est) / $150.00\n[â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 8%\nColor: Green

deactivate ProgressBar
deactivate ListUI

== Track Budget with Actual Spending ==

User -> ListUI: Purchase item\nfor actual price $14.25
activate ListUI

ListUI -> Redux: Dispatch markPurchased(itemId, {\n  actualPrice: 14.25\n})
activate Redux

Redux -> API: PUT /api/items/{id}/purchase
activate API

API -> DB: UPDATE list_items\nSET actual_price = 14.25

API -> DB: UPDATE budgets\nSET current_spending =\n    current_spending + 14.25\nWHERE list_id = {listId}
activate DB
DB --> API: Budget updated:\ncurrent_spending = 14.25
deactivate DB

API -> DB: Check budget status:\nSELECT current_spending,\n       budget_amount,\n       alert_threshold,\n       (current_spending / budget_amount)\n         as percentage_used\nFROM budgets\nWHERE list_id = {listId}
activate DB
DB --> API: percentage_used = 0.095
deactivate DB

API --> Redux: 200 OK\n{\n  itemId, actualPrice: 14.25,\n  budget: {\n    currentSpending: 14.25,\n    remaining: 135.75,\n    percentageUsed: 9.5\n  }\n}
deactivate API

Redux -> Redux: Update budget state

Redux -> ProgressBar: Update with actual
deactivate Redux

activate ProgressBar
ProgressBar --> User: Update display:\n$14.25 / $150.00\n[â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 9.5%\nColor: Green

deactivate ProgressBar
deactivate ListUI

== Budget Alert at 80% Threshold ==

User -> ListUI: Purchase another item\nbringing total to $122.00
activate ListUI

ListUI -> Redux: Dispatch markPurchased(...)
activate Redux

Redux -> API: PUT /api/items/{id}/purchase\n{ actualPrice: 107.75 }
activate API

API -> DB: UPDATE budgets\nSET current_spending = 122.00
activate DB
DB --> API: Updated
deactivate DB

API -> DB: Check if alert threshold reached
activate DB
DB --> API: percentage_used = 81.3%\n(exceeds 80% threshold)
deactivate DB

API -> AlertService: Trigger budget alert
activate AlertService

AlertService -> DB: INSERT INTO budget_alerts\n(alert_id, budget_id, alert_type,\nthreshold, current_amount,\ntriggered_at)\nVALUES ({id}, {budgetId},\n'warning', 0.80, 122.00, NOW())
activate DB
DB --> AlertService: Alert created
deactivate DB

AlertService --> User: Push notification:\n"âš  Budget Alert: 81% used\n$122/$150 spent"
deactivate AlertService

API --> Redux: 200 OK with alert
deactivate API

Redux -> Redux: Update:\n- budget.currentSpending\n- Add alert to alerts.active

Redux --> ProgressBar: Update with warning
deactivate Redux

activate ProgressBar
ProgressBar --> User: Update display:\n$122.00 / $150.00\n[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] 81%\nColor: Yellow (warning)

deactivate ProgressBar

ListUI --> User: Show banner alert:\n"âš  You've used 81% of your budget\n$28 remaining"

deactivate ListUI

== Budget Exceeded ==

User -> ListUI: Purchase items totaling $160\n(exceeds $150 budget)
activate ListUI

note over ListUI, API
  Similar flow to above
end note

ListUI -> Redux: Mark purchased
activate Redux
Redux -> API: Update spending
activate API
API -> DB: current_spending = 160.00
activate DB
DB --> API: Exceeded budget!
deactivate DB

API -> AlertService: Trigger over-budget alert
activate AlertService
AlertService --> User: Push notification:\n"ðŸš¨ Budget Exceeded!\n$160/$150 spent ($10 over)"
deactivate AlertService

API --> Redux: 200 OK with alert
deactivate API

Redux -> ProgressBar: Update with error state
deactivate Redux

activate ProgressBar
ProgressBar --> User: Update display:\n$160.00 / $150.00\n[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 107%\nColor: Red (over budget)\n"+$10.00 over"

deactivate ProgressBar

ListUI --> User: Show prominent banner:\n"ðŸš¨ Budget Exceeded\nYou're $10.00 over budget"

User -> ListUI: [Optional] Click\n"Adjust Budget"

deactivate ListUI

== View Budget History ==

User -> ListUI: Click "View Budget History"
activate ListUI

ListUI -> API: GET /api/budgets/history?userId={id}
activate API

API -> DB: SELECT list_name,\n       budget_amount,\n       total_spent,\n       (total_spent - budget_amount)\n         as variance,\n       completed_at\nFROM budgets b\nJOIN shopping_lists l\n  ON b.list_id = l.list_id\nWHERE l.owner_id = {userId}\nAND l.status = 'completed'\nORDER BY completed_at DESC\nLIMIT 10
activate DB
DB --> API: Budget history
deactivate DB

API --> ListUI: 200 OK\n[{\n  listName: "Weekly Groceries",\n  budgeted: 150, spent: 142,\n  variance: -8, performance: "under"\n}, ...]
deactivate API

ListUI --> User: Display history:\nâ€¢ Week 1: $142/$150 (-$8) âœ“\nâ€¢ Week 2: $165/$150 (+$15) âœ—\nâ€¢ Week 3: $138/$150 (-$12) âœ“\n\nAverage adherence: 92%

deactivate ListUI

@enduml
