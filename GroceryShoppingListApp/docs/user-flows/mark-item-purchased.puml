@startuml
title Mark Item as Purchased User Flow

actor User
participant "ItemCard\nComponent" as ItemCard
participant "PurchaseDialog\nComponent" as Dialog
participant "Redux Store" as Redux
participant "API\n/api/items/{id}/purchase" as API
database "Database" as DB
participant "Progress Bar" as Progress

== Quick Mark (No Price Entry) ==

User -> ItemCard: Tap/click checkbox
activate ItemCard

ItemCard -> Redux: Dispatch markPurchased(itemId, { quick: true })
activate Redux

Redux --> ItemCard: Optimistic update:\n✓ Show checkmark\n  Strikethrough text\n  Dim item

ItemCard --> User: Visual feedback:\n- Checkbox animation\n- Strikethrough effect\n- Item dimmed

Redux -> API: PUT /api/items/{itemId}/purchase\n{\n  purchasedAt: NOW(),\n  actualPrice: null,\n  purchasedBy: userId\n}
activate API

API -> DB: UPDATE list_items\nSET status = 'purchased',\n    purchased_at = NOW(),\n    purchased_by = {userId}\nWHERE item_id = {itemId}
activate DB
DB --> API: Item updated
deactivate DB

API -> DB: SELECT COUNT(*) as total,\n       COUNT(CASE WHEN status='purchased'\n             THEN 1 END) as purchased\nFROM list_items\nWHERE list_id = {listId}
activate DB
DB --> API: Progress data
deactivate DB

API --> Redux: 200 OK\n{\n  itemId, status: 'purchased',\n  purchasedAt,\n  progress: { total: 12, purchased: 9 }\n}
deactivate API

Redux -> Redux: Confirm state:\n- Update item.status\n- Set item.purchasedAt\n- Update progress

Redux --> Progress: Update progress bar
activate Progress
Progress --> User: Show progress:\n████████░░░░ 9/12 (75%)
deactivate Progress

Redux --> ItemCard: Success
deactivate Redux

deactivate ItemCard

== Mark with Price Entry ==

User -> ItemCard: Long-press or\nright-click item
activate ItemCard

ItemCard --> User: Show context menu

User -> ItemCard: Select "Mark as Purchased"

ItemCard -> Dialog: Open purchase dialog
activate Dialog

Dialog --> User: Display form:\n- Item name (read-only)\n- Actual price input\n- Quantity purchased\n- Store name (autocomplete)\n- Notes (optional)

User -> Dialog: Enter actual price: "$4.25"
User -> Dialog: Enter store: "Walmart"
User -> Dialog: Click "Mark with Price"

Dialog -> Redux: Dispatch markPurchased(itemId, {\n  actualPrice: 4.25,\n  store: "Walmart",\n  quantity: 2\n})
activate Redux

Redux --> Dialog: Processing...
Dialog --> User: Show loading

Redux -> API: PUT /api/items/{itemId}/purchase\n{\n  purchasedAt: NOW(),\n  actualPrice: 4.25,\n  store: "Walmart",\n  quantity: 2,\n  purchasedBy: userId\n}
activate API

API -> DB: UPDATE list_items\nSET status = 'purchased',\n    purchased_at = NOW(),\n    actual_price = 4.25,\n    store = 'Walmart',\n    purchased_by = {userId}\nWHERE item_id = {itemId}
activate DB
DB --> API: Item updated
deactivate DB

API -> DB: INSERT INTO price_history\n(item_name, price, store,\npurchased_at, user_id)\nVALUES ('Apples', 4.25, 'Walmart',\nNOW(), {userId})
activate DB
note right of DB
  This data feeds the
  price tracking feature
end note
DB --> API: Price recorded
deactivate DB

API -> DB: Update budget tracking
activate DB
DB -> DB: UPDATE budgets\nSET current_spending =\n    current_spending + 4.25\nWHERE list_id = {listId}
DB --> API: Budget updated
deactivate DB

API -> DB: Check budget threshold
activate DB
DB --> API: Budget at 85%\n(alert threshold)
deactivate DB

API --> Redux: 200 OK\n{\n  itemId, status: 'purchased',\n  actualPrice: 4.25,\n  variance: +0.26 (vs estimated),\n  budgetAlert: true\n}
deactivate API

Redux -> Redux: Update state:\n- item.status = 'purchased'\n- item.actualPrice = 4.25\n- Update budget spending\n- Add budget alert

Redux --> Dialog: Success
deactivate Redux

Dialog -> Dialog: Close dialog
deactivate Dialog

ItemCard -> ItemCard: Update display:\n✓ Checkmark\n  "Apples - $4.25 (Walmart)"\n  Strikethrough

ItemCard --> User: Show success notification:\n"Item purchased for $4.25"

alt Budget alert triggered
    ItemCard --> User: Show budget alert:\n"⚠ 85% of budget used\n$127.50 / $150.00"
end

deactivate ItemCard

== Undo Purchase ==

User -> ItemCard: Click checkbox again\n(uncheck)
activate ItemCard

ItemCard -> Redux: Dispatch undoPurchase(itemId)
activate Redux

Redux --> ItemCard: Optimistic update:\nRemove checkmark & strikethrough

Redux -> API: PUT /api/items/{itemId}/unpurchase
activate API

API -> DB: UPDATE list_items\nSET status = 'pending',\n    purchased_at = NULL,\n    actual_price = NULL\nWHERE item_id = {itemId}
activate DB
DB --> API: Item unpurchased
deactivate DB

API -> DB: Revert budget spending
activate DB
DB -> DB: UPDATE budgets\nSET current_spending =\n    current_spending - 4.25
DB --> API: Budget reverted
deactivate DB

API --> Redux: 200 OK
deactivate API

Redux -> Redux: Update state:\n- item.status = 'pending'\n- Clear purchasedAt\n- Update budget

Redux --> ItemCard: Success
deactivate Redux

ItemCard --> User: Show notification:\n"Purchase undone"

deactivate ItemCard

@enduml
