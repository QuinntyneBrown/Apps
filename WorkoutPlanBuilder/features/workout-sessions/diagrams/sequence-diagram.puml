@startuml Workout Sessions - Sequence Diagram

title Start Session, Log Sets, and Complete Session

actor User
participant "Frontend\nApp" as Frontend
participant "API" as API
participant "MediatR" as Mediator
participant "Handler" as Handler
participant "Session" as Session
participant "Repository" as Repo
participant "Database" as DB
participant "Events" as Events
participant "PR Service" as PRService
participant "Notify" as Notify

== Start Workout Session ==

User -> Frontend: Click "Start Workout"
activate Frontend

Frontend -> API: POST /api/workout-sessions\n{StartWorkoutSessionCommand}
activate API

API -> Mediator: Send(StartWorkoutSessionCommand)
activate Mediator

Mediator -> Handler: Handle()
activate Handler

Handler -> Session: Start(userId, planId, workoutId)
activate Session

Session -> Session: Generate Id
Session -> Session: Set StartTime = now
Session -> Session: Status = InProgress
Session -> Session: AddDomainEvent(\nWorkoutSessionStartedEvent)

Session --> Handler: WorkoutSession
deactivate Session

Handler -> Repo: AddAsync(session)
activate Repo

Repo -> DB: INSERT INTO WorkoutSessions
Repo -> Events: Dispatch(WorkoutSessionStartedEvent)
activate Events

Events -> Notify: Send notification:\n"Workout started!"
Events -> Notify: Track analytics
deactivate Events

Repo --> Handler: sessionId
deactivate Repo

Handler --> Mediator: sessionId
deactivate Handler
Mediator --> API: sessionId
deactivate Mediator
API --> Frontend: 201 Created {sessionId}
deactivate API

Frontend -> Frontend: Navigate to active session
Frontend -> Frontend: Start session timer
deactivate Frontend

== Log Exercise Sets ==

loop For each set

User -> Frontend: Enter weight & reps\nClick "Log Set"
activate Frontend

Frontend -> API: POST /api/workout-sessions/{id}/sets\n{LogExerciseSetCommand}
activate API

API -> Mediator: Send(LogExerciseSetCommand)
activate Mediator

Mediator -> Handler: Handle()
activate Handler

Handler -> Repo: GetByIdAsync(sessionId)
Repo -> DB: SELECT session
Repo --> Handler: WorkoutSession

Handler -> Session: LogSet(exerciseSet)
activate Session

Session -> Session: Add set to _sets
Session -> Session: Calculate volume
Session -> Session: AddDomainEvent(\nExercisePerformedEvent)

Session --> Handler: Success
deactivate Session

Handler -> Repo: UpdateAsync(session)
activate Repo

Repo -> DB: INSERT INTO ExerciseSets
Repo -> Events: Dispatch(ExercisePerformedEvent)
Repo --> Handler: Success
deactivate Repo

Handler --> Mediator: setId
deactivate Handler
Mediator --> API: setId
deactivate Mediator
API --> Frontend: 200 OK {setId}
deactivate API

Frontend -> Frontend: Update UI
Frontend -> Frontend: Show set in list
Frontend -> Frontend: Update statistics
Frontend -> Frontend: Start rest timer
deactivate Frontend

User -> Frontend: Rest between sets...

end

== Complete Session ==

User -> Frontend: Click "Finish Workout"
activate Frontend

Frontend -> Frontend: Show completion dialog
User -> Frontend: Add notes, confirm

Frontend -> API: POST /api/workout-sessions/{id}/complete\n{CompleteWorkoutSessionCommand}
activate API

API -> Mediator: Send(CompleteWorkoutSessionCommand)
activate Mediator

Mediator -> Handler: Handle()
activate Handler

Handler -> Repo: GetByIdWithSetsAsync(sessionId)
Repo -> DB: SELECT session with sets
Repo --> Handler: WorkoutSession with sets

Handler -> Session: Complete(notes)
activate Session

Session -> Session: Validate Status = InProgress
Session -> Session: Set EndTime = now
Session -> Session: Calculate Duration
Session -> Session: Calculate TotalVolume
Session -> Session: Status = Completed
Session -> Session: AddDomainEvent(\nWorkoutSessionCompletedEvent)

Session --> Handler: Success
deactivate Session

Handler -> Repo: UpdateAsync(session)
activate Repo

Repo -> DB: UPDATE WorkoutSessions\nSET Status = Completed,\nEndTime = @time

Repo -> Events: Dispatch(WorkoutSessionCompletedEvent)
activate Events

Events -> PRService: CheckAndRecordPRsAsync(sessionId)
activate PRService

PRService -> DB: Query previous PRs
PRService -> PRService: Compare current\nto previous bests
PRService -> DB: INSERT new PRs
PRService -> Notify: Notify user of PRs

PRService --> Events: PRs detected
deactivate PRService

Events -> Notify: Send completion:\n"Great workout!"
Events -> Notify: Track analytics:\n"session_completed"
Events -> Notify: Update progress charts

deactivate Events

Repo --> Handler: Success
deactivate Repo

Handler --> Mediator: Success
deactivate Handler
Mediator --> API: Success
deactivate Mediator
API --> Frontend: 204 No Content
deactivate API

Frontend -> Frontend: Show celebration
Frontend -> Frontend: Display summary:\n- Duration\n- Volume\n- PRs
Frontend -> Frontend: Navigate to summary
deactivate Frontend

@enduml
