@startuml Payment Scheduling Sequence Diagrams

!theme plain

title Schedule Payment - Sequence Diagram

actor User
participant "UI: SchedulePaymentForm" as UI
participant "API: PaymentsController" as API
participant "Handler: SchedulePaymentCommandHandler" as Handler
participant "Repository: IPaymentScheduleRepository" as Repo
participant "Repository: IBillRepository" as BillRepo
participant "Repository: IPaymentMethodRepository" as PMRepo
participant "Aggregate: PaymentSchedule" as Payment
participant "EventPublisher: IEventPublisher" as EventPub
database "Database" as DB

User -> UI: Select bill and fill payment details
activate UI

UI -> API: GET /api/bills/{billId}
activate API
API --> UI: Bill details
deactivate API

UI -> API: GET /api/payment-methods
activate API
API --> UI: Available payment methods
deactivate API

User -> UI: Click "Schedule Payment"
UI -> UI: Validate form data
UI -> API: POST /api/payments/schedule
activate API

API -> API: Validate authentication
API -> Handler: Handle(SchedulePaymentCommand)
activate Handler

Handler -> BillRepo: GetById(billId)
activate BillRepo
BillRepo -> DB: SELECT FROM Bills
DB --> BillRepo: Bill data
BillRepo --> Handler: Bill
deactivate BillRepo

Handler -> PMRepo: GetById(paymentMethodId)
activate PMRepo
PMRepo -> DB: SELECT FROM PaymentMethods
DB --> PMRepo: PaymentMethod data
PMRepo --> Handler: PaymentMethod
deactivate PMRepo

Handler -> Handler: Validate payment method is active
Handler -> Handler: Validate scheduled date

Handler -> Payment: new PaymentSchedule(...)
activate Payment
Payment -> Payment: Validate business rules
Payment -> Payment: Set initial status = Scheduled
Payment -> Payment: RaisePaymentScheduled()
Payment --> Handler: PaymentSchedule
deactivate Payment

Handler -> Repo: Add(paymentSchedule)
activate Repo
Repo -> DB: INSERT INTO PaymentSchedules
DB --> Repo: Success
deactivate Repo

Handler -> EventPub: Publish(PaymentScheduled)
activate EventPub
EventPub --> Handler: Done
deactivate EventPub

Handler --> API: PaymentScheduleId
deactivate Handler

API --> UI: 201 Created {paymentScheduleId}
deactivate API

UI -> UI: Show success notification
UI --> User: Payment scheduled successfully
deactivate UI

|||

newpage Execute Payment - Sequence Diagram

actor Scheduler as "Payment Executor Job"
participant "Handler: ExecutePaymentCommandHandler" as Handler2
participant "Repository: IPaymentScheduleRepository" as Repo2
participant "Aggregate: PaymentSchedule" as Payment2
participant "Gateway: IPaymentGateway" as Gateway
participant "EventPublisher: IEventPublisher" as EventPub2
participant "NotificationService" as Notification
database "Database" as DB2

Scheduler -> Repo2: GetScheduledPaymentsDue()
activate Repo2
Repo2 -> DB2: SELECT FROM PaymentSchedules\nWHERE Status = 'Scheduled'\nAND ScheduledDate <= NOW()
DB2 --> Repo2: Due payments
Repo2 --> Scheduler: List<PaymentSchedule>
deactivate Repo2

loop For each due payment
    Scheduler -> Handler2: Handle(ExecutePaymentCommand)
    activate Handler2

    Handler2 -> Repo2: GetById(paymentScheduleId)
    activate Repo2
    Repo2 -> DB2: SELECT FROM PaymentSchedules
    DB2 --> Repo2: Payment data
    Repo2 --> Handler2: PaymentSchedule
    deactivate Repo2

    Handler2 -> Payment2: UpdateStatus(InProgress)
    activate Payment2
    Payment2 --> Handler2: Updated
    deactivate Payment2

    Handler2 -> Repo2: Update(paymentSchedule)
    activate Repo2
    Repo2 -> DB2: UPDATE PaymentSchedules SET Status = 'InProgress'
    DB2 --> Repo2: Success
    deactivate Repo2

    Handler2 -> Gateway: ProcessPaymentAsync(paymentRequest)
    activate Gateway
    Gateway -> Gateway: Validate payment method
    Gateway -> Gateway: Process payment

    alt Payment Successful
        Gateway --> Handler2: PaymentResult {success: true, confirmationNumber}
        deactivate Gateway

        Handler2 -> Payment2: MarkAsCompleted(confirmationNumber)
        activate Payment2
        Payment2 -> Payment2: Set status = Completed
        Payment2 -> Payment2: Set executedAt = NOW()
        Payment2 -> Payment2: RaisePaymentExecuted()
        Payment2 --> Handler2: Updated
        deactivate Payment2

        Handler2 -> Repo2: Update(paymentSchedule)
        activate Repo2
        Repo2 -> DB2: UPDATE PaymentSchedules
        DB2 --> Repo2: Success
        deactivate Repo2

        Handler2 -> EventPub2: Publish(PaymentExecuted)
        activate EventPub2
        EventPub2 -> Notification: SendPaymentConfirmation()
        activate Notification
        Notification --> EventPub2: Sent
        deactivate Notification
        EventPub2 --> Handler2: Done
        deactivate EventPub2

    else Payment Failed
        Gateway --> Handler2: PaymentResult {success: false, errorMessage}
        deactivate Gateway

        Handler2 -> Payment2: MarkAsFailed(errorMessage)
        activate Payment2
        Payment2 -> Payment2: Set status = Failed
        Payment2 -> Payment2: Set failureReason
        Payment2 -> Payment2: RaisePaymentFailed()
        Payment2 --> Handler2: Updated
        deactivate Payment2

        Handler2 -> Repo2: Update(paymentSchedule)
        activate Repo2
        Repo2 -> DB2: UPDATE PaymentSchedules
        DB2 --> Repo2: Success
        deactivate Repo2

        Handler2 -> EventPub2: Publish(PaymentFailed)
        activate EventPub2
        EventPub2 -> Notification: SendPaymentFailureNotification()
        activate Notification
        Notification --> EventPub2: Sent
        deactivate Notification
        EventPub2 --> Handler2: Done
        deactivate EventPub2
    end

    Handler2 --> Scheduler: PaymentResult
    deactivate Handler2
end

|||

newpage Cancel Payment - Sequence Diagram

actor User2 as User
participant "UI: PaymentDetails" as UI3
participant "API: PaymentsController" as API3
participant "Handler: CancelPaymentCommandHandler" as Handler3
participant "Repository: IPaymentScheduleRepository" as Repo3
participant "Aggregate: PaymentSchedule" as Payment3
participant "EventPublisher: IEventPublisher" as EventPub3
database "Database" as DB3

User2 -> UI3: View payment details
activate UI3

User2 -> UI3: Click "Cancel Payment"
UI3 -> UI3: Show cancellation dialog

User2 -> UI3: Enter cancellation reason and confirm
UI3 -> API3: POST /api/payments/{id}/cancel
activate API3

API3 -> API3: Validate authentication
API3 -> Handler3: Handle(CancelPaymentCommand)
activate Handler3

Handler3 -> Repo3: GetById(paymentScheduleId)
activate Repo3
Repo3 -> DB3: SELECT FROM PaymentSchedules
DB3 --> Repo3: Payment data
Repo3 --> Handler3: PaymentSchedule
deactivate Repo3

Handler3 -> Handler3: Validate status is Scheduled
Handler3 -> Handler3: Validate user has permission

Handler3 -> Payment3: Cancel(reason)
activate Payment3
Payment3 -> Payment3: Set status = Cancelled
Payment3 -> Payment3: Set cancelledAt = NOW()
Payment3 -> Payment3: RaisePaymentCancelled()
Payment3 --> Handler3: Updated
deactivate Payment3

Handler3 -> Repo3: Update(paymentSchedule)
activate Repo3
Repo3 -> DB3: UPDATE PaymentSchedules\nSET Status = 'Cancelled', CancelledAt = ?
DB3 --> Repo3: Success
deactivate Repo3

Handler3 -> EventPub3: Publish(PaymentCancelled)
activate EventPub3
EventPub3 --> Handler3: Done
deactivate EventPub3

Handler3 --> API3: Success
deactivate Handler3

API3 --> UI3: 200 OK
deactivate API3

UI3 -> UI3: Show success notification
UI3 -> UI3: Update payment status display
UI3 --> User2: Payment cancelled
deactivate UI3

@enduml
