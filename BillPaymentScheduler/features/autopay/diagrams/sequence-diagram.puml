@startuml Autopay Sequence Diagram

!theme plain

title Execute Autopay - Sequence Diagram

participant "Job: AutopayExecutor" as Job
participant "Handler: ExecuteAutopayCommandHandler" as Handler
participant "Repository: IAutopayRepository" as Repo
participant "Aggregate: AutopayConfiguration" as Autopay
participant "Service: PaymentService" as PaymentService
participant "EventPublisher: IEventPublisher" as EventPub
database "Database" as DB

Job -> Repo: GetDueExecutions()
activate Repo
Repo -> DB: SELECT FROM AutopayConfigurations\nWHERE NextExecutionDate <= NOW()\nAND IsEnabled = 1
DB --> Repo: Due autopay configs
Repo --> Job: List<AutopayConfiguration>
deactivate Repo

loop For each due autopay
    Job -> Handler: Handle(ExecuteAutopayCommand)
    activate Handler

    Handler -> Repo: GetById(autopayConfigId)
    activate Repo
    Repo --> Handler: AutopayConfiguration
    deactivate Repo

    Handler -> Handler: Validate payment method active
    Handler -> Handler: Check bill amount vs max amount

    alt Amount exceeds limit
        Handler -> Handler: Skip execution, notify user
    else Approval required
        Handler -> Handler: Create pending approval
    else All checks pass
        Handler -> PaymentService: CreateAndExecutePayment(billId, amount, paymentMethodId)
        activate PaymentService

        alt Payment successful
            PaymentService --> Handler: PaymentResult {success, paymentScheduleId}
            deactivate PaymentService

            Handler -> Autopay: ResetFailureCount()
            activate Autopay
            Autopay -> Autopay: failureCount = 0
            Autopay -> Autopay: lastExecutionDate = NOW()
            Autopay -> Autopay: UpdateNextExecutionDate()
            Autopay --> Handler: Updated
            deactivate Autopay

            Handler -> Repo: Update(autopayConfiguration)
            activate Repo
            Repo -> DB: UPDATE AutopayConfigurations
            DB --> Repo: Success
            deactivate Repo

            Handler -> EventPub: Publish(AutopayExecuted)
            activate EventPub
            EventPub --> Handler: Done
            deactivate EventPub

        else Payment failed
            PaymentService --> Handler: PaymentResult {failed, reason}
            deactivate PaymentService

            Handler -> Autopay: IncrementFailureCount()
            activate Autopay
            Autopay -> Autopay: failureCount++
            alt failureCount >= 3
                Autopay -> Autopay: Disable()
                Autopay -> Autopay: isEnabled = false
            end
            Autopay --> Handler: Updated
            deactivate Autopay

            Handler -> Repo: Update(autopayConfiguration)
            activate Repo
            Repo -> DB: UPDATE AutopayConfigurations
            DB --> Repo: Success
            deactivate Repo
        end
    end

    Handler --> Job: ExecutionResult
    deactivate Handler
end

@enduml
