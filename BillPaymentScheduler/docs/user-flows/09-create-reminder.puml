@startuml Create Reminder Flow
title Create Reminder Flow

actor User
participant "Reminders Dashboard" as Dashboard
participant "Create Reminder\nForm" as Form
participant "Reminder Service" as ReminderSvc
participant "Bill Service" as BillSvc
participant "API Gateway" as API
participant "Reminder Controller" as ReminderCtrl
participant "Reminder Management\nService" as ReminderMgmt
participant "Notification Service" as NotificationSvc
database "Reminder Database" as DB

User -> Dashboard: Click "Add Reminder" button
activate Dashboard

Dashboard -> BillSvc: loadUserBills()
activate BillSvc
BillSvc -> API: GET /api/bills
activate API
API -> BillSvc: Return bills list
deactivate API
BillSvc -> Dashboard: Bills loaded
deactivate BillSvc

Dashboard -> ReminderSvc: getUserNotificationPreferences()
activate ReminderSvc
ReminderSvc -> API: GET /api/notifications/preferences
activate API
API -> ReminderSvc: Return preferences\n(email, phone, push settings)
deactivate API
ReminderSvc -> Dashboard: Preferences loaded
deactivate ReminderSvc

Dashboard -> Form: Display create reminder form
deactivate Dashboard
activate Form

Form -> User: Show form with:\n- Bill selector (dropdown)\n- Reminder type selector\n- Days before due date slider\n- Notification channels checkboxes\n- Preview message section

User -> Form: Select bill from dropdown
Form -> Form: Display bill details\n(payee, amount, due date, category)

User -> Form: Select reminder type
note right of Form
    Reminder Types:
    - Upcoming Payment (7-30 days before)
    - Due Soon (1-7 days before)
    - Overdue (after due date)
end note

User -> Form: Adjust "Days Before" slider\n(e.g., 3 days before due date)

Form -> Form: Update preview message
note right of Form
    Preview Message:
    "Reminder: Your Electric Company bill
    of $150.00 is due in 3 days on Jan 20.
    Don't forget to pay on time!"
end note

User -> Form: Select notification channels
activate Form

alt Email selected but not verified
    Form -> User: Show warning:\n"Email address not verified.\nVerify now to receive email notifications."
    User -> Form: Click "Verify Email"
    Form -> NotificationSvc: sendVerificationEmail()
    activate NotificationSvc
    NotificationSvc -> User: Send verification email
    deactivate NotificationSvc
    Form -> User: Show info:\n"Verification email sent. Check your inbox."
end

alt SMS selected but no phone number
    Form -> User: Show warning:\n"No phone number on file.\nAdd phone number to receive SMS."
    User -> Form: Click "Add Phone Number"
    Form -> User: Show phone number input dialog
    User -> Form: Enter phone number
    Form -> NotificationSvc: addPhoneNumber(phone)
    activate NotificationSvc
    NotificationSvc -> NotificationSvc: Send verification code
    NotificationSvc -> User: SMS with verification code
    User -> Form: Enter verification code
    Form -> NotificationSvc: verifyPhoneNumber(code)
    NotificationSvc -> Form: Phone verified
    deactivate NotificationSvc
end

deactivate Form

User -> Form: Review settings
Form -> Form: Real-time validation

alt Validation Errors
    Form -> User: Display inline errors:\n- Bill must be selected\n- At least one channel required\n- Days before must be 1-30
    User -> Form: Correct errors
else All Fields Valid
    alt User clicks "Test Reminder"
        User -> Form: Click "Test Reminder" button
        Form -> ReminderSvc: sendTestReminder(reminderData)
        activate ReminderSvc
        ReminderSvc -> API: POST /api/reminders/test
        activate API
        API -> NotificationSvc: SendTestNotification(channels, message)
        activate NotificationSvc
        NotificationSvc -> User: Send test notification\nvia selected channels
        deactivate NotificationSvc
        API -> ReminderSvc: Test sent successfully
        deactivate API
        ReminderSvc -> Form: Test completed
        deactivate ReminderSvc
        Form -> User: Show success toast:\n"Test reminder sent to your email/SMS"
    end

    User -> Form: Click "Create Reminder" button

    Form -> ReminderSvc: createReminder(reminderData)
    activate ReminderSvc

    ReminderSvc -> API: POST /api/reminders
    activate API
    note right of API
        Request Body:
        {
            "billId": "guid",
            "reminderType": "DueSoon",
            "daysBefore": 3,
            "notificationChannels": ["Email", "SMS"],
            "isActive": true
        }
    end note

    API -> ReminderCtrl: Create reminder request
    activate ReminderCtrl

    ReminderCtrl -> ReminderCtrl: Validate request
    ReminderCtrl -> ReminderCtrl: Extract userId from JWT token
    ReminderCtrl -> ReminderCtrl: Verify bill ownership
    ReminderCtrl -> ReminderCtrl: Verify notification channels active

    ReminderCtrl -> ReminderMgmt: CreateReminderAsync(userId, reminderData)
    activate ReminderMgmt

    ReminderMgmt -> ReminderMgmt: Create Reminder entity
    ReminderMgmt -> ReminderMgmt: Set active status to true
    ReminderMgmt -> ReminderMgmt: Calculate next scheduled date

    ReminderMgmt -> DB: INSERT INTO Reminders
    activate DB
    DB -> ReminderMgmt: Return created reminder
    deactivate DB

    ReminderMgmt -> ReminderMgmt: Schedule first reminder execution
    note right of ReminderMgmt
        Calculate next execution:
        - Get bill due date
        - Subtract days before
        - Create scheduled job
    end note

    ReminderMgmt -> DB: INSERT INTO ScheduledReminders\n(Status = 'Pending', ScheduledDate = ?)
    activate DB
    DB -> ReminderMgmt: Reminder scheduled
    deactivate DB

    ReminderMgmt -> ReminderCtrl: Return Reminder entity
    deactivate ReminderMgmt

    ReminderCtrl -> API: 201 Created with reminder data
    deactivate ReminderCtrl
    note right of API
        Response Body:
        {
            "reminderId": "guid",
            "billId": "guid",
            "billName": "Electric Company",
            "reminderType": "DueSoon",
            "daysBefore": 3,
            "notificationChannels": ["Email", "SMS"],
            "isActive": true,
            "nextScheduledAt": "2024-01-17T09:00:00Z"
        }
    end note

    API -> ReminderSvc: Reminder created successfully
    deactivate API

    ReminderSvc -> Form: Success response
    deactivate ReminderSvc

    Form -> Form: Show success notification\n"Reminder created successfully"

    Form -> Dashboard: Navigate to reminders dashboard
    deactivate Form
    activate Dashboard

    Dashboard -> Dashboard: Refresh reminders list
    Dashboard -> User: Display reminders dashboard\nwith newly created reminder
    deactivate Dashboard
end

@enduml
