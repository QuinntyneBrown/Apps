@startuml Cancel Payment Flow
title Cancel Payment Flow

actor User
participant "Payment Details" as Details
participant "Confirmation\nDialog" as Dialog
participant "Payment Service" as PaymentSvc
participant "API Gateway" as API
participant "Payment Controller" as PaymentCtrl
participant "Payment Scheduling\nService" as PaymentMgmt
database "Payment Database" as DB

User -> Details: View payment details
activate Details

Details -> Details: Check payment status

alt Payment already executed
    Details -> User: "Cancel Payment" button is disabled\nShow info: "Payment already executed"
    deactivate Details
else Payment already cancelled
    Details -> User: "Cancel Payment" button is disabled\nShow info: "Payment already cancelled"
    deactivate Details
else Payment is scheduled
    Details -> User: "Cancel Payment" button is enabled

    User -> Details: Click "Cancel Payment" button

    Details -> Dialog: Show confirmation dialog
    activate Dialog

    alt Payment within 24 hours
        Dialog -> User: Display warning:\n"This payment is scheduled within 24 hours.\nAre you sure you want to cancel?\nPlease provide a reason."
    else Payment more than 24 hours away
        Dialog -> User: Display confirmation:\n"Are you sure you want to cancel this payment?\nPlease provide a reason."
    end

    Dialog -> User: Show cancellation reason input field

    alt User clicks Cancel
        Dialog -> Details: Close dialog
        deactivate Dialog
        Details -> User: Return to payment details
        deactivate Details
    else User provides reason and confirms
        User -> Dialog: Enter cancellation reason
        Dialog -> Dialog: Validate reason (required, min 5 chars)

        alt Reason is invalid
            Dialog -> User: Show validation error\n"Please provide a reason (min 5 characters)"
        else Reason is valid
            Dialog -> PaymentSvc: cancelPayment(paymentScheduleId, reason)
            deactivate Dialog
            activate PaymentSvc

            PaymentSvc -> API: POST /api/payments/{id}/cancel
            activate API
            note right of API
                Request Body:
                {
                    "reason": "User requested cancellation"
                }
            end note

            API -> PaymentCtrl: Cancel payment request
            activate PaymentCtrl

            PaymentCtrl -> PaymentCtrl: Extract userId from JWT token

            PaymentCtrl -> PaymentMgmt: CancelPaymentAsync(paymentScheduleId, userId, reason)
            activate PaymentMgmt

            PaymentMgmt -> DB: SELECT * FROM PaymentSchedules\nWHERE PaymentScheduleId = ? AND UserId = ?
            activate DB
            DB -> PaymentMgmt: Return payment schedule
            deactivate DB

            alt Payment not found or not owned by user
                PaymentMgmt -> PaymentCtrl: NotFound or Unauthorized
                PaymentCtrl -> API: 404 Not Found or 403 Forbidden
                API -> PaymentSvc: Error response
                PaymentSvc -> Details: Display error
                activate Details
                Details -> User: Show error message\n"Payment not found or access denied"
                deactivate Details
            else Payment already executed
                PaymentMgmt -> PaymentCtrl: Bad request
                PaymentCtrl -> API: 400 Bad Request\n"Cannot cancel executed payment"
                API -> PaymentSvc: Error response
                PaymentSvc -> Details: Display error
                activate Details
                Details -> User: Show error message\n"Cannot cancel payment that has already been executed"
                deactivate Details
            else Payment can be cancelled
                PaymentMgmt -> PaymentMgmt: Update payment schedule
                PaymentMgmt -> PaymentMgmt: Set status to 'Cancelled'
                PaymentMgmt -> PaymentMgmt: Set cancelledAt to current time
                PaymentMgmt -> PaymentMgmt: Store cancellation reason
                PaymentMgmt -> PaymentMgmt: Set audit fields

                PaymentMgmt -> DB: UPDATE PaymentSchedules\nSET Status = 'Cancelled',\nCancelledAt = NOW(),\nCancellationReason = ?,\nUpdatedAt = NOW(),\nUpdatedBy = ?
                activate DB
                DB -> PaymentMgmt: Update successful
                deactivate DB

                alt Is recurring payment
                    PaymentMgmt -> PaymentMgmt: Check if cancel all occurrences
                    alt Cancel only this occurrence
                        PaymentMgmt -> DB: UPDATE only this payment
                    else Cancel all future occurrences
                        PaymentMgmt -> DB: UPDATE PaymentSchedules\nSET Status = 'Cancelled'\nWHERE RecurringPaymentId = ?\nAND ScheduledDate >= NOW()
                        activate DB
                        DB -> PaymentMgmt: Future payments cancelled
                        deactivate DB
                    end
                end

                PaymentMgmt -> PaymentCtrl: Return updated PaymentSchedule
                deactivate PaymentMgmt

                PaymentCtrl -> API: 200 OK with updated payment
                deactivate PaymentCtrl

                API -> PaymentSvc: Payment cancelled successfully
                deactivate API

                PaymentSvc -> Details: Success response
                deactivate PaymentSvc
                activate Details

                Details -> Details: Refresh payment data
                Details -> Details: Show success toast\n"Payment cancelled successfully"
                Details -> Details: Disable "Cancel Payment" button
                Details -> Details: Update status badge to "Cancelled"

                Details -> User: Display updated payment details\nwith cancellation info
                deactivate Details
            end
        end
    end
end

@enduml
