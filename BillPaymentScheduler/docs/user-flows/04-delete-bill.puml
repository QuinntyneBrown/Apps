@startuml Delete Bill Flow
title Delete Bill Flow

actor User
participant "Bill Details/List" as UI
participant "Confirmation\nDialog" as Dialog
participant "Bill Service" as BillSvc
participant "API Gateway" as API
participant "Bills Controller" as BillCtrl
participant "Bill Management\nService" as BillMgmt
participant "Autopay Service" as AutopaySvc
participant "Payment Service" as PaymentSvc
database "Bill Database" as DB

User -> UI: Click "Delete" button
activate UI

UI -> BillSvc: checkBillDependencies(billId)
activate BillSvc

BillSvc -> API: GET /api/bills/{billId}/dependencies
activate API

API -> BillCtrl: Check dependencies
activate BillCtrl

BillCtrl -> AutopaySvc: GetAutopayConfigByBillId(billId)
activate AutopaySvc
AutopaySvc -> BillCtrl: Return autopay config (if exists)
deactivate AutopaySvc

BillCtrl -> PaymentSvc: GetScheduledPaymentsByBillId(billId)
activate PaymentSvc
PaymentSvc -> BillCtrl: Return scheduled payments (if any)
deactivate PaymentSvc

BillCtrl -> API: Return dependencies info
deactivate BillCtrl

API -> BillSvc: Dependencies data
deactivate API

BillSvc -> UI: Dependencies loaded
deactivate BillSvc

UI -> Dialog: Show confirmation dialog
activate Dialog

alt Has Autopay or Scheduled Payments
    Dialog -> User: Display warning message:\n"This bill has active autopay and 3 scheduled payments.\nDeleting will cancel these automatically.\nAre you sure?"
else No Dependencies
    Dialog -> User: Display confirmation:\n"Are you sure you want to delete this bill?"
end

alt User Cancels
    Dialog -> UI: Close dialog
    deactivate Dialog
    UI -> User: Return to previous view
    deactivate UI
else User Confirms Deletion
    Dialog -> BillSvc: deleteBill(billId)
    deactivate Dialog
    activate BillSvc

    BillSvc -> API: DELETE /api/bills/{billId}
    activate API

    API -> BillCtrl: Delete bill request
    activate BillCtrl

    BillCtrl -> BillCtrl: Extract userId from JWT token

    BillCtrl -> BillMgmt: DeleteBillAsync(billId, userId)
    activate BillMgmt

    BillMgmt -> DB: SELECT * FROM Bills WHERE BillId = ? AND UserId = ?
    activate DB
    DB -> BillMgmt: Return bill data
    deactivate DB

    alt Bill not found or not owned by user
        BillMgmt -> BillCtrl: NotFound or Unauthorized
        BillCtrl -> API: 404 Not Found or 403 Forbidden
        API -> BillSvc: Error response
        BillSvc -> UI: Display error
        activate UI
        UI -> User: Show error message\n"Bill not found or access denied"
        deactivate UI
    else Bill found and authorized

        alt Has Autopay Configuration
            BillMgmt -> AutopaySvc: DisableAutopayForBill(billId)
            activate AutopaySvc
            AutopaySvc -> DB: UPDATE AutopayConfigs SET IsEnabled = false
            activate DB
            DB -> AutopaySvc: Autopay disabled
            deactivate DB
            deactivate AutopaySvc
        end

        alt Has Scheduled Payments
            BillMgmt -> PaymentSvc: CancelScheduledPaymentsForBill(billId)
            activate PaymentSvc
            PaymentSvc -> DB: UPDATE PaymentSchedules SET Status = 'Cancelled'
            activate DB
            DB -> PaymentSvc: Payments cancelled
            deactivate DB
            deactivate PaymentSvc
        end

        BillMgmt -> DB: DELETE FROM Bills WHERE BillId = ?
        activate DB
        DB -> BillMgmt: Bill deleted
        deactivate DB

        BillMgmt -> BillCtrl: Deletion successful
        deactivate BillMgmt

        BillCtrl -> API: 204 No Content
        deactivate BillCtrl

        API -> BillSvc: Bill deleted successfully
        deactivate API

        BillSvc -> UI: Success response
        deactivate BillSvc
        activate UI

        UI -> UI: Show success toast\n"Bill deleted successfully"
        UI -> UI: Remove bill from list

        alt User was on Bill Details page
            UI -> UI: Redirect to /bills
        end

        UI -> User: Display updated view\nwithout deleted bill
        deactivate UI
    end
end

@enduml
