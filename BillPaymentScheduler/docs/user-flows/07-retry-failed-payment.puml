@startuml Retry Failed Payment Flow
title Retry Failed Payment Flow

actor User
participant "Payment Details" as Details
participant "Payment Method\nSelector" as MethodSelector
participant "Confirmation\nDialog" as Dialog
participant "Payment Service" as PaymentSvc
participant "API Gateway" as API
participant "Payment Controller" as PaymentCtrl
participant "Payment Execution\nService" as PaymentExec
participant "Payment Gateway" as Gateway
database "Payment Database" as DB

User -> Details: View failed payment details
activate Details

Details -> Details: Display failure reason\n(e.g., "Insufficient funds",\n"Payment method expired")

alt Payment method expired
    Details -> User: Show alert:\n"Payment method has expired.\nPlease update payment method before retrying."
    User -> Details: Click "Update Payment Method"
    Details -> MethodSelector: Show payment method selector
    activate MethodSelector
    MethodSelector -> User: Display available payment methods
    User -> MethodSelector: Select new payment method
    MethodSelector -> Details: Payment method selected
    deactivate MethodSelector
else Payment method valid
    Details -> User: "Retry Payment" button enabled
end

User -> Details: Click "Retry Payment" button

Details -> Dialog: Show confirmation dialog
activate Dialog

Dialog -> User: Display confirmation:\n"Retry payment?\nBill: Electric Company\nAmount: $150.00\nPayment Method: Visa ****1234\nOriginal failure: Insufficient funds"

alt User cancels
    Dialog -> Details: Close dialog
    deactivate Dialog
    Details -> User: Return to payment details
    deactivate Details
else User confirms retry
    Dialog -> PaymentSvc: retryPayment(paymentScheduleId)
    deactivate Dialog
    activate PaymentSvc

    PaymentSvc -> API: POST /api/payments/{id}/retry
    activate API

    API -> PaymentCtrl: Retry payment request
    activate PaymentCtrl

    PaymentCtrl -> PaymentCtrl: Extract userId from JWT token

    PaymentCtrl -> PaymentExec: RetryPaymentAsync(paymentScheduleId, userId)
    activate PaymentExec

    PaymentExec -> DB: SELECT * FROM PaymentSchedules\nWHERE PaymentScheduleId = ? AND UserId = ?
    activate DB
    DB -> PaymentExec: Return payment schedule
    deactivate DB

    alt Payment not found or not owned by user
        PaymentExec -> PaymentCtrl: NotFound or Unauthorized
        PaymentCtrl -> API: 404 Not Found or 403 Forbidden
        API -> PaymentSvc: Error response
        PaymentSvc -> Details: Display error
        activate Details
        Details -> User: Show error message
        deactivate Details
    else Payment status not 'Failed'
        PaymentExec -> PaymentCtrl: Bad request
        PaymentCtrl -> API: 400 Bad Request\n"Can only retry failed payments"
        API -> PaymentSvc: Error response
        PaymentSvc -> Details: Display error
        activate Details
        Details -> User: Show error message\n"This payment has not failed"
        deactivate Details
    else Payment is failed and can be retried
        PaymentExec -> PaymentExec: Update status to 'InProgress'
        PaymentExec -> DB: UPDATE PaymentSchedules\nSET Status = 'InProgress'
        activate DB
        DB -> PaymentExec: Status updated
        deactivate DB

        PaymentExec -> Details: Update UI to show processing
        activate Details
        Details -> Details: Show loading indicator
        Details -> User: "Processing payment..."
        deactivate Details

        PaymentExec -> PaymentExec: Validate payment method

        alt Payment method invalid or expired
            PaymentExec -> PaymentExec: Update status to 'Failed'
            PaymentExec -> DB: UPDATE PaymentSchedules\nSET Status = 'Failed',\nFailureReason = 'Payment method expired'
            activate DB
            DB -> PaymentExec: Update successful
            deactivate DB

            PaymentExec -> PaymentCtrl: Return failure result
            PaymentCtrl -> API: 400 Bad Request
            API -> PaymentSvc: Payment failed
            PaymentSvc -> Details: Display failure
            activate Details
            Details -> User: Show error:\n"Payment method is expired.\nPlease update and try again."
            deactivate Details
        else Payment method valid
            PaymentExec -> Gateway: ProcessPayment(paymentDetails)
            activate Gateway

            Gateway -> Gateway: Validate payment details
            Gateway -> Gateway: Process transaction

            alt Payment gateway fails
                Gateway -> PaymentExec: Payment failed\n(reason: e.g., "Insufficient funds")
                deactivate Gateway

                PaymentExec -> PaymentExec: Update payment schedule
                PaymentExec -> PaymentExec: Set status to 'Failed'
                PaymentExec -> PaymentExec: Increment retry count
                PaymentExec -> PaymentExec: Store failure reason

                PaymentExec -> DB: UPDATE PaymentSchedules\nSET Status = 'Failed',\nFailureReason = ?,\nRetryCount = RetryCount + 1,\nLastRetryAt = NOW()
                activate DB
                DB -> PaymentExec: Update successful
                deactivate DB

                PaymentExec -> PaymentCtrl: Return failure result
                PaymentCtrl -> API: 200 OK with failure status
                API -> PaymentSvc: Payment failed
                PaymentSvc -> Details: Display failure
                activate Details
                Details -> Details: Show error notification\n"Payment failed: Insufficient funds"
                Details -> Details: Update failure count
                Details -> User: Display updated failure info\nwith retry count
                deactivate Details

            else Payment gateway succeeds
                Gateway -> PaymentExec: Payment successful\n(transactionId, confirmationNumber)
                deactivate Gateway

                PaymentExec -> PaymentExec: Update payment schedule
                PaymentExec -> PaymentExec: Set status to 'Completed'
                PaymentExec -> PaymentExec: Store confirmation details
                PaymentExec -> PaymentExec: Set executedAt timestamp

                PaymentExec -> DB: UPDATE PaymentSchedules\nSET Status = 'Completed',\nExecutedAt = NOW(),\nTransactionId = ?,\nConfirmationNumber = ?,\nUpdatedAt = NOW()
                activate DB
                DB -> PaymentExec: Update successful
                deactivate DB

                PaymentExec -> PaymentCtrl: Return success result
                deactivate PaymentExec

                PaymentCtrl -> API: 200 OK with payment result
                deactivate PaymentCtrl

                API -> PaymentSvc: Payment successful
                deactivate API

                PaymentSvc -> Details: Success response
                deactivate PaymentSvc
                activate Details

                Details -> Details: Show success notification\n"Payment executed successfully"
                Details -> Details: Update status to 'Completed'
                Details -> Details: Display confirmation number

                Details -> User: Display success confirmation\nwith receipt option
                deactivate Details
            end
        end
    end
end

@enduml
