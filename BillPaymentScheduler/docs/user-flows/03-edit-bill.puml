@startuml Edit Bill Flow
title Edit Bill Flow

actor User
participant "Bill Details" as Details
participant "Edit Bill Form" as Form
participant "Bill Service" as BillSvc
participant "API Gateway" as API
participant "Bills Controller" as BillCtrl
participant "Bill Management\nService" as BillMgmt
database "Bill Database" as DB

User -> Details: Click "Edit" button
activate Details
Details -> BillSvc: getBill(billId)
activate BillSvc

BillSvc -> API: GET /api/bills/{billId}
activate API

API -> BillCtrl: Get bill request
activate BillCtrl

BillCtrl -> BillMgmt: GetBillByIdAsync(billId, userId)
activate BillMgmt

BillMgmt -> DB: SELECT * FROM Bills WHERE BillId = ?
activate DB
DB -> BillMgmt: Return bill data
deactivate DB

BillMgmt -> BillCtrl: Return Bill entity
deactivate BillMgmt

BillCtrl -> API: 200 OK with bill data
deactivate BillCtrl

API -> BillSvc: Bill data
deactivate API

BillSvc -> Details: Bill loaded
deactivate BillSvc

Details -> Form: Navigate to /bills/{billId}/edit
deactivate Details
activate Form

Form -> User: Display form pre-populated\nwith existing bill data

alt Bill has active autopay or scheduled payments
    Form -> User: Show warning banner\n"This bill has active autopay/scheduled payments"
end

User -> Form: Modify bill fields
Form -> Form: Real-time validation
Form -> Form: Show "unsaved changes" indicator

alt Validation Errors
    Form -> User: Display inline error messages
    User -> Form: Correct errors
else User Cancels
    Form -> User: Show confirmation dialog\n"Discard unsaved changes?"
    User -> Form: Confirm or Cancel
    alt User Confirms Discard
        Form -> Details: Navigate back to /bills/{billId}
        deactivate Form
    end
else User Clicks "Save"
    Form -> BillSvc: updateBill(billId, updates)
    activate BillSvc

    BillSvc -> API: PUT /api/bills/{billId}
    activate API
    note right of API
        Request Body:
        {
            "payee": "Electric Company",
            "amount": 175.00,
            "dueDate": "2024-01-20",
            "category": "Utilities",
            "recurrencePattern": "Monthly",
            "description": "Updated monthly electric bill",
            "isActive": true
        }
    end note

    API -> BillCtrl: Update bill request
    activate BillCtrl

    BillCtrl -> BillCtrl: Validate request data
    BillCtrl -> BillCtrl: Extract userId from JWT token

    BillCtrl -> BillMgmt: UpdateBillAsync(billId, userId, updates)
    activate BillMgmt

    BillMgmt -> DB: SELECT * FROM Bills WHERE BillId = ? AND UserId = ?
    activate DB
    DB -> BillMgmt: Return existing bill
    deactivate DB

    alt Bill not found or not owned by user
        BillMgmt -> BillCtrl: NotFound or Unauthorized
        BillCtrl -> API: 404 Not Found or 403 Forbidden
        API -> BillSvc: Error response
        BillSvc -> Form: Display error
        Form -> User: Show error message
    else Bill found and authorized
        BillMgmt -> BillMgmt: Update bill entity
        BillMgmt -> BillMgmt: Set audit fields\n(updatedBy, updatedAt)

        BillMgmt -> DB: UPDATE Bills SET ... WHERE BillId = ?
        activate DB
        DB -> BillMgmt: Update successful
        deactivate DB

        BillMgmt -> BillCtrl: Return updated Bill entity
        deactivate BillMgmt

        BillCtrl -> API: 200 OK with updated bill
        deactivate BillCtrl

        API -> BillSvc: Bill updated successfully
        deactivate API

        BillSvc -> Form: Success response
        deactivate BillSvc

        Form -> Form: Show success toast\n"Bill updated successfully"

        Form -> Details: Navigate to /bills/{billId}
        deactivate Form
        activate Details

        Details -> Details: Refresh bill data
        Details -> User: Display updated bill information
        deactivate Details
    end
end

@enduml
