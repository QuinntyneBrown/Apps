@startuml Reminders Sequence Diagram


title Send Reminder - Sequence Diagram

participant "Job: ReminderProcessor" as Job
participant "Handler: SendReminderCommandHandler" as Handler
participant "Repository: IReminderRepository" as Repo
participant "Aggregate: Reminder" as Reminder
participant "Service: INotificationService" as NotifService
participant "EventPublisher: IEventPublisher" as EventPub
database "Database" as DB

Job -> Repo: GetDueReminders()
activate Repo
Repo -> DB: SELECT FROM Reminders WHERE NextScheduledAt <= NOW()
DB --> Repo: Due reminders
Repo --> Job: List<Reminder>
deactivate Repo

loop For each due reminder
    Job -> Handler: Handle(SendReminderCommand)
    activate Handler

    Handler -> Repo: GetById(reminderId)
    activate Repo
    Repo -> DB: SELECT FROM Reminders
    DB --> Repo: Reminder data
    Repo --> Handler: Reminder
    deactivate Repo

    Handler -> Reminder: Send()
    activate Reminder
    Reminder --> Handler: Channels to send
    deactivate Reminder

    loop For each notification channel
        alt Channel is Email
            Handler -> NotifService: SendEmailAsync(to, subject, body)
            activate NotifService
            NotifService --> Handler: NotificationResult
            deactivate NotifService

        else Channel is SMS
            Handler -> NotifService: SendSMSAsync(phone, message)
            activate NotifService
            NotifService --> Handler: NotificationResult
            deactivate NotifService

        else Channel is Push
            Handler -> NotifService: SendPushNotificationAsync(userId, title, body)
            activate NotifService
            NotifService --> Handler: NotificationResult
            deactivate NotifService
        end

        Handler -> DB: INSERT INTO NotificationLogs
    end

    Handler -> Reminder: UpdateSchedule()
    activate Reminder
    Reminder -> Reminder: Calculate NextScheduledAt
    Reminder -> Reminder: RaisePaymentReminderSent()
    Reminder --> Handler: Updated
    deactivate Reminder

    Handler -> Repo: Update(reminder)
    activate Repo
    Repo -> DB: UPDATE Reminders
    DB --> Repo: Success
    deactivate Repo

    Handler -> EventPub: Publish(PaymentReminderSent)
    activate EventPub
    EventPub --> Handler: Done
    deactivate EventPub

    Handler --> Job: Success
    deactivate Handler
end

@enduml
