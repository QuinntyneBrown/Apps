@startuml Payments Class Diagram

!define ENTITY_COLOR #E8F5E9
!define VALUE_OBJECT_COLOR #FFF9C4
!define AGGREGATE_COLOR #E1F5FE
!define SERVICE_COLOR #FCE4EC
!define EVENT_COLOR #F3E5F5

' Aggregates and Entities
class Payment <<Aggregate Root>> AGGREGATE_COLOR {
    - PaymentId: Guid
    - BillId: Guid
    - UserId: Guid
    - Amount: decimal
    - ScheduledDate: DateTime
    - ExecutedDate: DateTime?
    - Status: PaymentStatus
    - PaymentMethod: PaymentMethodType
    - PaymentMethodId: Guid
    - TransactionId: string
    - ConfirmationNumber: string
    - Notes: string
    - FailureReason: string
    - RetryCount: int
    - MaxRetries: int
    - IsRecurring: bool
    - RecurringPaymentId: Guid?
    - CreatedAt: DateTime
    - UpdatedAt: DateTime
    --
    + Schedule()
    + Execute()
    + Cancel()
    + MarkAsCompleted()
    + MarkAsFailed()
    + Retry()
    + UpdatePaymentMethod()
    + UpdateScheduledDate()
}

class PaymentMethod <<Entity>> ENTITY_COLOR {
    - PaymentMethodId: Guid
    - UserId: Guid
    - Type: PaymentMethodType
    - DisplayName: string
    - LastFourDigits: string
    - ExpiryDate: DateTime?
    - BankName: string
    - IsDefault: bool
    - IsActive: bool
    - EncryptedDetails: string
    - CreatedAt: DateTime
    --
    + Activate()
    + Deactivate()
    + SetAsDefault()
    + UpdateDetails()
    + IsValid(): bool
    + IsExpired(): bool
}

' Value Objects
class PaymentStatus <<Value Object>> VALUE_OBJECT_COLOR {
    - Value: string
    --
    + Scheduled
    + InProgress
    + Completed
    + Cancelled
    + Failed
}

class PaymentMethodType <<Value Object>> VALUE_OBJECT_COLOR {
    - Value: string
    --
    + BankTransfer
    + CreditCard
    + DebitCard
    + PayPal
    + Other
}

class Money <<Value Object>> VALUE_OBJECT_COLOR {
    - Amount: decimal
    - Currency: string
    --
    + Add(Money): Money
    + Subtract(Money): Money
    + IsPositive(): bool
}

' Domain Events
class PaymentScheduled <<Domain Event>> EVENT_COLOR {
    + PaymentId: Guid
    + BillId: Guid
    + UserId: Guid
    + Amount: decimal
    + ScheduledDate: DateTime
    + PaymentMethod: string
    + IsRecurring: bool
    + OccurredAt: DateTime
}

class PaymentExecuted <<Domain Event>> EVENT_COLOR {
    + PaymentId: Guid
    + BillId: Guid
    + UserId: Guid
    + Amount: decimal
    + ExecutedDate: DateTime
    + TransactionId: string
    + ConfirmationNumber: string
    + PaymentMethod: string
    + OccurredAt: DateTime
}

class PaymentCancelled <<Domain Event>> EVENT_COLOR {
    + PaymentId: Guid
    + BillId: Guid
    + UserId: Guid
    + Amount: decimal
    + ScheduledDate: DateTime
    + CancellationReason: string
    + OccurredAt: DateTime
}

class PaymentFailed <<Domain Event>> EVENT_COLOR {
    + PaymentId: Guid
    + BillId: Guid
    + UserId: Guid
    + Amount: decimal
    + AttemptedDate: DateTime
    + FailureReason: string
    + RetryCount: int
    + WillRetry: bool
    + NextRetryDate: DateTime?
    + OccurredAt: DateTime
}

' Services
class PaymentService <<Domain Service>> SERVICE_COLOR {
    + SchedulePayment(command): PaymentId
    + ExecutePayment(paymentId): Result
    + CancelPayment(paymentId): Result
    + RetryFailedPayment(paymentId): Result
    + ValidatePaymentMethod(methodId): bool
}

class PaymentGatewayService <<Infrastructure Service>> SERVICE_COLOR {
    + ProcessPayment(payment): TransactionResult
    + ValidatePaymentMethod(method): bool
    + RefundPayment(transactionId): Result
    + GetTransactionStatus(transactionId): Status
}

class PaymentExecutorService <<Application Service>> SERVICE_COLOR {
    + ExecuteScheduledPayments(): void
    + ProcessRetries(): void
    + ReconcilePayments(): void
}

' Repositories
interface IPaymentRepository <<Repository>> {
    + GetById(id): Payment
    + GetByUserId(userId): List<Payment>
    + GetScheduledPayments(): List<Payment>
    + GetFailedPayments(): List<Payment>
    + Add(payment): void
    + Update(payment): void
    + Delete(id): void
}

interface IPaymentMethodRepository <<Repository>> {
    + GetById(id): PaymentMethod
    + GetByUserId(userId): List<PaymentMethod>
    + GetDefaultMethod(userId): PaymentMethod
    + Add(method): void
    + Update(method): void
    + Delete(id): void
}

' Commands
class SchedulePaymentCommand {
    + BillId: Guid
    + Amount: decimal
    + ScheduledDate: DateTime
    + PaymentMethodId: Guid
    + IsRecurring: bool
    + Notes: string
}

class ExecutePaymentCommand {
    + PaymentId: Guid
}

class CancelPaymentCommand {
    + PaymentId: Guid
    + Reason: string
}

class RetryFailedPaymentCommand {
    + PaymentId: Guid
}

' Command Handlers
class SchedulePaymentCommandHandler {
    + Handle(command): PaymentId
}

class ExecutePaymentCommandHandler {
    + Handle(command): Result
}

class CancelPaymentCommandHandler {
    + Handle(command): Result
}

' Queries
class GetPaymentByIdQuery {
    + PaymentId: Guid
}

class GetPaymentsByUserIdQuery {
    + UserId: Guid
    + Status: PaymentStatus?
    + DateFrom: DateTime?
    + DateTo: DateTime?
}

class GetUpcomingPaymentsQuery {
    + UserId: Guid
    + Days: int
}

' Query Handlers
class GetPaymentByIdQueryHandler {
    + Handle(query): PaymentDto
}

class GetPaymentsByUserIdQueryHandler {
    + Handle(query): List<PaymentDto>
}

' DTOs
class PaymentDto {
    + PaymentId: Guid
    + BillId: Guid
    + PayeeName: string
    + Amount: decimal
    + ScheduledDate: DateTime
    + ExecutedDate: DateTime?
    + Status: string
    + PaymentMethodDisplay: string
    + TransactionId: string
    + ConfirmationNumber: string
}

' Relationships
Payment --> PaymentStatus : has
Payment --> PaymentMethodType : uses
Payment --> Money : contains
Payment ..> PaymentScheduled : raises
Payment ..> PaymentExecuted : raises
Payment ..> PaymentCancelled : raises
Payment ..> PaymentFailed : raises

PaymentService --> IPaymentRepository : uses
PaymentService --> IPaymentMethodRepository : uses
PaymentService --> PaymentGatewayService : uses

PaymentExecutorService --> IPaymentRepository : uses
PaymentExecutorService --> PaymentGatewayService : uses

SchedulePaymentCommandHandler --> Payment : creates
SchedulePaymentCommandHandler --> PaymentService : uses
SchedulePaymentCommandHandler --> IPaymentRepository : uses

ExecutePaymentCommandHandler --> Payment : modifies
ExecutePaymentCommandHandler --> PaymentService : uses
ExecutePaymentCommandHandler --> IPaymentRepository : uses

CancelPaymentCommandHandler --> Payment : modifies
CancelPaymentCommandHandler --> IPaymentRepository : uses

GetPaymentByIdQueryHandler --> IPaymentRepository : queries
GetPaymentByIdQueryHandler --> PaymentDto : returns

GetPaymentsByUserIdQueryHandler --> IPaymentRepository : queries
GetPaymentsByUserIdQueryHandler --> PaymentDto : returns

Payment "1" --> "1" PaymentMethod : uses

note right of Payment
  Payment aggregate manages the entire
  lifecycle of a payment from scheduling
  to execution and handles retries
end note

note right of PaymentGatewayService
  Integrates with external payment
  processors (Stripe, PayPal, Plaid)
  for actual payment processing
end note

note bottom of PaymentExecutorService
  Background service that executes
  scheduled payments and handles
  retry logic
end note

@enduml
