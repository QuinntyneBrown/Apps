@startuml Payments Sequence Diagrams

title Payment Scheduling and Execution Flow

actor "User" as User
participant "UI" as UI
participant "API Controller" as API
participant "Command Handler" as Handler
participant "Payment Service" as Service
participant "Payment Aggregate" as Payment
participant "Payment Repository" as Repo
participant "Event Bus" as Events
participant "Payment Gateway" as Gateway
participant "Background Job" as Job
participant "Notification Service" as Notify

== Payment Scheduling Flow ==

User -> UI: Select bill to pay
activate UI

UI -> UI: Display payment form\n(pre-filled with bill details)
User -> UI: Enter payment details\n(amount, date, method)
UI -> UI: Validate form

User -> UI: Click "Schedule Payment"
UI -> API: POST /api/payments/schedule
activate API

API -> API: Authenticate user
API -> Handler: Handle(SchedulePaymentCommand)
activate Handler

Handler -> Service: ValidatePaymentMethod(methodId)
activate Service
Service -> Gateway: ValidatePaymentMethod
activate Gateway
Gateway --> Service: Valid
deactivate Gateway
Service --> Handler: Validation success
deactivate Service

Handler -> Payment: new Payment(billId, amount, date, method)
activate Payment
Payment -> Payment: Validate business rules
Payment --> Handler: Payment created
deactivate Payment

Handler -> Repo: Save(payment)
activate Repo
Repo -> Repo: Insert to database
Repo --> Handler: Saved
deactivate Repo

Payment -> Events: Raise PaymentScheduled event
activate Events
Events -> Events: Publish event
Events -> Notify: Handle PaymentScheduled
activate Notify
Notify -> User: Send confirmation email
deactivate Notify
deactivate Events

Handler --> API: PaymentId
deactivate Handler
API --> UI: 201 Created {paymentId}
deactivate API

UI -> UI: Show success message
UI -> UI: Redirect to payment details
UI --> User: Display confirmation
deactivate UI

== Automated Payment Execution Flow ==

Job -> Job: Wake up (every minute)
activate Job

Job -> Repo: GetScheduledPayments(now)
activate Repo
Repo -> Repo: Query payments due now
Repo --> Job: List<Payment>
deactivate Repo

loop For each scheduled payment
  Job -> Handler: Handle(ExecutePaymentCommand)
  activate Handler

  Handler -> Repo: GetById(paymentId)
  activate Repo
  Repo --> Handler: Payment
  deactivate Repo

  Handler -> Payment: Execute()
  activate Payment
  Payment -> Payment: Set status = InProgress
  Payment --> Handler: Ready to execute
  deactivate Payment

  Handler -> Repo: Update(payment)
  activate Repo
  Repo --> Handler: Updated
  deactivate Repo

  Handler -> Gateway: ProcessPayment(payment)
  activate Gateway

  alt Payment Successful
    Gateway --> Handler: {transactionId, confirmationNumber}
    deactivate Gateway

    Handler -> Payment: MarkAsCompleted(transactionId)
    activate Payment
    Payment -> Payment: Set status = Completed\nSet executedDate = now\nSet transactionId
    Payment -> Events: Raise PaymentExecuted event
    activate Events
    Events -> Notify: Handle PaymentExecuted
    activate Notify
    Notify -> User: Send success notification
    Notify -> User: Send payment receipt
    deactivate Notify
    deactivate Events
    Payment --> Handler: Success
    deactivate Payment

  else Payment Failed
    Gateway --> Handler: {error, reason}
    deactivate Gateway

    Handler -> Payment: MarkAsFailed(reason)
    activate Payment
    Payment -> Payment: Set status = Failed\nSet failureReason\nIncrement retryCount

    alt Retry available (retryCount < maxRetries)
      Payment -> Payment: Calculate next retry time\n(exponential backoff)
      Payment -> Events: Raise PaymentFailed event\n(willRetry = true)
      activate Events
      Events -> Notify: Handle PaymentFailed
      activate Notify
      Notify -> User: Send failure notification\nwith retry info
      deactivate Notify
      deactivate Events

    else Max retries exceeded
      Payment -> Events: Raise PaymentFailed event\n(willRetry = false)
      activate Events
      Events -> Notify: Handle PaymentFailed
      activate Notify
      Notify -> User: Send final failure notification\nrequesting action
      deactivate Notify
      deactivate Events
    end

    Payment --> Handler: Failed
    deactivate Payment
  end

  Handler -> Repo: Update(payment)
  activate Repo
  Repo --> Handler: Updated
  deactivate Repo

  Handler --> Job: Execution complete
  deactivate Handler
end

Job -> Job: Sleep until next run
deactivate Job

== Payment Cancellation Flow ==

User -> UI: View scheduled payment
activate UI
UI -> API: GET /api/payments/{id}
activate API
API -> Repo: GetById(id)
activate Repo
Repo --> API: PaymentDto
deactivate Repo
API --> UI: Payment details
deactivate API

User -> UI: Click "Cancel Payment"
UI -> UI: Show confirmation dialog
User -> UI: Confirm cancellation

UI -> API: POST /api/payments/{id}/cancel
activate API
API -> Handler: Handle(CancelPaymentCommand)
activate Handler

Handler -> Repo: GetById(id)
activate Repo
Repo --> Handler: Payment
deactivate Repo

Handler -> Payment: Cancel(reason)
activate Payment
Payment -> Payment: Validate status = Scheduled
Payment -> Payment: Set status = Cancelled
Payment -> Events: Raise PaymentCancelled event
activate Events
Events -> Notify: Handle PaymentCancelled
activate Notify
Notify -> User: Send cancellation confirmation
deactivate Notify
deactivate Events
Payment --> Handler: Cancelled
deactivate Payment

Handler -> Repo: Update(payment)
activate Repo
Repo --> Handler: Updated
deactivate Repo

Handler --> API: Success
deactivate Handler
API --> UI: 200 OK
deactivate API

UI -> UI: Show success message
UI -> UI: Update payment status
UI --> User: Display confirmation
deactivate UI

== Manual Retry Failed Payment Flow ==

User -> UI: View failed payment
activate UI
UI -> API: GET /api/payments/failed
activate API
API -> Repo: GetFailedPayments(userId)
activate Repo
Repo --> API: List<PaymentDto>
deactivate Repo
API --> UI: Failed payments
deactivate API

User -> UI: Click "Retry Payment"
UI -> API: POST /api/payments/{id}/retry
activate API
API -> Handler: Handle(RetryFailedPaymentCommand)
activate Handler

Handler -> Repo: GetById(id)
activate Repo
Repo --> Handler: Payment
deactivate Repo

Handler -> Payment: Retry()
activate Payment
Payment -> Payment: Validate status = Failed
Payment -> Payment: Validate retryCount < maxRetries
Payment -> Payment: Set status = Scheduled\nIncrement retryCount
Payment --> Handler: Ready for retry
deactivate Payment

Handler -> Repo: Update(payment)
activate Repo
Repo --> Handler: Updated
deactivate Repo

Handler -> Handler: Trigger immediate execution
Handler -> Gateway: ProcessPayment(payment)
activate Gateway

alt Retry Successful
  Gateway --> Handler: {transactionId, confirmationNumber}
  deactivate Gateway
  Handler -> Payment: MarkAsCompleted(transactionId)
  activate Payment
  Payment -> Events: Raise PaymentExecuted event
  activate Events
  Events -> Notify: Send success notification
  deactivate Events
  Payment --> Handler: Success
  deactivate Payment

else Retry Failed Again
  Gateway --> Handler: {error, reason}
  deactivate Gateway
  Handler -> Payment: MarkAsFailed(reason)
  activate Payment
  Payment -> Events: Raise PaymentFailed event
  activate Events
  Events -> Notify: Send failure notification
  deactivate Events
  Payment --> Handler: Failed
  deactivate Payment
end

Handler -> Repo: Update(payment)
activate Repo
Repo --> Handler: Updated
deactivate Repo

Handler --> API: Result
deactivate Handler
API --> UI: 200 OK {result}
deactivate API

UI -> UI: Show result message
UI --> User: Display outcome
deactivate UI

@enduml
