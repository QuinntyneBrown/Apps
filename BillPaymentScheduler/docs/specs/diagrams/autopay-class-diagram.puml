@startuml Autopay Class Diagram

!theme plain

class AutopayConfiguration <<Aggregate Root>> {
  - autopayConfigId: Guid
  - billId: Guid
  - userId: Guid
  - paymentMethodId: Guid
  - isEnabled: bool
  - maxAmount: decimal?
  - requireApproval: bool
  - approvalThresholdPercentage: decimal
  - lastExecutionDate: DateTime?
  - nextExecutionDate: DateTime?
  - executionDaysBefore: int
  - failureCount: int
  --
  + Enable(): void
  + Disable(): void
  + Execute(): void
  + IncrementFailureCount(): void
  + ResetFailureCount(): void
  + UpdateNextExecutionDate(): void
}

class EnableAutopayCommand {
  + BillId: Guid
  + TenantId: Guid
  + UserId: Guid
  + PaymentMethodId: Guid
  + MaxAmount: decimal?
  + RequireApproval: bool
  + ApprovalThresholdPercentage: decimal
  + ExecutionDaysBefore: int
}

class ExecuteAutopayCommand {
  + AutopayConfigId: Guid
  + TenantId: Guid
}

class ApproveAutopayCommand {
  + AutopayConfigId: Guid
  + TenantId: Guid
  + ApprovedAmount: decimal
}

class AutopayExecuted <<Domain Event>> {
  + AutopayConfigId: Guid
  + BillId: Guid
  + UserId: Guid
  + Amount: decimal
  + PaymentScheduleId: Guid
  + ExecutedAt: DateTime
  + OccurredAt: DateTime
}

interface IAutopayRepository {
  + Add(config: AutopayConfiguration): void
  + Update(config: AutopayConfiguration): void
  + GetById(id: Guid): AutopayConfiguration
  + GetByBillId(billId: Guid): AutopayConfiguration
  + GetDueExecutions(): List<AutopayConfiguration>
}

@enduml
