@startuml Payment Scheduling Class Diagram

!theme plain
skinparam linetype ortho
skinparam classAttributeIconSize 0

' Aggregates
class PaymentSchedule <<Aggregate Root>> {
  - paymentScheduleId: Guid
  - billId: Guid
  - userId: Guid
  - paymentMethodId: Guid
  - amount: decimal
  - scheduledDate: DateTime
  - isRecurring: bool
  - recurrencePattern: RecurrencePattern
  - status: PaymentStatus
  - confirmationNumber: string
  - notes: string
  - createdAt: DateTime
  - updatedAt: DateTime
  - executedAt: DateTime?
  - cancelledAt: DateTime?
  - failureReason: string
  --
  + Execute(): PaymentResult
  + Cancel(reason: string): void
  + Modify(updates): void
  + MarkAsCompleted(confirmationNumber): void
  + MarkAsFailed(reason: string): void
  - RaisePaymentScheduled(): void
  - RaisePaymentExecuted(): void
  - RaisePaymentCancelled(): void
  - RaisePaymentFailed(): void
}

' Entities
class PaymentMethod <<Entity>> {
  - paymentMethodId: Guid
  - userId: Guid
  - type: PaymentMethodType
  - displayName: string
  - lastFourDigits: string
  - expirationDate: DateTime?
  - isDefault: bool
  - isActive: bool
  --
  + IsExpired(): bool
  + Validate(): bool
  + SetAsDefault(): void
  + Deactivate(): void
}

' Enumerations
enum PaymentStatus {
  Scheduled
  InProgress
  Completed
  Failed
  Cancelled
}

enum PaymentMethodType {
  BankAccount
  CreditCard
  DebitCard
  PayPal
  Other
}

enum RecurrencePattern {
  None
  Weekly
  BiWeekly
  Monthly
  Quarterly
  Annually
}

' Value Objects
class PaymentResult <<Value Object>> {
  - success: bool
  - confirmationNumber: string
  - errorMessage: string
  - transactionId: string
}

class Money <<Value Object>> {
  - amount: decimal
  - currency: string
}

' Commands
class SchedulePaymentCommand {
  + BillId: Guid
  + TenantId: Guid
  + UserId: Guid
  + PaymentMethodId: Guid
  + Amount: decimal
  + ScheduledDate: DateTime
  + IsRecurring: bool
  + RecurrencePattern: RecurrencePattern
  + Notes: string
}

class ExecutePaymentCommand {
  + PaymentScheduleId: Guid
  + TenantId: Guid
}

class CancelPaymentCommand {
  + PaymentScheduleId: Guid
  + TenantId: Guid
  + Reason: string
}

class ModifyPaymentScheduleCommand {
  + PaymentScheduleId: Guid
  + TenantId: Guid
  + ScheduledDate: DateTime?
  + Amount: decimal?
  + PaymentMethodId: Guid?
  + Notes: string
}

class RetryFailedPaymentCommand {
  + PaymentScheduleId: Guid
  + TenantId: Guid
}

' Command Handlers
class SchedulePaymentCommandHandler {
  - paymentRepository: IPaymentScheduleRepository
  - billRepository: IBillRepository
  - paymentMethodRepository: IPaymentMethodRepository
  - eventPublisher: IEventPublisher
  --
  + Handle(command: SchedulePaymentCommand): Guid
}

class ExecutePaymentCommandHandler {
  - paymentRepository: IPaymentScheduleRepository
  - paymentGateway: IPaymentGateway
  - eventPublisher: IEventPublisher
  --
  + Handle(command: ExecutePaymentCommand): PaymentResult
}

class CancelPaymentCommandHandler {
  - paymentRepository: IPaymentScheduleRepository
  - eventPublisher: IEventPublisher
  --
  + Handle(command: CancelPaymentCommand): void
}

class ModifyPaymentScheduleCommandHandler {
  - paymentRepository: IPaymentScheduleRepository
  --
  + Handle(command: ModifyPaymentScheduleCommand): void
}

class RetryFailedPaymentCommandHandler {
  - paymentRepository: IPaymentScheduleRepository
  - paymentGateway: IPaymentGateway
  - eventPublisher: IEventPublisher
  --
  + Handle(command: RetryFailedPaymentCommand): PaymentResult
}

' Queries
class GetPaymentScheduleByIdQuery {
  + PaymentScheduleId: Guid
  + TenantId: Guid
}

class GetPaymentSchedulesByBillIdQuery {
  + BillId: Guid
  + TenantId: Guid
  + StatusFilter: PaymentStatus?
}

class GetUpcomingPaymentsQuery {
  + UserId: Guid
  + TenantId: Guid
  + Days: int
}

class GetPaymentHistoryQuery {
  + UserId: Guid
  + TenantId: Guid
  + StartDate: DateTime
  + EndDate: DateTime
  + Pagination: PaginationConfig
}

' Query Handlers
class GetPaymentScheduleByIdQueryHandler {
  - paymentRepository: IPaymentScheduleRepository
  --
  + Handle(query: GetPaymentScheduleByIdQuery): PaymentScheduleDto
}

class GetUpcomingPaymentsQueryHandler {
  - paymentRepository: IPaymentScheduleRepository
  --
  + Handle(query: GetUpcomingPaymentsQuery): List<PaymentScheduleDto>
}

class GetPaymentHistoryQueryHandler {
  - paymentRepository: IPaymentScheduleRepository
  --
  + Handle(query: GetPaymentHistoryQuery): PagedResult<PaymentScheduleDto>
}

' DTOs
class PaymentScheduleDto {
  + PaymentScheduleId: Guid
  + TenantId: Guid
  + BillId: Guid
  + BillName: string
  + Amount: decimal
  + ScheduledDate: DateTime
  + Status: string
  + ConfirmationNumber: string
  + PaymentMethodDisplayName: string
  + IsRecurring: bool
  + RecurrencePattern: string
}

' Domain Events
class PaymentScheduled <<Domain Event>> {
  + PaymentScheduleId: Guid
  + BillId: Guid
  + UserId: Guid
  + Amount: decimal
  + ScheduledDate: DateTime
  + IsRecurring: bool
  + OccurredAt: DateTime
}

class PaymentExecuted <<Domain Event>> {
  + PaymentScheduleId: Guid
  + BillId: Guid
  + UserId: Guid
  + Amount: decimal
  + ExecutedAt: DateTime
  + ConfirmationNumber: string
  + OccurredAt: DateTime
}

class PaymentCancelled <<Domain Event>> {
  + PaymentScheduleId: Guid
  + BillId: Guid
  + UserId: Guid
  + Amount: decimal
  + CancellationReason: string
  + OccurredAt: DateTime
}

class PaymentFailed <<Domain Event>> {
  + PaymentScheduleId: Guid
  + BillId: Guid
  + UserId: Guid
  + Amount: decimal
  + FailureReason: string
  + OccurredAt: DateTime
}

' Repository
interface IPaymentScheduleRepository {
  + Add(payment: PaymentSchedule): void
  + Update(payment: PaymentSchedule): void
  + GetById(id: Guid): PaymentSchedule
  + GetByBillId(billId: Guid, status): List<PaymentSchedule>
  + GetUpcoming(userId: Guid, days: int): List<PaymentSchedule>
  + GetHistory(userId: Guid, startDate, endDate): PagedResult<PaymentSchedule>
  + GetScheduledPaymentsDue(): List<PaymentSchedule>
}

' Payment Gateway
interface IPaymentGateway {
  + ProcessPaymentAsync(request: PaymentRequest): Task<PaymentResult>
  + CheckPaymentStatusAsync(confirmationNumber: string): Task<PaymentStatus>
  + ValidatePaymentMethodAsync(method: PaymentMethod): Task<bool>
  + RefundPaymentAsync(confirmationNumber: string, amount: decimal): Task<RefundResult>
}

' Event Publisher
interface IEventPublisher {
  + Publish<T>(event: T): Task
}

' Relationships
PaymentSchedule *-- Money
PaymentSchedule *-- PaymentStatus
PaymentSchedule *-- RecurrencePattern
PaymentSchedule --> PaymentResult
PaymentMethod *-- PaymentMethodType

SchedulePaymentCommandHandler --> SchedulePaymentCommand
SchedulePaymentCommandHandler --> IPaymentScheduleRepository
SchedulePaymentCommandHandler --> IEventPublisher
SchedulePaymentCommandHandler --> PaymentSchedule
SchedulePaymentCommandHandler ..> PaymentScheduled: publishes

ExecutePaymentCommandHandler --> ExecutePaymentCommand
ExecutePaymentCommandHandler --> IPaymentScheduleRepository
ExecutePaymentCommandHandler --> IPaymentGateway
ExecutePaymentCommandHandler --> IEventPublisher
ExecutePaymentCommandHandler ..> PaymentExecuted: publishes
ExecutePaymentCommandHandler ..> PaymentFailed: publishes

CancelPaymentCommandHandler --> CancelPaymentCommand
CancelPaymentCommandHandler --> IPaymentScheduleRepository
CancelPaymentCommandHandler --> IEventPublisher
CancelPaymentCommandHandler ..> PaymentCancelled: publishes

ModifyPaymentScheduleCommandHandler --> ModifyPaymentScheduleCommand
ModifyPaymentScheduleCommandHandler --> IPaymentScheduleRepository

RetryFailedPaymentCommandHandler --> RetryFailedPaymentCommand
RetryFailedPaymentCommandHandler --> IPaymentScheduleRepository
RetryFailedPaymentCommandHandler --> IPaymentGateway
RetryFailedPaymentCommandHandler --> IEventPublisher

GetPaymentScheduleByIdQueryHandler --> GetPaymentScheduleByIdQuery
GetPaymentScheduleByIdQueryHandler --> IPaymentScheduleRepository
GetPaymentScheduleByIdQueryHandler ..> PaymentScheduleDto: returns

GetUpcomingPaymentsQueryHandler --> GetUpcomingPaymentsQuery
GetUpcomingPaymentsQueryHandler --> IPaymentScheduleRepository
GetUpcomingPaymentsQueryHandler ..> PaymentScheduleDto: returns

GetPaymentHistoryQueryHandler --> GetPaymentHistoryQuery
GetPaymentHistoryQueryHandler --> IPaymentScheduleRepository
GetPaymentHistoryQueryHandler ..> PaymentScheduleDto: returns

note right of PaymentSchedule
  Aggregate root for payment scheduling.
  Enforces business rules and raises
  domain events for state transitions.
end note

note right of IPaymentGateway
  External payment gateway integration
  for processing actual payments
end note

@enduml
