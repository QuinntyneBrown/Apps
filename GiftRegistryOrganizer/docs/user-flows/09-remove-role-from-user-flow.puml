@startuml
skinparam backgroundColor #FEFEFE
skinparam handwritten false

actor "Admin" as Admin
participant "User Management\nPage (Angular)" as UI
participant "User Service\n(Angular)" as UserService
participant "HTTP Interceptor" as Interceptor
participant "API Gateway" as API
participant "Users Controller" as Controller
participant "Remove Role from User\nCommand Handler" as Handler
participant "User Repository" as UserRepo
database "Database" as DB

title Remove Role from User Flow

Admin -> UI: View user's\nrole list
activate UI

Admin -> UI: Click "Remove"\non a role

UI -> UI: Show confirmation\ndialog

Admin -> UI: Confirm removal

UI -> UserService: removeRoleFromUser(userId, roleId)
activate UserService

UserService -> Interceptor: DELETE /api/users/{userId}/roles/{roleId}
activate Interceptor

Interceptor -> Interceptor: Add Authorization\nheader with JWT token

Interceptor -> API: DELETE /api/users/{userId}/roles/{roleId}\nAuthorization: Bearer <token>
activate API
deactivate Interceptor

API -> API: Validate JWT token\nand Admin role

API -> Controller: RemoveRoleFromUser request
activate Controller

Controller -> Handler: Handle RemoveRoleFromUserCommand
activate Handler

Handler -> UserRepo: FindById(userId)
activate UserRepo

UserRepo -> DB: SELECT * FROM Users\nWHERE UserId = ?
activate DB
DB --> UserRepo: User record
deactivate DB

UserRepo --> Handler: User entity
deactivate UserRepo

alt User Not Found
    Handler --> Controller: Not found error
    Controller --> API: 404 Not Found\n{error: "User not found"}
    API --> UserService: Error response
    UserService --> UI: Operation failed
    UI --> Admin: Display error\nmessage
else User Found
    Handler -> UserRepo: RemoveRoleFromUser(userId, roleId)
    activate UserRepo

    UserRepo -> DB: DELETE FROM UserRoles\nWHERE UserId = ?\nAND RoleId = ?
    activate DB
    DB --> UserRepo: Rows affected
    deactivate DB

    alt Role Was Not Assigned
        note right: Idempotent operation:\nno error if role wasn't assigned
        UserRepo --> Handler: Success (0 rows affected)
        deactivate UserRepo

        Handler --> Controller: Success
        deactivate Handler

        Controller --> API: 204 No Content
        deactivate Controller

        API --> UserService: Success response
        deactivate API

        UserService --> UI: Role removal confirmed
        deactivate UserService

        UI --> Admin: Show info message:\n"Role was not assigned"
        deactivate UI
    else Role Removed Successfully
        UserRepo --> Handler: Success (1 row affected)
        deactivate UserRepo

        Handler --> Controller: Success
        deactivate Handler

        Controller --> API: 204 No Content
        deactivate Controller

        API --> UserService: Success response
        deactivate API

        UserService --> UI: Role removed
        deactivate UserService

        UI -> UI: Remove role from\nuser's role list

        UI --> Admin: Show success\nmessage
        deactivate UI
    end
end

@enduml
