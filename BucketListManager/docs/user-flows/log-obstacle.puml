@startuml log-obstacle
title Log Obstacle Flow

actor User
participant "Item Detail Panel" as DetailPanel
participant "Obstacle Log Component" as ObstacleUI
participant "Obstacle Service" as Service
participant "API Controller" as API
participant "LogObstacleCommand Handler" as Handler
participant "IBucketListManagerContext" as DB

User -> DetailPanel: View item details
DetailPanel --> User: Display obstacle count badge
DetailPanel --> User: Show obstacle list (if any)

User -> ObstacleUI: Click "Report Issue" button
ObstacleUI --> User: Display obstacle form

User -> ObstacleUI: Enter obstacle description
User -> ObstacleUI: Select severity level
note left: Severity: Low, Medium,\nHigh, Critical
User -> ObstacleUI: Optionally add notes/details
User -> ObstacleUI: Click "Submit"

ObstacleUI -> ObstacleUI: Validate description provided
ObstacleUI -> Service: logObstacle(itemId, obstacleData)
Service -> Service: Prepare request with auth token
Service -> API: POST /api/bucket-list-items/{id}/obstacles
note right: Authorization: Bearer {token}\nBody: { description, severity, notes }

API -> Handler: LogObstacleCommand
Handler -> DB: Query item by Id (filtered by TenantId)
DB --> Handler: BucketListItem entity

alt Item exists and belongs to user's tenant
    Handler -> Handler: Validate item ownership
    Handler -> Handler: Create Obstacle entity
    Handler -> Handler: Set ObstacleId, ItemId, TenantId
    Handler -> Handler: Set description, severity, notes
    Handler -> Handler: Set status to "Active"
    Handler -> Handler: Set log date
    Handler -> Handler: Increment item obstacle count
    Handler -> DB: Add(obstacle)
    Handler -> DB: Update(bucketListItem)
    Handler -> DB: SaveChangesAsync()
    DB --> Handler: Success
    Handler --> API: ObstacleLoggedResponse
    API --> Service: 201 Created + obstacle DTO
    Service --> ObstacleUI: Obstacle logged successfully
    ObstacleUI -> ObstacleUI: Close form
    ObstacleUI -> DetailPanel: Trigger refresh
    DetailPanel -> Service: getObstacles(itemId)
    Service -> API: GET /api/bucket-list-items/{id}/obstacles
    API -> DB: Query obstacles by ItemId (filtered by TenantId)
    DB --> API: List of obstacles
    API --> Service: Obstacles list
    Service --> DetailPanel: Updated obstacles
    DetailPanel --> User: Display obstacle in list with severity badge
    DetailPanel --> User: Update obstacle count badge
    DetailPanel --> User: Show success notification
else Item not found or unauthorized
    Handler --> API: 404 Not Found / 403 Forbidden
    API --> Service: Error response
    Service --> ObstacleUI: Logging failed
    ObstacleUI --> User: Display error message
end

@enduml
