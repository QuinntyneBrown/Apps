@startuml SleepQualityTracker_ClassDiagram

!define ENTITY_COLOR #E3F2FD
!define VALUE_OBJECT_COLOR #FFF3E0

package "Sleep Session Aggregate" <<Rectangle>> {
  class SleepSession <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - SleepStartTime: DateTime
    - WakeTime: DateTime
    - TotalDuration: TimeSpan
    - QualityRating: int
    - CreatedAt: DateTime
    - UpdatedAt: DateTime
    --
    + CalculateDuration(): TimeSpan
    + AddSleepStages(stages): void
    + AddInterruption(interruption): void
  }

  class SleepStages <<ValueObject>> VALUE_OBJECT_COLOR {
    - SessionId: Guid
    - LightSleepDuration: int
    - DeepSleepDuration: int
    - RemDuration: int
    - AwakeTime: int
    --
    + GetTotalSleepTime(): int
    + GetSleepEfficiency(): decimal
  }

  class SleepInterruption <<ValueObject>> VALUE_OBJECT_COLOR {
    - Id: Guid
    - SessionId: Guid
    - InterruptionTime: DateTime
    - Duration: int
    - Reason: string
  }

  SleepSession "1" *-- "0..1" SleepStages
  SleepSession "1" *-- "0..*" SleepInterruption
}

package "Sleep Goals Aggregate" <<Rectangle>> {
  class SleepGoal <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - TargetHours: decimal
    - TargetBedtime: TimeSpan
    - TargetWakeTime: TimeSpan
    - CreatedAt: DateTime
    --
    + CheckAchievement(session): bool
    + CalculateVariance(actualTime): TimeSpan
  }

  class GoalAchievement <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - SessionId: Guid
    - GoalHours: decimal
    - ActualHours: decimal
    - AchievementDate: DateTime
    - Status: AchievementStatus
    - Shortfall: decimal
  }

  class ConsistencyStreak <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - StreakType: StreakType
    - StreakLength: int
    - StartDate: DateTime
    - EndDate: DateTime
    - IsActive: bool
    --
    + Increment(): void
    + Reset(): void
  }

  SleepGoal "1" -- "0..*" GoalAchievement
  SleepGoal "1" -- "0..*" ConsistencyStreak
}

package "Sleep Quality Aggregate" <<Rectangle>> {
  class SleepQualityScore <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - SessionId: Guid
    - UserId: Guid
    - OverallScore: int
    - DurationScore: int
    - EfficiencyScore: int
    - StageScore: int
    - ConsistencyScore: int
    - ContributingFactors: List<string>
    - CalculatedAt: DateTime
    --
    + CalculateOverallScore(): int
    + DetermineSeverity(): QualitySeverity
  }

  class QualityTrend <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - Period: TrendPeriod
    - StartDate: DateTime
    - EndDate: DateTime
    - AverageQuality: decimal
    - TrendDirection: TrendDirection
    - ChangePercentage: decimal
    --
    + AnalyzeTrend(): TrendDirection
  }

  SleepSession "1" -- "1" SleepQualityScore
  SleepQualityScore "0..*" -- "0..*" QualityTrend
}

package "Sleep Debt Aggregate" <<Rectangle>> {
  class SleepDebt <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - TotalDebtHours: decimal
    - SeverityLevel: DebtSeverity
    - CalculatedAt: DateTime
    --
    + Accumulate(hours): void
    + Repay(hours): void
    + GetSeverity(): DebtSeverity
  }

  class DebtTransaction <<ValueObject>> VALUE_OBJECT_COLOR {
    - Id: Guid
    - UserId: Guid
    - TransactionType: TransactionType
    - Amount: decimal
    - Date: DateTime
  }

  SleepDebt "1" *-- "0..*" DebtTransaction
}

package "Habit Correlation Aggregate" <<Rectangle>> {
  class Habit <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - HabitType: HabitType
    - Timing: DateTime
    - Intensity: int
    - Quantity: decimal
    - LogDate: DateTime
  }

  class HabitCorrelation <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - HabitType: HabitType
    - CorrelationStrength: decimal
    - ImpactOnSleep: decimal
    - ConfidenceLevel: decimal
    - AnalyzedAt: DateTime
    --
    + CalculateCorrelation(habits, sessions): decimal
  }

  Habit "0..*" -- "0..*" HabitCorrelation
}

package "Environment Aggregate" <<Rectangle>> {
  class SleepEnvironment <<ValueObject>> VALUE_OBJECT_COLOR {
    - Id: Guid
    - SessionId: Guid
    - Temperature: decimal
    - NoiseLevel: int
    - LightLevel: int
    - Humidity: int
    - LoggedAt: DateTime
  }

  class OptimalEnvironment <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - OptimalTempRange: TemperatureRange
    - OptimalNoiseLevel: int
    - OptimalLightLevel: int
    - OptimalHumidity: int
    --
    + DetermineOptimalConditions(environments): void
  }

  SleepSession "1" -- "0..1" SleepEnvironment
  SleepEnvironment "0..*" -- "1" OptimalEnvironment
}

package "Pattern Detection Aggregate" <<Rectangle>> {
  class SleepPattern <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - PatternType: PatternType
    - Frequency: int
    - Characteristics: string
    - ConfidenceLevel: decimal
    - DetectedAt: DateTime
    --
    + DetectPattern(sessions): PatternType
  }
}

package "Recovery Aggregate" <<Rectangle>> {
  class RecoveryScore <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - SessionId: Guid
    - UserId: Guid
    - Score: int
    - HRV: decimal
    - RestingHR: int
    - ReadinessLevel: ReadinessLevel
    - CalculatedAt: DateTime
    --
    + CalculateRecovery(session, hrv, hr): int
    + DetermineReadiness(): ReadinessLevel
  }

  SleepSession "1" -- "1" RecoveryScore
}

package "Dream Journal Aggregate" <<Rectangle>> {
  class Dream <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - SessionId: Guid
    - UserId: Guid
    - Description: string
    - EmotionalTone: EmotionalTone
    - Vividness: int
    - IsNightmare: bool
    - Tags: List<string>
    - LoggedAt: DateTime
    --
    + AddTag(tag): void
    + RemoveTag(tag): void
  }

  SleepSession "1" -- "0..*" Dream
}

package "Nap Tracking Aggregate" <<Rectangle>> {
  class Nap <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - StartTime: DateTime
    - Duration: int
    - Quality: int
    - LoggedAt: DateTime
    --
    + Validate(): bool
  }
}

package "Reporting Aggregate" <<Rectangle>> {
  class WeeklySleepReport <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - WeekEndingDate: DateTime
    - AvgDuration: decimal
    - AvgQuality: decimal
    - PatternsIdentified: List<string>
    - Achievements: List<string>
    - Recommendations: List<string>
    --
    + Generate(sessions, week): void
  }

  class SleepInsight <<Entity>> ENTITY_COLOR {
    - Id: Guid
    - UserId: Guid
    - InsightType: InsightType
    - Recommendation: string
    - ExpectedBenefit: string
    - Priority: Priority
    - GeneratedAt: DateTime
    --
    + GenerateInsight(userData): void
  }
}

class User <<Entity>> ENTITY_COLOR {
  - Id: Guid
  - Email: string
  - Name: string
  - CreatedAt: DateTime
}

User "1" -- "0..*" SleepSession
User "1" -- "0..1" SleepGoal
User "1" -- "0..1" SleepDebt
User "1" -- "0..*" Habit
User "1" -- "0..1" OptimalEnvironment
User "1" -- "0..*" SleepPattern
User "1" -- "0..*" Dream
User "1" -- "0..*" Nap
User "1" -- "0..*" WeeklySleepReport

enum AchievementStatus {
  Met
  Missed
}

enum StreakType {
  SleepDuration
  Bedtime
  WakeTime
  Schedule
}

enum QualitySeverity {
  Poor
  Fair
  Good
  Excellent
}

enum TrendPeriod {
  Week
  Month
  Year
}

enum TrendDirection {
  Improving
  Declining
  Stable
}

enum DebtSeverity {
  None
  Mild
  Moderate
  Severe
  Critical
}

enum TransactionType {
  Accumulation
  Repayment
}

enum HabitType {
  Caffeine
  Exercise
  Alcohol
  ScreenTime
  Meals
  Stress
}

enum PatternType {
  Insomnia
  WeekdayWeekendDiscrepancy
  SeasonalVariation
  CustomPattern
}

enum ReadinessLevel {
  Low
  Moderate
  High
  Optimal
}

enum EmotionalTone {
  Positive
  Neutral
  Negative
  Mixed
}

enum InsightType {
  HabitChange
  EnvironmentOptimization
  ScheduleAdjustment
  GeneralRecommendation
}

enum Priority {
  Low
  Medium
  High
}

@enduml
