@startuml Streak Management - Class Diagram

!define AGGREGATE_COLOR #FFE5B4
!define VALUE_OBJECT_COLOR #D7FFB4
!define SERVICE_COLOR #FFB4D7

class Streak <<Aggregate Root>> AGGREGATE_COLOR {
  - Id: Guid
  - HabitId: Guid
  - UserId: Guid
  - CurrentStreak: int
  - LongestStreak: int
  - StartDate: DateTime
  - LastCompletionDate: DateTime?
  - Status: StreakStatus
  - FreezeTokens: int
  - TotalCompletions: int
  - BreakCount: int
  --
  + Create(habitId, userId): Streak
  + UpdateOnCompletion(completionDate, habitFrequency): void
  + UseFreeze(freezeDate, reason): void
  + Recover(): void
  + Break(): void
  - CheckForMilestone(oldStreak, newStreak): int?
  - CalculateConsecutiveDays(completions, frequency): int
}

enum StreakStatus VALUE_OBJECT_COLOR {
  Active
  Broken
  Frozen
  Recovered
}

class Milestone VALUE_OBJECT_COLOR {
  + Days: int
  + Name: string
  + Description: string
  + Icon: string
  --
  + IsAchieved(currentStreak): bool
}

class StreakStarted <<Event>> {
  + StreakId: Guid
  + HabitId: Guid
  + UserId: Guid
  + StartDate: DateTime
}

class StreakMilestoneReached <<Event>> {
  + StreakId: Guid
  + HabitId: Guid
  + UserId: Guid
  + MilestoneDays: int
  + MilestoneName: string
}

class StreakBroken <<Event>> {
  + StreakId: Guid
  + HabitId: Guid
  + StreakLength: int
  + BreakDate: DateTime
}

class StreakRecovered <<Event>> {
  + StreakId: Guid
  + HabitId: Guid
  + RecoveryDate: DateTime
}

class StreakCalculationService SERVICE_COLOR {
  - completionRepository: ICompletionRepository
  - habitRepository: IHabitRepository
  --
  + CalculateStreak(habitId, completions): int
  + CheckForBreak(habit, lastCompletion): bool
  - CalculateDailyStreak(completions): int
  - CalculateWeeklyStreak(habit, completions): int
}

class UpdateStreakCommandHandler SERVICE_COLOR {
  - streakRepository: IStreakRepository
  - calculationService: StreakCalculationService
  - eventPublisher: IEventPublisher
  --
  + Handle(command): Task
}

interface IStreakRepository {
  + GetByHabitIdAsync(habitId): Task<Streak?>
  + GetLeaderboardAsync(params): Task<List<LeaderboardEntry>>
  + AddAsync(streak): Task
  + UpdateAsync(streak): Task
}

Streak ..> StreakStatus
Streak ..> StreakStarted: publishes
Streak ..> StreakMilestoneReached: publishes
Streak ..> StreakBroken: publishes
Streak ..> StreakRecovered: publishes

StreakCalculationService --> IStreakRepository
UpdateStreakCommandHandler --> StreakCalculationService
UpdateStreakCommandHandler --> IStreakRepository
UpdateStreakCommandHandler ..> Streak: updates

@enduml
