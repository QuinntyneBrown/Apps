@startuml Streak Management - Sequence Diagram

title Update Streak on Completion

participant "CompletionService" as Completion
participant "UpdateStreakHandler" as Handler
participant "StreakRepository" as Repo
participant "StreakCalculationService" as CalcService
participant "Streak" as StreakAgg
participant "EventPublisher" as Events

Completion -> Handler: HabitCompletionLogged event
activate Handler

Handler -> Repo: GetByHabitIdAsync(habitId)
activate Repo
Repo --> Handler: Streak (or null)
deactivate Repo

alt First completion (no streak exists)
  Handler -> StreakAgg: Create(habitId, userId)
  activate StreakAgg
  StreakAgg -> StreakAgg: Set CurrentStreak = 1
  StreakAgg -> Events: Publish(StreakStarted)
  StreakAgg --> Handler: New streak
  deactivate StreakAgg
  Handler -> Repo: AddAsync(streak)
else Streak exists
  Handler -> CalcService: CalculateStreak(habitId, completions)
  activate CalcService
  CalcService -> CalcService: Get all completions
  CalcService -> CalcService: Check consecutive pattern
  CalcService --> Handler: New streak count
  deactivate CalcService

  Handler -> StreakAgg: UpdateOnCompletion(completionDate, frequency)
  activate StreakAgg
  StreakAgg -> StreakAgg: oldStreak = CurrentStreak
  StreakAgg -> StreakAgg: CurrentStreak = new count
  StreakAgg -> StreakAgg: Update LongestStreak if needed
  StreakAgg -> StreakAgg: CheckForMilestone(old, new)

  alt Milestone reached
    StreakAgg -> Events: Publish(StreakMilestoneReached)
  end

  StreakAgg --> Handler: Updated streak
  deactivate StreakAgg
  Handler -> Repo: UpdateAsync(streak)
end

Handler --> Completion: Success
deactivate Handler

@enduml
