@startuml Habit Management - Sequence Diagram

title Create Habit Flow

actor User
participant "UI" as UI
participant "API Gateway" as API
participant "CreateHabitHandler" as Handler
participant "UserService" as UserSvc
participant "HabitRepository" as Repo
participant "Habit Aggregate" as Habit
participant "EventPublisher" as Events
participant "ReminderService" as Reminder
participant "StreakService" as Streak

== Create Habit ==
User -> UI: Fill create habit form
activate UI
UI -> UI: Validate input
UI -> User: Show validation errors (if any)
User -> UI: Submit form
UI -> API: POST /api/habits\n(CreateHabitCommand)
activate API

API -> API: Authenticate user
API -> API: Validate JWT

API -> Handler: Handle(CreateHabitCommand)
activate Handler

Handler -> UserSvc: ValidateUserExists(userId)
activate UserSvc
UserSvc --> Handler: User exists
deactivate UserSvc

Handler -> Repo: ExistsAsync(userId, name)
activate Repo
Repo --> Handler: false (no duplicate)
deactivate Repo

Handler -> Habit: Create(userId, name, ...)
activate Habit
Habit -> Habit: ValidateName()
Habit -> Habit: ValidateStartDate()
Habit -> Habit: Apply business rules
Habit -> Habit: Raise HabitCreated event
Habit --> Handler: Habit aggregate
deactivate Habit

Handler -> Repo: AddAsync(habit)
activate Repo
Repo -> Repo: Save to database
Repo --> Handler: Success
deactivate Repo

Handler -> Events: Publish(HabitCreated)
activate Events
Events --> Handler: Event published
deactivate Events

Handler --> API: HabitId
deactivate Handler

API -> API: Query habit by ID
API --> UI: 201 Created\n(HabitDto)
deactivate API

UI -> UI: Update habit list
UI -> User: Show success message
deactivate UI

== Asynchronous Event Processing ==
Events -> Reminder: Handle(HabitCreated)
activate Reminder
alt ReminderEnabled == true
  Reminder -> Reminder: Schedule reminders
  Reminder --> Events: Reminders scheduled
else ReminderEnabled == false
  Reminder --> Events: No action
end
deactivate Reminder

Events -> Streak: Handle(HabitCreated)
activate Streak
Streak -> Streak: Initialize streak tracking
Streak -> Streak: Set streak to 0
Streak --> Events: Streak initialized
deactivate Streak

== Alternative: Validation Error ==
User -> UI: Submit invalid form
activate UI
UI -> API: POST /api/habits\n(invalid data)
activate API
API -> Handler: Handle(CreateHabitCommand)
activate Handler
Handler -> Habit: Create(userId, name, ...)
activate Habit
Habit -> Habit: ValidateName()
Habit --> Handler: ValidationException
deactivate Habit
Handler --> API: 400 Bad Request
deactivate Handler
API --> UI: Error response
deactivate API
UI -> User: Show error message
deactivate UI

== Alternative: Duplicate Name ==
User -> UI: Submit form with duplicate name
activate UI
UI -> API: POST /api/habits
activate API
API -> Handler: Handle(CreateHabitCommand)
activate Handler
Handler -> Repo: ExistsAsync(userId, name)
activate Repo
Repo --> Handler: true (duplicate found)
deactivate Repo
Handler --> API: 409 Conflict
deactivate Handler
API --> UI: Error: Duplicate name
deactivate API
UI -> User: Show duplicate error
deactivate UI

@enduml
