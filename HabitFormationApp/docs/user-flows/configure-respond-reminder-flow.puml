@startuml configure-respond-reminder-flow
title Configure and Respond to Reminder User Flow

actor User
participant "Habit Settings" as Settings
participant "Reminder Form" as Form
participant "ReminderService" as Service
participant "API Gateway" as API
participant "Reminder Controller" as Controller
participant "Reminder Repository" as ReminderRepo
database "Database" as DB
participant "Notification Service" as NotificationService
participant "Push Notification" as Push
participant "Completion Controller" as CompletionController

== Configure Reminder ==

User -> Settings: Navigate to habit settings
activate Settings
Settings --> User: Display habit settings page

User -> Settings: Click "Enable Reminders" toggle
Settings -> Form: Open reminder configuration form
activate Form
Form --> User: Display reminder settings form

User -> Form: Configure reminder:\n- Time: 7:00 AM\n- Days: Mon, Wed, Fri\n- Advance: 15 min\n- Channel: Push notification\n- Message: "Time for morning run!"

User -> Form: Click "Preview" button
Form -> Form: Show notification preview
Form --> User: Display how notification will look

User -> Form: Click "Save" button
Form -> Service: createReminderSchedule(habitId, settings)
activate Service
Service -> API: POST /api/reminders/schedules
activate API
API -> Controller: createSchedule(ScheduleDto)
activate Controller

Controller -> ReminderRepo: create(schedule)
activate ReminderRepo
ReminderRepo -> DB: INSERT INTO reminder_schedules\n(habitId, userId, time, days,\nadvanceMinutes, channels, message)
activate DB
DB --> ReminderRepo: Schedule created
deactivate DB
ReminderRepo --> Controller: Schedule entity
deactivate ReminderRepo

Controller -> Controller: Calculate next reminder time
Controller -> DB: Store calculated reminder times
activate DB
DB --> Controller: Success
deactivate DB

Controller --> API: 201 Created (Schedule)
deactivate Controller
API --> Service: Schedule created
deactivate API
Service --> Form: Success
deactivate Service

Form -> Form: Show success toast\n"Reminder configured!"
Form -> Settings: Close form and update settings
deactivate Form
Settings --> User: Display updated settings\nwith reminder enabled
deactivate Settings

== Send Reminder ==

note over DB, NotificationService
  System background job runs
  at scheduled time (7:00 AM Monday)
end note

NotificationService -> DB: SELECT reminders due now
activate NotificationService
activate DB
DB --> NotificationService: Reminder for habit:\n"Morning Run" at 7:00 AM
deactivate DB

NotificationService -> Push: Send push notification
activate Push
Push --> User: Display notification:\n"Time for morning run!\n[Complete Now] [Snooze] [Dismiss]"

== Respond to Reminder ==

alt User clicks "Complete Now"
    User -> Push: Tap "Complete Now"
    Push -> Service: completeFromReminder(habitId, reminderId)
    activate Service
    Service -> API: POST /api/completions/from-reminder
    activate API
    API -> CompletionController: logCompletion(dto)
    activate CompletionController

    CompletionController -> DB: INSERT INTO completions
    activate DB
    DB --> CompletionController: Completion created
    deactivate DB

    CompletionController -> ReminderRepo: markAsResponded(reminderId, action='completed')
    activate ReminderRepo
    ReminderRepo -> DB: UPDATE reminders\nSET responded = true,\nresponseAction = 'completed'
    activate DB
    DB --> ReminderRepo: Updated
    deactivate DB
    ReminderRepo --> CompletionController: Success
    deactivate ReminderRepo

    CompletionController --> API: 201 Created
    deactivate CompletionController
    API --> Service: Success
    deactivate API
    Service --> Push: Completion confirmed
    deactivate Service
    Push --> User: Show success message\n"Great! Habit completed ðŸŽ‰"
    deactivate Push

else User clicks "Snooze"
    User -> Push: Tap "Snooze 15min"
    Push -> Service: snoozeReminder(reminderId, minutes=15)
    activate Service
    Service -> API: POST /api/reminders/{id}/snooze
    activate API
    API -> Controller: snoozeReminder(id, minutes)
    activate Controller

    Controller -> ReminderRepo: createSnoozeReminder(reminderId, minutes)
    activate ReminderRepo
    ReminderRepo -> DB: INSERT INTO reminders\n(habitId, scheduledFor = NOW() + 15min,\ntype = 'snoozed')
    activate DB
    DB --> ReminderRepo: Snooze reminder created
    deactivate DB
    ReminderRepo --> Controller: Success
    deactivate ReminderRepo

    Controller --> API: 200 OK
    deactivate Controller
    API --> Service: Snoozed
    deactivate API
    Service --> Push: Snooze confirmed
    deactivate Service
    Push --> User: Show message\n"Reminder snoozed for 15 minutes"
    deactivate Push

    note over NotificationService
      After 15 minutes,
      send reminder again
    end note

else User clicks "Dismiss"
    User -> Push: Tap "Dismiss"
    Push -> Service: dismissReminder(reminderId)
    activate Service
    Service -> API: POST /api/reminders/{id}/dismiss
    activate API
    API -> Controller: dismissReminder(id)
    activate Controller

    Controller -> ReminderRepo: markAsDismissed(reminderId)
    activate ReminderRepo
    ReminderRepo -> DB: UPDATE reminders\nSET responded = true,\nresponseAction = 'dismissed'
    activate DB
    DB --> ReminderRepo: Updated
    deactivate DB
    ReminderRepo --> Controller: Success
    deactivate ReminderRepo

    Controller --> API: 200 OK
    deactivate Controller
    API --> Service: Dismissed
    deactivate API
    Service --> Push: Dismiss confirmed
    deactivate Service
    Push --> User: Notification dismissed
    deactivate Push
end

deactivate NotificationService

@enduml
