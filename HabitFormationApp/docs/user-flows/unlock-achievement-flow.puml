@startuml unlock-achievement-flow
title Unlock Achievement User Flow

actor User
participant "UI Component" as UI
participant "CompletionService" as CompletionService
participant "MotivationService" as MotivationService
participant "API Gateway" as API
participant "Completion Controller" as CompletionController
participant "Achievement Controller" as AchievementController
participant "Achievement Repository" as AchievementRepo
participant "Motivation Repository" as MotivationRepo
database "Database" as DB
participant "Achievement Celebration Modal" as Modal
participant "Notification Service" as NotificationService

User -> UI: Complete action\n(e.g., complete 10th habit)
activate UI
UI -> CompletionService: logCompletion(habitId)
activate CompletionService
CompletionService -> API: POST /api/completions
activate API
API -> CompletionController: logCompletion(dto)
activate CompletionController

CompletionController -> CompletionController: Save completion to database

CompletionController -> AchievementController: checkAchievements(userId, event)
activate AchievementController

AchievementController -> AchievementRepo: getUserAchievementProgress(userId)
activate AchievementRepo
AchievementRepo -> DB: SELECT * FROM user_achievements\nWHERE userId = ?
activate DB
DB --> AchievementRepo: Current achievements
deactivate DB
AchievementRepo --> AchievementController: User achievement status
deactivate AchievementRepo

AchievementController -> AchievementController: Evaluate criteria:\n- Check if total completions = 10\n- Achievement: "Perfect Ten"
alt Achievement criteria met
    AchievementController -> AchievementRepo: unlockAchievement(userId, achievementType)
    activate AchievementRepo
    AchievementRepo -> DB: INSERT INTO user_achievements\n(userId, achievementType,\nunlockedAt, points)
    activate DB
    DB --> AchievementRepo: Achievement record created
    deactivate DB
    AchievementRepo --> AchievementController: Achievement unlocked
    deactivate AchievementRepo

    AchievementController -> MotivationRepo: updateMotivationScore(userId, points)
    activate MotivationRepo
    MotivationRepo -> DB: UPDATE user_motivation\nSET score = score + 50,\ntotalPoints = totalPoints + 50
    activate DB
    DB --> MotivationRepo: Score updated
    deactivate DB
    MotivationRepo --> AchievementController: Motivation updated
    deactivate MotivationRepo

    AchievementController --> CompletionController: Achievement unlocked data
    deactivate AchievementController

    CompletionController --> API: 201 Created\n(Completion + Achievement)
    deactivate CompletionController
    API --> CompletionService: Success with achievement
    deactivate API
    CompletionService --> UI: Completion logged with\nachievement unlock
    deactivate CompletionService

    UI -> Modal: Show achievement celebration
    activate Modal
    Modal -> Modal: Display confetti animation
    Modal -> Modal: Show badge with shine effect
    Modal -> Modal: Play "Awesome!" sound effect
    Modal --> User: Display celebration modal\n"ðŸŽ‰ Achievement Unlocked!\nPerfect Ten\nCompleted 10 habits!\n+50 points"

    UI -> MotivationService: fetchAchievementDetails(achievementType)
    activate MotivationService
    MotivationService -> API: GET /api/achievements/{type}
    activate API
    API -> AchievementController: getAchievementDetails(type)
    activate AchievementController
    AchievementController -> AchievementRepo: findByType(type)
    activate AchievementRepo
    AchievementRepo -> DB: SELECT * FROM achievements\nWHERE type = ?
    activate DB
    DB --> AchievementRepo: Achievement details
    deactivate DB
    AchievementRepo --> AchievementController: Achievement entity
    deactivate AchievementRepo
    AchievementController --> API: 200 OK (Achievement)
    deactivate AchievementController
    API --> MotivationService: Achievement data
    deactivate API
    MotivationService --> Modal: Display details\n(description, badge icon, points)
    deactivate MotivationService

    Modal --> User: Show next achievement hint\n"Next: Complete 25 habits\nfor 'Quarter Century'"

    User -> Modal: Click "Share" or "Dismiss"
    alt User clicks Share
        Modal -> NotificationService: Share achievement\nto social media
        activate NotificationService
        NotificationService --> User: Open share dialog
        deactivate NotificationService
    else User clicks Dismiss
        Modal -> Modal: Close celebration modal
    end
    deactivate Modal

    UI -> UI: Update achievements gallery
    UI -> UI: Update motivation score display
    UI --> User: Show updated UI with\nnew badge and score
else Achievement criteria not met
    AchievementController --> CompletionController: No achievement unlocked
    deactivate AchievementController
    CompletionController --> API: 201 Created (Completion)
    deactivate CompletionController
    API --> CompletionService: Success
    deactivate API
    CompletionService --> UI: Completion logged
    deactivate CompletionService
    UI --> User: Show normal completion feedback
end

deactivate UI

@enduml
