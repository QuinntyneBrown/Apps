@startuml streak-milestone-celebration-flow
title Track and Celebrate Streak Milestone User Flow

actor User
participant "Habit Card" as Card
participant "CompletionService" as CompletionService
participant "StreakService" as StreakService
participant "API Gateway" as API
participant "Completion Controller" as CompletionController
participant "Streak Controller" as StreakController
participant "Streak Repository" as StreakRepo
participant "Milestone Repository" as MilestoneRepo
database "Database" as DB
participant "Celebration Modal" as Modal
participant "Notification Service" as NotificationService

User -> Card: Complete habit
activate Card
Card -> CompletionService: logCompletion(habitId)
activate CompletionService
CompletionService -> API: POST /api/completions
activate API
API -> CompletionController: logCompletion(dto)
activate CompletionController

CompletionController -> StreakRepo: updateStreak(habitId)
activate StreakRepo
StreakRepo -> DB: UPDATE streaks\nSET currentStreak = currentStreak + 1
activate DB
DB --> StreakRepo: Streak updated
deactivate DB
StreakRepo -> DB: SELECT currentStreak, longestStreak
activate DB
DB --> StreakRepo: currentStreak = 7, longestStreak = 7
deactivate DB
StreakRepo --> CompletionController: Streak data
deactivate StreakRepo

CompletionController -> CompletionController: Check if milestone reached\n(7, 14, 30, 50, 100, 365 days)
alt Milestone Reached (currentStreak == 7)
    CompletionController -> MilestoneRepo: createMilestoneAchievement(habitId, milestoneType)
    activate MilestoneRepo
    MilestoneRepo -> DB: INSERT INTO milestone_achievements\n(habitId, userId, milestoneType,\nachievedAt, streakCount)
    activate DB
    DB --> MilestoneRepo: Milestone record created
    deactivate DB
    MilestoneRepo --> CompletionController: Milestone achievement
    deactivate MilestoneRepo

    CompletionController --> API: 201 Created\n(Completion + Streak + Milestone)
    deactivate CompletionController
    API --> CompletionService: Success with milestone flag
    deactivate API
    CompletionService --> Card: Completion logged with milestone
    deactivate CompletionService

    Card -> Modal: Show milestone celebration
    activate Modal
    Modal -> Modal: Display confetti animation
    Modal -> Modal: Show badge icon and shine effect
    Modal --> User: Display celebration modal\n"ðŸŽ‰ Milestone Reached!\nOne Week Wonder!\n7-day streak achieved!"

    Card -> StreakService: fetchMilestoneDetails(habitId, milestoneType)
    activate StreakService
    StreakService -> API: GET /api/streaks/{habitId}/milestones/{type}
    activate API
    API -> StreakController: getMilestoneDetails(habitId, type)
    activate StreakController
    StreakController -> MilestoneRepo: findByHabitAndType(habitId, type)
    activate MilestoneRepo
    MilestoneRepo -> DB: SELECT * FROM milestone_achievements
    activate DB
    DB --> MilestoneRepo: Milestone details
    deactivate DB
    MilestoneRepo --> StreakController: Milestone entity
    deactivate MilestoneRepo
    StreakController --> API: 200 OK (Milestone details)
    deactivate StreakController
    API --> StreakService: Milestone data
    deactivate API
    StreakService --> Modal: Display milestone details\n(name, description, badge, points earned)
    deactivate StreakService

    Modal --> User: Show next milestone preview\n"Next: Two Week Warrior (14 days)"

    User -> Modal: Click "Share" or "Dismiss"
    alt User clicks Share
        Modal -> NotificationService: Share milestone to social media
        activate NotificationService
        NotificationService --> User: Open share dialog
        deactivate NotificationService
    else User clicks Dismiss
        Modal -> Modal: Close celebration modal
    end
    deactivate Modal

    Card -> Card: Update streak display\nwith milestone badge
    Card --> User: Show updated streak with badge
else No Milestone
    CompletionController --> API: 201 Created (Completion + Streak)
    deactivate CompletionController
    API --> CompletionService: Success
    deactivate API
    CompletionService --> Card: Completion logged
    deactivate CompletionService
    Card --> User: Show normal completion feedback
end

deactivate Card

@enduml
