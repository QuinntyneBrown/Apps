@startuml quick-complete-habit-flow
title Quick Complete Habit User Flow

actor User
participant "Habit Card" as Card
participant "CompletionService" as Service
participant "API Gateway" as API
participant "Completion Controller" as Controller
participant "Completion Repository" as CompletionRepo
participant "Streak Repository" as StreakRepo
database "Database" as DB
participant "Toast Notification" as Toast

User -> Card: Click quick complete button
activate Card
Card -> Card: Optimistic update\n(Change button state to completed)
Card --> User: Show green checkmark animation

Card -> Service: logCompletion(habitId, completionData)
activate Service
Service -> API: POST /api/completions
activate API
API -> Controller: logCompletion(LogCompletionDto)
activate Controller

Controller -> CompletionRepo: create(completion)
activate CompletionRepo
CompletionRepo -> DB: INSERT INTO completions\n(habitId, userId, completedAt,\nscheduledFor, isLate)
activate DB
DB --> CompletionRepo: Completion record created
deactivate DB
CompletionRepo --> Controller: Completion entity
deactivate CompletionRepo

Controller -> StreakRepo: updateStreak(habitId)
activate StreakRepo
StreakRepo -> DB: UPDATE streaks\nSET currentStreak = currentStreak + 1,\nlastCompletionDate = NOW()
activate DB
DB --> StreakRepo: Streak updated
deactivate DB
StreakRepo -> DB: SELECT currentStreak, longestStreak
activate DB
DB --> StreakRepo: Streak data
deactivate DB
StreakRepo --> Controller: Updated streak info
deactivate StreakRepo

Controller --> API: 201 Created (Completion + Streak)
deactivate Controller
API --> Service: Completion response with streak
deactivate API
Service --> Card: Success with streak data
deactivate Service

Card -> Toast: Show success toast\n"Habit completed! ğŸ‰\n3-day streak! [Undo]"
activate Toast
Toast --> User: Display toast notification\n(auto-dismiss after 5 seconds)

alt User clicks Undo within 5 seconds
    User -> Toast: Click [Undo] button
    Toast -> Service: undoCompletion(completionId)
    activate Service
    Service -> API: DELETE /api/completions/{completionId}
    activate API
    API -> Controller: undoCompletion(completionId)
    activate Controller

    Controller -> CompletionRepo: delete(completionId)
    activate CompletionRepo
    CompletionRepo -> DB: DELETE FROM completions\nWHERE id = ?
    activate DB
    DB --> CompletionRepo: Record deleted
    deactivate DB
    CompletionRepo --> Controller: Success
    deactivate CompletionRepo

    Controller -> StreakRepo: recalculateStreak(habitId)
    activate StreakRepo
    StreakRepo -> DB: Calculate streak from completions
    activate DB
    DB --> StreakRepo: Recalculated streak
    deactivate DB
    StreakRepo -> DB: UPDATE streaks
    activate DB
    DB --> StreakRepo: Streak updated
    deactivate DB
    StreakRepo --> Controller: Updated streak
    deactivate StreakRepo

    Controller --> API: 200 OK
    deactivate Controller
    API --> Service: Success
    deactivate API
    Service --> Toast: Completion undone
    deactivate Service

    Toast -> Card: Revert button state
    Card --> User: Button returns to incomplete state
    Toast -> Toast: Show "Completion undone" toast
    Toast --> User: Display undo confirmation
    deactivate Toast
else Auto-dismiss after 5 seconds
    Toast -> Toast: Auto-dismiss timer expires
    deactivate Toast
end

deactivate Card

@enduml
