@startuml add-accountability-partner-flow
title Add Accountability Partner User Flow

actor "User A" as UserA
participant "Partners Dashboard" as Dashboard
participant "Add Partner Form" as Form
participant "PartnershipService" as Service
participant "API Gateway" as API
participant "Partnership Controller" as Controller
participant "User Repository" as UserRepo
participant "Partnership Repository" as PartnershipRepo
database "Database" as DB
participant "Notification Service" as NotificationService
actor "User B (Partner)" as UserB

UserA -> Dashboard: Navigate to Accountability page
activate Dashboard
Dashboard -> Service: fetchPartnerships(userId)
activate Service
Service -> API: GET /api/partnerships?userId={userId}
activate API
API -> Controller: getPartnerships(userId)
activate Controller
Controller -> PartnershipRepo: findByUserId(userId)
activate PartnershipRepo
PartnershipRepo -> DB: SELECT * FROM partnerships\nWHERE userId = ?
activate DB
DB --> PartnershipRepo: Partnership records
deactivate DB
PartnershipRepo --> Controller: List<Partnership>
deactivate PartnershipRepo
Controller --> API: 200 OK (Partnerships)
deactivate Controller
API --> Service: Partnership list
deactivate API
Service --> Dashboard: Display active partners
deactivate Service
Dashboard --> UserA: Show partners dashboard

UserA -> Dashboard: Click "Add Partner" button
Dashboard -> Form: Open add partner form
activate Form
Form --> UserA: Display search interface

UserA -> Form: Enter search query\n(email or username)
Form -> Service: searchUsers(query)
activate Service
Service -> API: GET /api/users/search?q={query}
activate API
API -> Controller: searchUsers(query)
activate Controller
Controller -> UserRepo: searchByEmailOrUsername(query)
activate UserRepo
UserRepo -> DB: SELECT id, username, email\nFROM users\nWHERE email LIKE ? OR username LIKE ?
activate DB
DB --> UserRepo: Matching users
deactivate DB
UserRepo --> Controller: List<UserSearchResult>
deactivate UserRepo
Controller --> API: 200 OK (Search results)
deactivate Controller
API --> Service: User results
deactivate API
Service --> Form: Display search results
deactivate Service
Form --> UserA: Show list of users

UserA -> Form: Select user (User B)
Form -> Form: Load habit selection interface
Form --> UserA: Display habit checkboxes\nand permission settings

UserA -> Form: Select habits to share\nSet permission level (View only)
UserA -> Form: Enter invitation message\n"Let's support each other!"
UserA -> Form: Click "Send Invitation" button

Form -> Service: sendPartnershipInvitation(data)
activate Service
Service -> API: POST /api/partnerships/invitations
activate API
API -> Controller: createInvitation(InvitationDto)
activate Controller

Controller -> PartnershipRepo: createInvitation(invitation)
activate PartnershipRepo
PartnershipRepo -> DB: INSERT INTO partnership_invitations\n(fromUserId, toUserId, message,\nsharedHabits, permissions, status)
activate DB
DB --> PartnershipRepo: Invitation created
deactivate DB
PartnershipRepo --> Controller: Invitation entity
deactivate PartnershipRepo

Controller -> NotificationService: sendInvitationNotification(toUserId, invitation)
activate NotificationService
NotificationService -> DB: INSERT INTO notifications
activate DB
DB --> NotificationService: Notification created
deactivate DB
NotificationService -> NotificationService: Send push notification\nand email to User B
NotificationService --> UserB: "User A invited you\nto be accountability partners!"
deactivate NotificationService

Controller --> API: 201 Created (Invitation)
deactivate Controller
API --> Service: Invitation sent
deactivate API
Service --> Form: Success
deactivate Service

Form -> Form: Show success toast\n"Invitation sent to User B!"
Form -> Dashboard: Close form and update dashboard
deactivate Form

Dashboard -> Service: fetchPendingInvitations(userId)
activate Service
Service -> API: GET /api/partnerships/invitations/sent
activate API
API --> Service: Pending invitations list
deactivate API
Service --> Dashboard: Update pending invitations
deactivate Service
Dashboard --> UserA: Show invitation in\n"Pending Invitations" section

note over UserB
  User B receives notification
  and can accept or decline
  in their dashboard
end note

deactivate Dashboard

@enduml
