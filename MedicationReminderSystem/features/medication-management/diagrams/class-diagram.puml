@startuml Medication Management Class Diagram

' Styling
skinparam class {
    BackgroundColor LightBlue
    BorderColor DarkBlue
    ArrowColor DarkBlue
}

' Aggregates and Entities
class Medication <<Aggregate Root>> {
    - MedicationId: Guid
    - UserId: Guid
    - MedicationName: string
    - GenericName: string
    - Dosage: string
    - Form: MedicationForm
    - Prescriber: string
    - PrescriptionNumber: string
    - StartDate: DateTime
    - EndDate: DateTime?
    - IsActive: bool
    - IsPaused: bool
    - PauseReason: string
    - PauseStartDate: DateTime?
    - ExpectedResumeDate: DateTime?
    - DiscontinuedDate: DateTime?
    - DiscontinuationReason: string
    - Purpose: string
    - Instructions: string
    - WithFood: bool
    - Category: MedicationCategory
    - CreatedAt: DateTime
    - UpdatedAt: DateTime
    --
    + AddMedication()
    + UpdateDetails()
    + SetSchedule()
    + Pause()
    + Resume()
    + Discontinue()
}

class MedicationSchedule <<Entity>> {
    - ScheduleId: Guid
    - MedicationId: Guid
    - Frequency: ScheduleFrequency
    - TimesOfDay: List<TimeSpan>
    - DaysOfWeek: List<DayOfWeek>
    - WithFoodRequirement: bool
    - MaxDosesPerDay: int?
    - MinimumInterval: decimal?
    --
    + UpdateSchedule()
    + GetNextDoseTime()
    + ValidateSchedule()
}

enum MedicationForm {
    Tablet
    Capsule
    Liquid
    Injection
    Topical
    Inhaler
    Patch
    Drops
    Other
}

enum MedicationCategory {
    Prescription
    OTC
    Supplement
    Vitamin
}

enum ScheduleFrequency {
    AsNeeded
    Daily
    EveryXDays
    Weekly
    Monthly
    Custom
}

' Commands
class AddMedicationCommand <<Command>> {
    + MedicationName: string
    + Dosage: string
    + Form: MedicationForm
    + StartDate: DateTime
    + Category: MedicationCategory
    --
    + Validate()
}

class SetMedicationScheduleCommand <<Command>> {
    + MedicationId: Guid
    + Frequency: ScheduleFrequency
    + TimesOfDay: List<TimeSpan>
    + WithFoodRequirement: bool
    --
    + Validate()
}

class PauseMedicationCommand <<Command>> {
    + MedicationId: Guid
    + PauseReason: string
    + ExpectedResumeDate: DateTime?
    --
    + Validate()
}

class DiscontinueMedicationCommand <<Command>> {
    + MedicationId: Guid
    + DiscontinuationReason: string
    + DiscontinuationDate: DateTime
    --
    + Validate()
}

' Domain Events
class MedicationAdded <<Domain Event>> {
    + MedicationId: Guid
    + UserId: Guid
    + MedicationName: string
    + Dosage: string
    + StartDate: DateTime
    + OccurredAt: DateTime
}

class MedicationScheduleSet <<Domain Event>> {
    + ScheduleId: Guid
    + MedicationId: Guid
    + Frequency: ScheduleFrequency
    + TimesOfDay: List<TimeSpan>
    + OccurredAt: DateTime
}

class MedicationPaused <<Domain Event>> {
    + MedicationId: Guid
    + PauseStartDate: DateTime
    + PauseReason: string
    + OccurredAt: DateTime
}

class MedicationDiscontinued <<Domain Event>> {
    + MedicationId: Guid
    + DiscontinuationDate: DateTime
    + DiscontinuationReason: string
    + OccurredAt: DateTime
}

class DrugInteractionDetected <<Domain Event>> {
    + MedicationIds: List<Guid>
    + InteractionType: string
    + Severity: string
    + ClinicalSignificance: string
    + OccurredAt: DateTime
}

' Services
class MedicationService <<Service>> {
    --
    + CreateMedication()
    + UpdateMedication()
    + PauseMedication()
    + ResumeMedication()
    + DiscontinueMedication()
    + CheckDrugInteractions()
}

class DrugInteractionChecker <<Service>> {
    --
    + CheckInteractions(medications)
    + GetInteractionDetails()
    + GetSeverityLevel()
}

' Repositories
interface IMedicationRepository <<Repository>> {
    + GetById(id): Medication
    + GetByUserId(userId): List<Medication>
    + Save(medication): void
    + Delete(id): void
    + GetActiveMedications(userId): List<Medication>
}

' Relationships
Medication "1" *-- "0..1" MedicationSchedule : has
Medication ..> MedicationForm : uses
Medication ..> MedicationCategory : uses
MedicationSchedule ..> ScheduleFrequency : uses

AddMedicationCommand ..> Medication : creates
SetMedicationScheduleCommand ..> MedicationSchedule : creates
PauseMedicationCommand ..> Medication : modifies
DiscontinueMedicationCommand ..> Medication : modifies

Medication ..> MedicationAdded : raises
Medication ..> MedicationScheduleSet : raises
Medication ..> MedicationPaused : raises
Medication ..> MedicationDiscontinued : raises

MedicationService ..> IMedicationRepository : uses
MedicationService ..> DrugInteractionChecker : uses
DrugInteractionChecker ..> DrugInteractionDetected : raises

@enduml
